<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focused Subject Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Expose a simple wrapper to create icons using the global 'lucide' object
        window.createLucideIcons = () => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        };
    </script>
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>"></link>
    
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        
        /* Custom styles for Glassmorphism base */
        .glass-base {
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Base shadow */
        }
        
        .glass-base:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* Lifted shadow on hover */
        }

        /* Styling for the subject radio buttons */
        .subject-radio:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #a5b4fc; /* indigo-300 */
            color: #fff;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); /* Blue glow */
        }
        
        /* Custom checkbox style */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            border: 2px solid #6b7280; /* gray-500 */
            border-radius: 0.25rem;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="checkbox"]:checked {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            display: block;
            color: white;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.1;
        }
        
        /* Custom media query for fullscreen display font size on smaller screens */
        @media (max-width: 768px) {
            #fullscreen-time-display {
                font-size: 8rem;
            }
        }
        @media (max-width: 480px) {
            #fullscreen-time-display {
                font-size: 6rem;
            }
        }

    </style>
  
</head>
<body class="text-white min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-400">Study Tracker</h1>
        </header>

       
            
            <nav class="flex space-x-2 mb-6 p-1 bg-gray-800 rounded-full overflow-x-auto">
                <button id="nav-timer-btn" onclick="switchPage('timer')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-indigo-600">
                    <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i> Timer
                </button>
                <button id="nav-tasks-btn" onclick="switchPage('tasks')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="list-todo" class="w-4 h-4 inline mr-1"></i> Tasks
                </button>
                <button id="nav-history-btn" onclick="switchPage('history')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> History
                </button>
                <button id="nav-achievements-btn" onclick="switchPage('achievements')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="medal" class="w-4 h-4 inline mr-1"></i> Achievements
                </button>
                <button id="nav-progress-btn" onclick="switchPage('progress')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="trending-up" class="w-4 h-4 inline mr-1"></i> Progress
                </button>
                <button id="nav-settings-btn" onclick="switchPage('settings')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> Settings
                </button>
            </nav>
 <main class="glass-base rounded-3xl p-5 sm:p-6 lg:p-8 shadow-2xl bg-gray-900/40">
                  <div id="timer-view">
            
            <div id="timer-card" class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h1 id="timer-title" class="text-2xl font-bold text-indigo-300">Focused Subject Tracker</h1>
                    
                    
                    <button 
                        id="music-btn" 
                        onclick="toggleSongPlayback()" 
                        class="p-2 rounded-full text-gray-400 hover:bg-white/10 transition-colors"
                    >
                        <i data-lucide="music" class="w-6 h-6"></i>
                    </button>
                    </div>
                
                
                <div class="text-center mb-6">
                    
                    <p id="time-display" class="text-7xl lg:text-8xl font-extrabold tabular-nums tracking-tighter">
                        00:00:00
                    </p>
                </div>
                
                
                <div class="mb-8 flex flex-col sm:flex-row justify-center items-center sm:space-x-6 space-y-4 sm:space-y-0 py-2">
                    
                    <div class="relative w-24 h-24 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 70 70">
                            
                            <circle 
                                class="text-gray-700/50" 
                                stroke-width="6" 
                                stroke="currentColor" 
                                fill="transparent" 
                                r="30" 
                                cx="35" 
                                cy="35"
                            ></circle>
                            
                            <circle 
                                id="streak-progress-bar"
                                class="text-emerald-400 transition-all duration-700 ease-out" 
                                stroke-width="6" 
                                stroke="currentColor" 
                                stroke-linecap="round" 
                                fill="transparent" 
                                r="30" 
                                cx="35" 
                                cy="35"
                                style="stroke-dasharray: 188.5; stroke-dashoffset: 188.5;"
                            ></circle>
                        </svg>
                        <span id="streak-progress-percent" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-gray-300">0%</span>
                    </div>

                    
                    <div class="flex-grow text-center sm:text-left">
                        <div class="text-sm text-gray-400 mb-1">Current Daily Focus Streak</div>
                        <div class="flex items-center justify-center sm:justify-start">
                            <i data-lucide="flame" class="w-8 h-8 mr-3 text-red-400"></i>
                            <span id="streak-count" class="text-5xl font-extrabold text-red-300 tabular-nums">0</span>
                        </div>
                        <div id="next-streak-info" class="text-xs text-gray-500 mt-2">
                            </div>
                    </div>
                </div>

                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-300">
                        Select Subject
                    </label>
                    <div id="subject-selector" class="flex flex-wrap gap-2 sm:flex-row sm:space-x-2 sm:gap-0">
                        
                    </div>
                </div>

                
                <div class="mb-8">
                    <label for="task-input" class="block text-sm font-medium mb-2 text-gray-300">
                        Session Goal
                    </label>
                    <div class="flex items-center bg-white/10 rounded-full p-3">
                        <i data-lucide="target" class="w-5 h-5 mr-3 text-indigo-400 flex-shrink-0"></i>
                        <input 
                            id="task-input"
                            type="text"
                            placeholder="What do you want to accomplish?"
                            class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                        >
                    </div>
                </div>

                
                <div class="flex justify-center space-x-4">
                    <button id="start-pause-btn" onclick="startPauseHandler()" class="p-4 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 bg-green-500 hover:bg-green-600">
                        <i data-lucide="play" class="w-6 h-6"></i>
                    </button>
                    
                    <button id="reset-btn" onclick="resetTimer()" disabled class="p-4 rounded-full bg-gray-700/50 hover:bg-gray-600/70 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
                    </button>
                    
                    
                    <button id="pomodoro-btn" onclick="togglePomodoro()" class="p-4 rounded-full bg-gray-700/50 hover:bg-gray-600/70 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="timer" class="w-6 h-6"></i>
                    </button>

                    
                    <button id="fullscreen-btn" onclick="toggleFullscreenClock()" class="p-4 rounded-full bg-indigo-600/70 hover:bg-indigo-600 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="maximize" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            
            <div class="glass-base mt-8 p-4 rounded-3xl shadow-xl bg-gray-800/50 border-gray-700/50">
                <h2 class="text-xl font-semibold mb-3 text-center text-gray-300 flex items-center justify-center">
                    <i data-lucide="history" class="w-5 h-5 mr-2 text-gray-400"></i>
                    Recent Focus Sessions
                </h2>
                <div id="history-list" class="max-h-48 overflow-y-auto space-y-2">
                    
                </div>
                <p id="no-history" class="text-center text-gray-500 text-sm py-4 hidden">No sessions logged yet.</p>
            </div>
        </div>
        
        
        <div id="tasks-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-4">Task List</h1>
                
                
                <div class="mb-6 flex space-x-3">
                    <div class="flex items-center bg-white/10 rounded-full p-3 flex-grow">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-3 text-emerald-400 flex-shrink-0"></i>
                        <input 
                            id="new-task-input"
                            type="text"
                            placeholder="Add a new task..."
                            class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') addTask()"
                        >
                    </div>
                    <button onclick="addTask()" class="p-3 rounded-full bg-emerald-600 hover:bg-emerald-700 transition-colors flex-shrink-0">
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </div>

                
                <div id="tasks-list" class="space-y-3 max-h-96 overflow-y-auto">
                    
                </div>
            </div>
        </div>
        
        
        <div id="history-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-4">Daily Focus History</h1>
                
                <div class="mb-6">
                    <label for="date-selector" class="block text-sm font-medium mb-2 text-gray-300">Select Day</label>
                    <select 
                        id="date-selector" 
                        onchange="handleDateChange(this.value)" 
                        class="w-full p-3 rounded-full bg-gray-700 border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        <option value="">No sessions logged</option>
                    </select>
                </div>

                <div id="daily-summary-container" class="space-y-6">
                    
                    <p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>
                </div>
            </div>
        </div>
        
        <div id="achievements-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-emerald-300 mb-6">Trophy Case</h1>
                <p class="text-gray-400 mb-6">Earn single-level achievements by hitting focus and task milestones.</p>
                <div id="trophies-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            </div>
        </div>
        
        <div id="progress-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-6">Cumulative Progress</h1>
                <p class="text-gray-400 mb-6">Track your long-term statistics and compare performance week-over-week.</p>
                <div id="metrics-container" class="grid grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                    
                </div>
                
                <h2 class="text-xl font-semibold text-gray-300 mt-8 mb-4 border-b border-gray-700 pb-2 flex items-center">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> Weekly Focus Breakdown (Area Chart)
                </h2>
                <div id="weekly-breakdown-container" class="p-4 bg-gray-900/40 rounded-xl">
                    <p class="text-center text-gray-400">Loading weekly data...</p>
                </div>
            </div>
        </div>

        
        <div id="settings-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-yellow-300 mb-6">Application Settings</h1>
                
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="award" class="w-5 h-5 mr-2"></i> Daily Streak Goal
                    </h2>
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <label for="daily-goal-input" class="text-gray-400 font-medium flex-shrink-0">Daily Focus Goal (Minutes):</label>
                        <input 
                            id="daily-goal-input"
                            type="number"
                            min="5"
                            value="30"
                            class="w-full sm:w-24 p-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none text-center"
                            onchange="updateDailyGoal(this.value)"
                        >
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Set the minimum focus time required to keep your daily streak alive. Must be at least 5 minutes.</p>
                </div>
                
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="book-open-check" class="w-5 h-5 mr-2"></i> Subject Management
                    </h2>
                    
                    
                    <div class="mb-6 flex space-x-3">
                        <div class="flex items-center bg-white/10 rounded-full p-3 flex-grow">
                            <i data-lucide="book-open" class="w-5 h-5 mr-3 text-yellow-400 flex-shrink-0"></i>
                            <input 
                                id="new-subject-input"
                                type="text"
                                placeholder="Enter new subject name (e.g., History)"
                                class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                                onkeypress="if(event.key === 'Enter') addSubjectHandler()"
                            >
                        </div>
                        <button onclick="addSubjectHandler()" class="p-3 rounded-full bg-yellow-600 hover:bg-yellow-700 transition-colors flex-shrink-0">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>

                    
                    <div id="subjects-list-manager" class="space-y-3 max-h-96 overflow-y-auto pt-2">
                        
                    </div>
                </div>
            </div>
        </div>


    </div>

    
    <div id="details-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
        <div class="w-full max-w-md bg-gray-900 border border-indigo-600/50 rounded-xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-3 text-indigo-400 flex items-center">
                <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                Session Details
            </h3>
            <p id="modal-content" class="text-gray-300 whitespace-pre-wrap"></p>
            <button 
                onclick="document.getElementById('details-modal').classList.add('hidden')"
                class="w-full mt-4 flex items-center justify-center p-3 rounded-full font-semibold text-lg transition-colors bg-indigo-600 hover:bg-indigo-700"
            >
                Close
            </button>
        </div>
    </div>
    
    
    <div id="fullscreen-clock-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-4">
        
        <button 
            onclick="toggleFullscreenClock()" 
            class="absolute top-6 right-6 p-3 rounded-full text-white bg-white/10 hover:bg-white/20 transition-colors z-50"
        >
            <i data-lucide="minimize" class="w-8 h-8"></i>
        </button>
        
        <div class="text-center">
            <p id="fullscreen-time-display" class="text-white text-[12rem] lg:text-[18rem] xl:text-[25rem] font-extrabold tabular-nums tracking-tighter transition-colors">
                00:00:00
            </p>
            <p id="fullscreen-subject-goal" class="text-4xl font-semibold text-indigo-400 mt-4 text-center break-words max-w-full px-4 sm:px-0"></p>
        </div>
        
    </div>
    
    <audio id="music-player" preload="auto"></audio>


    <script>
            // --- GLOBAL STATE & CONSTANTS ---
            const LOCAL_STORAGE_KEY = 'subjectTrackerData';
            // const STREAK_GOAL_SECONDS = 10 * 3600; // REMOVED: Using dynamic daily goal
            const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 30; // Radius 30 from SVG
            
            // --- POMODORO CONSTANTS ---
            const POMODORO_FOCUS_SECONDS = 55 * 60; // 55 minutes
            const POMODORO_BREAK_SECONDS = 5 * 60;  // 5 minutes
            
            // Subject colors and default list
            const SUBJECT_COLORS = ['indigo', 'emerald', 'sky', 'yellow', 'red', 'purple', 'teal', 'pink'];
            
            const DEFAULT_SUBJECTS = [
                { id: 'physics', name: 'Physics', color: 'indigo' },
                { id: 'chemistry', name: 'Chemistry', color: 'emerald' },
                { id: 'math', name: 'Math', color: 'sky' },
                { id: 'other', name: 'Other', color: 'yellow' },
                { id: 'lang', name: 'Language', color: 'red' }, 
            ];
            
     // --- NEW ACHIEVEMENT/PROGRESS CONFIG (Flattened Structure) ---
            const ACHIEVEMENTS_CONFIG = [
                // Focused Time Trophies (unit: 'minutes')
                { 
                    id: 'focused_hour_easy', 
                    icon: 'hourglass', 
                    name: 'First Step (1h)',
                    unit: 'minutes',
                    description: 'Log one hour of focused time.',
                    goal: 60, // Single goal
                    color: 'text-amber-300'
                },
                { 
                    id: 'focused_hour_medium', 
                    icon: 'hourglass', 
                    name: 'Time Manager (5h)', 
                    unit: 'minutes',
                    description: 'Log five hours of focused time.',
                    goal: 300, 
                    color: 'text-gray-300'
                },
                { 
                    id: 'focused_hour_hard', 
                    icon: 'hourglass', 
                    name: 'Flow State Master (20h)', 
                    unit: 'minutes',
                    description: 'Log twenty hours of focused time.',
                    goal: 1200, 
                    color: 'text-indigo-400'
                },

                // Tasks Done Trophies (unit: 'tasks')
                { 
                    id: 'tasks_done_easy', 
                    icon: 'check-circle', 
                    name: 'Getting Things Done (5)', 
                    unit: 'tasks',
                    description: 'Complete 5 tasks.',
                    goal: 5, 
                    color: 'text-amber-300'
                },
                { 
                    id: 'tasks_done_medium', 
                    icon: 'check-circle', 
                    name: 'Productivity Pro (20)', 
                    unit: 'tasks',
                    description: 'Complete 20 tasks.',
                    goal: 20, 
                    color: 'text-gray-300'
                },
                { 
                    id: 'tasks_done_hard', 
                    icon: 'check-circle', 
                    name: 'Executioner (50)', 
                    unit: 'tasks',
                    description: 'Complete 50 tasks.',
                    goal: 50, 
                    color: 'text-indigo-400'
                }
            ];

            const DEFAULT_STATE = {
                isRunning: false,
                timeElapsed: 0,
                startTime: null,
                subjects: DEFAULT_SUBJECTS, // DYNAMIC SUBJECTS
                currentSubject: DEFAULT_SUBJECTS[0].id,
                sessionGoal: '',
                sessions: [],
                tasks: [], 
                currentPage: 'timer',
                totalFocusTime: 0,
                isPomodoroActive: false,
                pomodoroMode: 'focus', 
                pomodoroTimeRemaining: POMODORO_FOCUS_SECONDS,
                
                // NEW DAILY STREAK AND GOAL MANAGEMENT
                currentDailyStreak: 0,
                lastActiveDate: null, // ISO date string of the last day a goal was logged
                dailyFocusGoalMinutes: 30, // Default to 30 minutes (1800 seconds)
                dailyTimeLogged: 0, // Time logged for the current active day (in seconds)
            };

            let state = { ...DEFAULT_STATE };
            let intervalId = null;
            // REMOVED: audioContext, brownNoiseGenerator, isNoisePlaying

            // --- MUSIC PLAYER CONSTANTS & STATE ---
            let currentSongIndex = 0;
            const PLAYLIST = [
                'assets/song1.mp3',
                'assets/song2.mp3',
                'assets/song3.mp3', 
                'assets/song4.mp3',
                'assets/song5.mp3',
                // Add your actual songs to the 'assets' folder and list them here
            ];
            
            // Stats object for achievements and progress calculation
            let stats = {
                overallTime: 0,
                monthlyTime: 0,
                weeklyTime: 0,
                prevMonthlyTime: 0, 
                prevWeeklyTime: 0,
                dailyTimeInWeek: Array(7).fill(0), // Focus time for each day of the current week (Mon-Sun)
                tasksCompleted: 0,
                totalTasks: 0,
                efficiency: 0,
                avgDailyHours: 0,
                avgSessionLengthSeconds: 0,
                achievements: {},
            };


            // --- DOM ELEMENTS (Scoped by convention) ---
            const D = {
                // Timer View elements
                timerTitle: document.getElementById('timer-title'),
                timeDisplay: document.getElementById('time-display'),
                taskInput: document.getElementById('task-input'),
                startPauseBtn: document.getElementById('start-pause-btn'),
                resetBtn: document.getElementById('reset-btn'),
                // noiseBtn: document.getElementById('noise-btn'), // REMOVED
                musicBtn: document.getElementById('music-btn'), // ADDED
                musicPlayer: document.getElementById('music-player'), // ADDED
                pomodoroBtn: document.getElementById('pomodoro-btn'),
                historyList: document.getElementById('history-list'),
                noHistory: document.getElementById('no-history'),
                subjectSelector: document.getElementById('subject-selector'),
                detailsModal: document.getElementById('details-modal'),
                modalContent: document.getElementById('modal-content'),
                
                // Streak elements
                streakProgressBar: document.getElementById('streak-progress-bar'),
                streakProgressPercent: document.getElementById('streak-progress-percent'),
                streakCount: document.getElementById('streak-count'),
                nextStreakInfo: document.getElementById('next-streak-info'),

                // Navigation and View containers
                timerView: document.getElementById('timer-view'),
                tasksView: document.getElementById('tasks-view'),
                historyView: document.getElementById('history-view'), 
                achievementsView: document.getElementById('achievements-view'), 
                progressView: document.getElementById('progress-view'), 
                settingsView: document.getElementById('settings-view'), // NEW SETTINGS VIEW
                navTimerBtn: document.getElementById('nav-timer-btn'),
                navTasksBtn: document.getElementById('nav-tasks-btn'),
                navHistoryBtn: document.getElementById('nav-history-btn'),
                navAchievementsBtn: document.getElementById('nav-achievements-btn'), 
                navProgressBtn: document.getElementById('nav-progress-btn'), 
                navSettingsBtn: document.getElementById('nav-settings-btn'), // NEW SETTINGS BUTTON
                
                // Tasks UI elements
                taskInputNew: document.getElementById('new-task-input'),
                tasksListContainer: document.getElementById('tasks-list'),

                // History UI elements
                dateSelector: document.getElementById('date-selector'),
                dailySummaryContainer: document.getElementById('daily-summary-container'),
                
                // Achievements UI elements 
                trophiesContainer: document.getElementById('trophies-container'),
                metricsContainer: document.getElementById('metrics-container'), 
                weeklyBreakdownContainer: document.getElementById('weekly-breakdown-container'), 
                
                // Fullscreen Clock elements
                fullscreenClockModal: document.getElementById('fullscreen-clock-modal'),
                fullscreenTimeDisplay: document.getElementById('fullscreen-time-display'),
                fullscreenSubjectGoal: document.getElementById('fullscreen-subject-goal'),
                fullscreenBtn: document.getElementById('fullscreen-btn'),
                
                // Settings UI elements
                newSubjectInput: document.getElementById('new-subject-input'),
                subjectsListManager: document.getElementById('subjects-list-manager'),
                dailyGoalInput: document.getElementById('daily-goal-input'), // NEW ELEMENT
            };

            // --- LOCAL STORAGE LOGIC ---

            /** Loads state from localStorage or initializes default state. */
         function loadState() {
                try {
                    const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (storedState) {
                        const loadedState = JSON.parse(storedState);
                        // Merge loaded state, ensuring new properties have defaults if missing
                        state = { ...DEFAULT_STATE, ...loadedState };
                        
                        // Re-calculate timeElapsed/pomodoroTimeRemaining if the timer was running when closed
                        if (state.isRunning && state.startTime) {
                            const timeSinceStart = (Date.now() - state.startTime) / 1000;
                            
                            if (state.isPomodoroActive) {
                                // For Pomodoro, subtract the time difference from remaining time
                                state.pomodoroTimeRemaining = Math.max(0, state.pomodoroTimeRemaining - timeSinceStart);
                            } else {
                                // For free-form, add the time difference to elapsed time
                                state.timeElapsed += timeSinceStart;
                            }
                            // state.isRunning = false; // <-- REMOVED THIS LINE
                        }
                    }
                } catch (error) {
                    console.error("Error loading state from localStorage:", error);
                    state = { ...DEFAULT_STATE };
                }
                
                // --- STREAK RESET CHECK ON LOAD ---
                const now = new Date();
                const todayKey = getFormattedDate(now.toISOString());
                const lastActiveKey = state.lastActiveDate ? getFormattedDate(state.lastActiveDate) : null;
                
                if (lastActiveKey && lastActiveKey !== todayKey) {
                    // Get the date key for yesterday
                    const yesterday = new Date(now.setDate(now.getDate() - 1));
                    const yesterdayKey = getFormattedDate(yesterday.toISOString());
                    
                    // Streak is broken if the last active day was NOT yesterday.
                    if (lastActiveKey !== yesterdayKey) {
                        console.log(`Daily streak broken. Last activity on ${lastActiveKey}. Resetting streak from ${state.currentDailyStreak} to 0.`);
                        state.currentDailyStreak = 0;
                    } 
                    
                    // If the date changed, reset the daily time logged for today (to start fresh)
                    state.dailyTimeLogged = 0; 
                } 
                // --- END STREAK RESET CHECK ---

                // Calculate initial stats after loading
                calculateAllStats();
            }

            /** Saves the current essential state to localStorage. */
            function saveState() {
                try {
                    const stateToSave = {
                        isRunning: state.isRunning,
                        timeElapsed: state.timeElapsed,
                        startTime: state.startTime,
                        currentSubject: state.currentSubject,
                        sessionGoal: D.taskInput ? D.taskInput.value : state.sessionGoal,
                        sessions: state.sessions,
                        tasks: state.tasks,
                        currentPage: state.currentPage,
                        totalFocusTime: state.totalFocusTime,
                        isPomodoroActive: state.isPomodoroActive,
                        pomodoroMode: state.pomodoroMode,
                        pomodoroTimeRemaining: state.pomodoroTimeRemaining,
                        subjects: state.subjects, // SAVE DYNAMIC SUBJECTS
                        
                        // NEW DAILY STREAK AND GOAL MANAGEMENT
                        currentDailyStreak: state.currentDailyStreak,
                        lastActiveDate: state.lastActiveDate,
                        dailyFocusGoalMinutes: state.dailyFocusGoalMinutes,
                        dailyTimeLogged: state.dailyTimeLogged,
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
                } catch (error) {
                    console.error("Error saving state to localStorage:", error);
                }
            }
            
            // --- TIME & DATE UTILITIES ---

            /** Formats seconds into H:MM:SS string. */
            function formatTime(totalSeconds, includeHours) {
                const totalSec = Math.max(0, Math.floor(totalSeconds)); // Ensure it's not negative
                const hours = Math.floor(totalSec / 3600);
                const minutes = Math.floor((totalSec % 3600) / 60);
                const seconds = Math.floor(totalSec % 60);

                const minutesStr = minutes.toString().padStart(2, '0');
                const secondsStr = seconds.toString().padStart(2, '0');

                if (includeHours || hours > 0) {
                    const hoursStr = hours.toString().padStart(2, '0');
                    return `${hoursStr}:${minutesStr}:${secondsStr}`;
                }
                return `${minutesStr}:${secondsStr}`;
            }
            
            // Helper for formatting time in minutes/hours
            const formatMinutes = (seconds) => {
                const totalMinutes = Math.floor(seconds / 60);
                if (totalMinutes < 60) return `${totalMinutes} min`;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m`;
            };
            
            // Helper for weekly/monthly comparisons
            function formatComparison(current, previous, unit) {
                if (previous === 0) {
                    return `<span class="text-gray-400">No previous ${unit} data</span>`;
                }
                const change = current - previous;
                const percentChange = (change / previous) * 100;
                const formattedPercent = Math.abs(percentChange).toFixed(0);

                let icon = 'minus'; 
                let color = 'text-gray-400';
                let direction = 'No change';

                if (Math.abs(percentChange) < 1) { // Treat very small change as 'No change'
                     return `<span class="text-gray-400">Same as last ${unit}</span>`;
                }
                
                if (percentChange > 0) {
                    icon = 'arrow-up-right';
                    color = 'text-emerald-400';
                    direction = 'Up';
                } else if (percentChange < 0) {
                    icon = 'arrow-down-right';
                    color = 'text-red-400';
                    direction = 'Down';
                } 

                return `<span class="${color} flex items-center">
                            <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i> 
                            ${direction} ${formattedPercent}%
                        </span>`;
            }

            /** Extracts the date part (YYYY-MM-DD) from an ISO string. */
            function getFormattedDate(isoString) {
                if (!isoString) return null;
                // Safely handles both 'YYYY-MM-DDTHH:MM:SS...' and 'YYYY-MM-DD'
                return isoString.split('T')[0];
            }
            
            /** Converts YYYY-MM-DD to a more readable format (e.g., Oct 18, 2025) */
            function formatDateForDisplay(dateKey) {
                const date = new Date(dateKey + 'T00:00:00'); // Use T00:00:00 to prevent timezone issues
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    timeZone: 'UTC' // Important for consistent date rendering
                });
            }
            
            // UPDATED to use state.subjects
            function getSubjectColorClass(subjectId) {
                const subject = state.subjects.find(s => s.id === subjectId);
                return subject ? `text-${subject.color}-400` : 'text-gray-400';
            }
            
            /** Get the start of the specified period (month/week/prevMonth/prevWeek) */
            function getPeriodStart(period, referenceDate = new Date()) {
                const date = new Date(referenceDate.getTime());
                date.setHours(0, 0, 0, 0); 
                
                if (period === 'week') {
                    // Set to the start of the current week (Monday)
                    const day = date.getDay() || 7; // Convert 0 (Sunday) to 7
                    date.setDate(date.getDate() - day + 1); 
                    return date;
                } else if (period === 'prevWeek') {
                    const startOfWeek = getPeriodStart('week', referenceDate);
                    startOfWeek.setDate(startOfWeek.getDate() - 7);
                    return startOfWeek;
                } else if (period === 'month') {
                    // Set to the 1st day of the current month
                    date.setDate(1);
                    return date;
                } else if (period === 'prevMonth') {
                    // Set to the 1st day of the month before the current one
                    date.setDate(1);
                    date.setMonth(date.getMonth() - 1);
                    return date;
                }
                // Return a very old date for overall calculation
                return new Date(0); 
            }

            // --- ACHIEVEMENT/PROGRESS CALCULATION LOGIC ---
            
            function calculateAllStats() {
                const now = new Date();
                
                // Set the current date to midnight for consistent comparison (Local time)
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                
                const startOfWeek = getPeriodStart('week', now).getTime();
                const startOfPrevWeek = getPeriodStart('prevWeek', now).getTime();
                const startOfMonth = getPeriodStart('month', now).getTime();
                const startOfPrevMonth = getPeriodStart('prevMonth', now).getTime();

                let overallTime = 0;
                let monthlyTime = 0;
                let prevMonthlyTime = 0;
                let weeklyTime = 0;
                let prevWeeklyTime = 0;
                let dailyTimeInWeek = Array(7).fill(0); // Index 0=Mon, 6=Sun
                let totalSessionsCount = 0;


                // 1. Calculate Time Metrics
                state.sessions.forEach(session => {
                    const sessionTime = new Date(session.timestamp).getTime();
                    const duration = session.durationSeconds;

                    overallTime += duration;
                    totalSessionsCount += 1;

                    if (sessionTime >= startOfMonth) {
                        monthlyTime += duration;
                    }
                    if (sessionTime >= startOfPrevMonth && sessionTime < startOfMonth) {
                        prevMonthlyTime += duration;
                    }
                    
                    if (sessionTime >= startOfWeek) {
                        weeklyTime += duration;
                        
                        // Calculate day index (0=Mon, 6=Sat, 0 is Sunday, adjust for Mon start)
                        const date = new Date(sessionTime);
                        let day = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                        const dayIndex = (day === 0 ? 6 : day - 1); // Convert 0 (Sun) to 6, 1-6 (Mon-Sat) to 0-5
                        dailyTimeInWeek[dayIndex] += duration;
                    }
                    
                    if (sessionTime >= startOfPrevWeek && sessionTime < startOfWeek) {
                         prevWeeklyTime += duration;
                    }
                });


                // 2. Calculate Task Metrics
                const totalTasks = state.tasks.length;
                const tasksCompleted = state.tasks.filter(t => t.completed).length;
                const efficiency = totalTasks > 0 ? Math.round((tasksCompleted / totalTasks) * 100) : 0;
                
                // 3. Calculate Overall Average Study Hours
                const firstSessionTimestamp = state.sessions.length > 0 ? Math.min(...state.sessions.map(s => new Date(s.timestamp).getTime())) : Date.now();
                
                // Calculate days since the first session, rounding up to 1 if it's the first day
                const daysSinceStart = Math.ceil((startOfToday - new Date(firstSessionTimestamp).setHours(0,0,0,0)) / (1000 * 3600 * 24)) || 1;
                const avgDailyHours = overallTime / 3600 / daysSinceStart;

                // Calculate Average Session Length
                const avgSessionLengthSeconds = totalSessionsCount > 0 ? overallTime / totalSessionsCount : 0;


                // 4. Update stats object
                stats.overallTime = overallTime;
                stats.monthlyTime = monthlyTime;
                stats.weeklyTime = weeklyTime;
                stats.prevMonthlyTime = prevMonthlyTime;
                stats.prevWeeklyTime = prevWeeklyTime;
                stats.dailyTimeInWeek = dailyTimeInWeek;
                stats.tasksCompleted = tasksCompleted;
                stats.totalTasks = totalTasks;
                stats.efficiency = efficiency;
                stats.avgDailyHours = avgDailyHours;
                stats.avgSessionLengthSeconds = avgSessionLengthSeconds;
                
                // 5. Check Achievements
                stats.achievements = checkAchievementStatus(overallTime, tasksCompleted);
                
                return stats;
            }

            function checkAchievementStatus(overallTimeSeconds, tasksCompletedCount) {
                const status = {};
                const overallTimeMinutes = Math.floor(overallTimeSeconds / 60);
                
                ACHIEVEMENTS_CONFIG.forEach(ach => {
                    let progressValue;
                    
                    if (ach.unit === 'minutes') {
                        progressValue = overallTimeMinutes;
                    } else if (ach.unit === 'tasks') {
                        progressValue = tasksCompletedCount;
                    }
                    
                    const isComplete = progressValue >= ach.goal;
                    // Progress is calculated towards the single goal
                    const percentage = ach.goal > 0 ? Math.min(100, (progressValue / ach.goal) * 100) : 100;

                    status[ach.id] = {
                        progress: progressValue,
                        goal: ach.goal, // Store the single goal
                        isComplete: isComplete,
                        percentage: percentage,
                    };
                });
                return status;
            }


            // --- MUSIC PLAYER LOGIC (REPLACES NOISE GENERATION) ---
            
            /** Initializes the music player, loads the first song, and sets up the event listener for track end. */
            function initMusicPlayer() {
                if (PLAYLIST.length === 0) {
                    D.musicBtn.disabled = true;
                    D.musicBtn.title = "Playlist is empty";
                    D.musicBtn.innerHTML = `<i data-lucide="slash" class="w-6 h-6 text-red-500"></i>`;
                    window.createLucideIcons();
                    return;
                }
                
                // Set the source to the current song in the playlist
                D.musicPlayer.src = PLAYLIST[currentSongIndex];
                D.musicPlayer.volume = 0.1; // Set a default low volume for background music
                D.musicPlayer.load(); // Load the audio file
                
                // Set up the event listener for when the current song ends to play the next one
                D.musicPlayer.onended = playNextSong;
                
                // Initial UI update
                updateMusicButtonIcon();
            }

            /** Plays the next song in the playlist, looping back to the beginning. */
            function playNextSong() {
                currentSongIndex = (currentSongIndex + 1) % PLAYLIST.length;
                D.musicPlayer.src = PLAYLIST[currentSongIndex];
                D.musicPlayer.load();
                D.musicPlayer.play().catch(e => {
                    console.error("Error playing next song (Autoplay prevented?):", e);
                    D.musicPlayer.pause();
                    updateMusicButtonIcon();
                });
            }

            /** Stops playback and resets the current song to the start of the playlist. */
            function stopSongPlayback() {
                D.musicPlayer.pause();
                currentSongIndex = 0;
                // Reload the first song to be ready for the next play
                if (PLAYLIST.length > 0) {
                    D.musicPlayer.src = PLAYLIST[currentSongIndex];
                    D.musicPlayer.load();
                }
                updateMusicButtonIcon();
            }

            /** Toggles between playing and pausing the song playback. (Bound to the button) */
            function toggleSongPlayback() {
                // If the player is currently paused, attempt to play.
                if (D.musicPlayer.paused) {
                    if (D.musicPlayer.src === "" && PLAYLIST.length > 0) {
                         initMusicPlayer(); // Initialize if not done, or if fully reset
                    }
                    D.musicPlayer.play().catch(e => {
                        console.error("Autoplay prevented:", e);
                    });
                } else {
                    // If the player is currently playing, pause it.
                    D.musicPlayer.pause();
                }
                updateMusicButtonIcon();
            }

            /** Updates the music button icon based on the playback state. */
            function updateMusicButtonIcon() {
                // Use a slight delay to allow the 'paused' state to reliably update
                setTimeout(() => {
                    if (D.musicPlayer.paused) {
                        D.musicBtn.innerHTML = `<i data-lucide="music" class="w-6 h-6"></i>`;
                        D.musicBtn.classList.remove('text-indigo-400');
                        D.musicBtn.classList.add('text-gray-400');
                    } else {
                        D.musicBtn.innerHTML = `<i data-lucide="volume-2" class="w-6 h-6"></i>`;
                        D.musicBtn.classList.remove('text-gray-400');
                        D.musicBtn.classList.add('text-indigo-400');
                    }
                    window.createLucideIcons();
                }, 100);
            }


            // --- TIMER LOGIC ---
            
            /** Core function to update the timer display every second. */
            function updateTimer() {
                if (state.isPomodoroActive) {
                    // Handle Pomodoro countdown
                    state.pomodoroTimeRemaining = Math.max(0, state.pomodoroTimeRemaining - 1);
                    const timeToDisplay = state.pomodoroTimeRemaining;
                    D.timeDisplay.textContent = formatTime(timeToDisplay, false);
                    D.fullscreenTimeDisplay.textContent = formatTime(timeToDisplay, false);

                    if (state.pomodoroTimeRemaining <= 0) {
                        handlePomodoroCompletion();
                        return;
                    }
                    
                    // Update the title
                    const modeText = state.pomodoroMode === 'focus' ? 'Focus Time' : 'Break Time';
                    D.timerTitle.textContent = `Pomodoro: ${modeText}`;

                } else {
                    // Handle free-form timer
                    state.timeElapsed += 1;
                    const timeToDisplay = state.timeElapsed;
                    D.timeDisplay.textContent = formatTime(timeToDisplay, true);
                    D.fullscreenTimeDisplay.textContent = formatTime(timeToDisplay, true);
                    D.timerTitle.textContent = 'Focused Subject Tracker';
                    
                    // Update Daily Goal Progress in real-time with the sum of logged time and current session
                    const newDailyTime = state.dailyTimeLogged + state.timeElapsed;
                    updateStreakProgress(newDailyTime);
                }
                
                saveState(); // Save state every second
            }

            /** Handles the logic when a Pomodoro session or break ends. */
            function handlePomodoroCompletion() {
                clearInterval(intervalId);
                intervalId = null;
                state.isRunning = false;

                if (state.pomodoroMode === 'focus') {
                    // Log the session before switching
                    logSession(POMODORO_FOCUS_SECONDS); 
                    
                    // Switch to break mode
                    state.pomodoroMode = 'break';
                    state.pomodoroTimeRemaining = POMODORO_BREAK_SECONDS;
                    D.timerTitle.textContent = 'Pomodoro: Break Time';
                    
                    // Notify user/play sound
                    new Audio('assets/ding.mp3').play().catch(e => console.log("Audio play failed:", e));

                    // Auto-start the break
                    startPauseHandler(); 
                    
                } else {
                    // Switch to focus mode
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                    D.timerTitle.textContent = 'Pomodoro: Focus Time';
                    
                    // Notify user/play sound
                    new Audio('assets/ding.mp3').play().catch(e => console.log("Audio play failed:", e));
                    
                    // Re-enable controls for optional manual restart
                    updateButtonUI();
                    toggleInputControls(false); 
                }
                
                saveState();
            }

            
            /** Toggles the timer state (Start/Pause). Bound to the main button. */
            function startPauseHandler() {
                if (state.isRunning) {
                    // PAUSE TIMER
                    clearInterval(intervalId);
                    intervalId = null;
                    state.isRunning = false;
                    
                    // Save the current session goal if the timer is paused
                    state.sessionGoal = D.taskInput.value; 

                    // CRITICAL FIX: Do NOT log the session or reset timeElapsed here for 
                    // free-form timer. This allows the user to resume the session.
                    // The previous lines that logged/reset for !isPomodoroActive are removed.

                    updateButtonUI();
                    // re-enable everything
                    toggleInputControls(false); 
                    
                } else {
                    // START TIMER
                    if (!state.currentSubject) {
                        alert("Please select a subject to start focusing.");
                        return;
                    }
                    
                    state.isRunning = true;
                    // Check if starting a new session or resuming
                    state.startTime = Date.now(); 
                    
                    intervalId = setInterval(updateTimer, 1000); 

                    // Store the session goal from the input field
                    state.sessionGoal = D.taskInput.value;

                    updateButtonUI();
                    // disable inputs
                    toggleInputControls(true); 
                }
                saveState(); 
            }

            /** Resets the timer. Logs the session if it was a free-form session with time logged. */
            function resetTimer() {
                clearInterval(intervalId);
                intervalId = null;
                const wasRunning = state.isRunning;
                state.isRunning = false;
                
                // Only log free-form session if duration > 10 seconds
                if (!state.isPomodoroActive && state.timeElapsed > 10) {
                    logSession();
                }

                // Reset state
                state.timeElapsed = 0;
                state.pomodoroMode = 'focus';
                state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                state.startTime = null;
                // Keep currentSubject and sessionGoal for convenience
                
                updateTimerDisplay(); // Display 00:00:00 or Pomodoro initial time
                updateButtonUI();
                toggleInputControls(false); // Re-enable controls
                
                if (wasRunning) {
                     stopSongPlayback(); // Stop music if timer was running and is reset
                }
                
                saveState();
            }

            /** Enables or disables controls based on timer state. */
            function toggleInputControls(disable) {
                // Subject selector buttons (Radio inputs)
                const subjectRadios = D.subjectSelector.querySelectorAll('input[type="radio"]');
                subjectRadios.forEach(radio => {
                    radio.disabled = disable;
                });

                // Session Goal input
                D.taskInput.disabled = disable;

                // Navigation buttons 
                D.navTasksBtn.disabled = disable;
                D.navHistoryBtn.disabled = disable;
                D.navAchievementsBtn.disabled = disable;
                D.navProgressBtn.disabled = disable;
                D.navSettingsBtn.disabled = disable;
                
                // Disable the Pomodoro toggle button
                D.pomodoroBtn.disabled = disable; 

                // FIX: Disable critical inputs in other views for robustness
                if (D.dailyGoalInput) D.dailyGoalInput.disabled = disable;
                if (D.newSubjectInput) D.newSubjectInput.disabled = disable;
            }

            /** Updates the UI of the main timer button (Play/Pause/Reset). */
            function updateButtonUI() {
                // Start/Pause Button
                D.startPauseBtn.disabled = false; // Always enabled unless subject is missing (handled in startPauseHandler)
                if (state.isRunning) {
                    D.startPauseBtn.innerHTML = `<i data-lucide="pause" class="w-6 h-6"></i>`;
                    D.startPauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    D.startPauseBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                } else {
                    D.startPauseBtn.innerHTML = `<i data-lucide="play" class="w-6 h-6"></i>`;
                    D.startPauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    D.startPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                }
                
                // Reset Button: Enabled if timer is not running OR if a long enough session has elapsed in free-form
                const showReset = state.isPomodoroActive || state.timeElapsed > 10;
                D.resetBtn.disabled = state.isRunning || !showReset;
                
                // Pomodoro Button: Disabled if running, styled if active
                D.pomodoroBtn.disabled = state.isRunning;
                D.pomodoroBtn.classList.toggle('bg-indigo-600/70', state.isPomodoroActive);
                D.pomodoroBtn.classList.toggle('hover:bg-indigo-600', state.isPomodoroActive);
                D.pomodoroBtn.classList.toggle('bg-gray-700/50', !state.isPomodoroActive);
                D.pomodoroBtn.classList.toggle('hover:bg-gray-600/70', !state.isPomodoroActive);
                
                // Fullscreen button
                D.fullscreenBtn.innerHTML = `<i data-lucide="${D.fullscreenClockModal.classList.contains('hidden') ? 'maximize' : 'minimize'}" class="w-6 h-6"></i>`;

                window.createLucideIcons();
            }
            
            /** Switches the timer between free-form and Pomodoro modes. */
            function togglePomodoro() {
                if (state.isRunning) return; // Cannot switch while running
                
                state.isPomodoroActive = !state.isPomodoroActive;
                state.pomodoroMode = 'focus';
                state.timeElapsed = 0; // Reset free-form timer
                state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                
                // If switching to Pomodoro, reset task goal
                if (state.isPomodoroActive) {
                    state.sessionGoal = D.taskInput.value || "Pomodoro Focus Session";
                    D.taskInput.value = state.sessionGoal; // Ensure the input reflects the new goal
                } else {
                    // If switching off Pomodoro, keep the current goal or clear if it was default
                    if (state.sessionGoal === "Pomodoro Focus Session") {
                        state.sessionGoal = '';
                        D.taskInput.value = '';
                    }
                }
                
                updateTimerDisplay();
                updateButtonUI();
                saveState();
            }

            /** Updates the time display based on the current state (Pomodoro or free-form). */
            function updateTimerDisplay() {
                let timeToDisplay;
                if (state.isPomodoroActive) {
                    timeToDisplay = state.pomodoroTimeRemaining;
                    const modeText = state.pomodoroMode === 'focus' ? 'Focus Time' : 'Break Time';
                    D.timerTitle.textContent = `Pomodoro: ${modeText}`;
                    D.timeDisplay.textContent = formatTime(timeToDisplay, false);
                    D.fullscreenTimeDisplay.textContent = formatTime(timeToDisplay, false);
                } else {
                    timeToDisplay = state.timeElapsed;
                    D.timerTitle.textContent = 'Focused Subject Tracker';
                    D.timeDisplay.textContent = formatTime(timeToDisplay, true);
                    D.fullscreenTimeDisplay.textContent = formatTime(timeToDisplay, true);
                }
            }


            /** Logs a completed session to the history. */
            function logSession(durationSeconds = state.timeElapsed) {
                // Only log if duration is significant (e.g., > 10 seconds for free-form)
                if (durationSeconds <= 10 && !state.isPomodoroActive) return; 
                
                const session = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    durationSeconds: durationSeconds,
                    subjectId: state.currentSubject,
                    goal: state.sessionGoal || "Unspecified Goal",
                    isPomodoro: state.isPomodoroActive,
                };
                
                state.sessions.push(session);
                
                // Update Daily Streak progress
                updateDailyStreak(durationSeconds);

                // Recalculate all stats since a new session was logged
                calculateAllStats();
                
                // Update the UI elements that depend on sessions
                renderHistoryList();
                renderAchievementsView();
                renderProgressView(); 
                
                // Reset session goal input for the next session
                D.taskInput.value = '';
                state.sessionGoal = '';
            }

            // --- STREAK LOGIC ---

            /** Updates the daily focus streak count based on the time logged. */
            function updateDailyStreak(durationSeconds) {
                const todayKey = getFormattedDate(new Date().toISOString());
                const dailyGoalSeconds = state.dailyFocusGoalMinutes * 60;
                
                // Check if the daily goal was previously met (timeLogged > goal)
                const wasGoalMet = state.dailyTimeLogged >= dailyGoalSeconds;

                // 1. Accumulate time logged for the current day
                state.dailyTimeLogged += durationSeconds;
                
                // 2. Check if the goal is met now
                const isGoalMetNow = state.dailyTimeLogged >= dailyGoalSeconds;
                
                // 3. Update streak count if the goal was just met for the first time today
                if (!wasGoalMet && isGoalMetNow) {
                    // Goal was just met! Check streak validity
                    const lastActiveKey = state.lastActiveDate ? getFormattedDate(state.lastActiveDate) : null;
                    
                    // Create Date objects for easy comparison, using UTC to avoid local time shifts
                    const lastActiveDate = lastActiveKey ? new Date(lastActiveKey + 'T00:00:00Z') : null;
                    const todayDate = new Date(todayKey + 'T00:00:00Z');
                    
                    let isContinuation = false;
                    if (lastActiveDate) {
                        // Calculate difference in days (24 hours in milliseconds)
                        const diffTime = todayDate.getTime() - lastActiveDate.getTime();
                        const diffDays = Math.round(diffTime / (1000 * 3600 * 24));
                        
                        // If last activity was exactly 1 day ago, the streak continues
                        if (diffDays === 1) {
                            isContinuation = true;
                        } 
                        // If diffDays is 0, it means the goal was met earlier today, so no change in streak count.
                        
                    } else {
                        // First session ever, streak starts at 1.
                        isContinuation = true; 
                    }
                    
                    if (isContinuation) {
                        state.currentDailyStreak += 1;
                    } 
                    // If streak was broken (diffDays > 1), we don't reset the count here;
                    // the reset logic is handled on app load (`loadState`).
                }
                
                // 4. Update the last active date to today
                state.lastActiveDate = new Date().toISOString(); 
                
                // 5. Update UI
                updateStreakProgress(state.dailyTimeLogged);
                saveState();
            }


            /** Updates the circular progress bar and streak count text. */
            function updateStreakProgress(dailyTimeLoggedSeconds = state.dailyTimeLogged) {
                const dailyGoalSeconds = state.dailyFocusGoalMinutes * 60;
                const dailyTimeMinutes = Math.floor(dailyTimeLoggedSeconds / 60);
                const dailyGoalMinutes = state.dailyFocusGoalMinutes;

                // Calculate progress
                const progressRatio = dailyGoalSeconds > 0 ? Math.min(1, dailyTimeLoggedSeconds / dailyGoalSeconds) : 1;
                const offset = CIRCLE_CIRCUMFERENCE * (1 - progressRatio);
                const percent = Math.floor(progressRatio * 100);

                // Update Progress Bar
                D.streakProgressBar.style.strokeDashoffset = offset;
                D.streakProgressPercent.textContent = `${percent}%`;
                
                // Update Streak Count
                D.streakCount.textContent = state.currentDailyStreak.toString();
                
                // Update Next Streak Info
                let nextInfo = '';
                if (dailyTimeMinutes < dailyGoalMinutes) {
                    const remainingMinutes = dailyGoalMinutes - dailyTimeMinutes;
                    nextInfo = `<span class="text-indigo-300 font-bold">${remainingMinutes} min</span> remaining to keep the streak!`;
                } else {
                    nextInfo = `<span class="text-emerald-400 font-bold">Daily goal met!</span> Log more to boost your metrics.`;
                }
                D.nextStreakInfo.innerHTML = nextInfo;
            }

            /** Handles changes to the daily goal input in settings. */
            function updateDailyGoal(newGoalMinutes) {
                const goal = parseInt(newGoalMinutes);
                if (isNaN(goal) || goal < 5) {
                    D.dailyGoalInput.value = state.dailyFocusGoalMinutes; // Revert to current state
                    alert("Daily focus goal must be a number of at least 5 minutes.");
                    return;
                }
                
                // Update state and recalculate streak based on new goal
                state.dailyFocusGoalMinutes = goal;
                
                // Re-evaluate if the current day's logged time meets the new goal
                // This might cause the streak to be gained/lost instantly if the user changes the goal
                updateDailyStreak(0); 
                
                // Ensure UI is updated
                updateStreakProgress();
                saveState();
            }


            // --- VIEWS & RENDERING ---
            
            /** Switches the visible application page. */
            function switchPage(pageName) {
                const views = {
                    'timer': D.timerView, 
                    'tasks': D.tasksView, 
                    'history': D.historyView, 
                    'achievements': D.achievementsView,
                    'progress': D.progressView,
                    'settings': D.settingsView,
                };
                const navButtons = {
                    'timer': D.navTimerBtn, 
                    'tasks': D.navTasksBtn, 
                    'history': D.navHistoryBtn, 
                    'achievements': D.navAchievementsBtn,
                    'progress': D.navProgressBtn,
                    'settings': D.navSettingsBtn,
                };
                
                // Hide all views and remove active class from all buttons
                Object.values(views).forEach(view => view.classList.add('hidden'));
                Object.values(navButtons).forEach(btn => {
                    btn.classList.remove('bg-indigo-600');
                    btn.classList.add('bg-gray-700/50', 'hover:bg-gray-700');
                });

                // Show the selected view and add active class to its button
                if (views[pageName]) {
                    views[pageName].classList.remove('hidden');
                    navButtons[pageName].classList.remove('bg-gray-700/50', 'hover:bg-gray-700');
                    navButtons[pageName].classList.add('bg-indigo-600');
                }
                
                state.currentPage = pageName;
                saveState();
                
                // Run specific render functions for the newly active view
                if (pageName === 'tasks') renderTasksList();
                if (pageName === 'history') renderHistoryView();
                if (pageName === 'achievements') renderAchievementsView();
                if (pageName === 'progress') renderProgressView();
                if (pageName === 'settings') renderSettingsView();
                
                // Re-render Lucide icons for the new view content
                window.createLucideIcons();
            }
            
            /** Main render function for the Timer View UI components. */
            function renderUI() {
                renderSubjectSelector();
                renderHistoryList();
                updateTimerDisplay();
                updateButtonUI();
                updateStreakProgress();
                
                // Ensure daily goal input reflects the loaded state value
                if (D.dailyGoalInput) {
                    D.dailyGoalInput.value = state.dailyFocusGoalMinutes;
                }
            }


            // --- SUBJECTS LOGIC (TIMER/SETTINGS) ---

            /** Renders the subject radio buttons on the timer view. */
            function renderSubjectSelector() {
                D.subjectSelector.innerHTML = '';
                
                state.subjects.forEach(subject => {
                    const isChecked = subject.id === state.currentSubject;
                    const colorClass = `bg-${subject.color}-600/70 hover:bg-${subject.color}-700`;
                    
                    const html = `
                        <input 
                            type="radio" 
                            id="subject-${subject.id}" 
                            name="subject" 
                            value="${subject.id}" 
                            class="hidden subject-radio"
                            ${isChecked ? 'checked' : ''}
                            onchange="selectSubject('${subject.id}')"
                            ${state.isRunning ? 'disabled' : ''}
                        >
                        <label 
                            for="subject-${subject.id}" 
                            class="py-2 px-4 rounded-full text-xs font-semibold cursor-pointer border-2 border-transparent transition-all ${isChecked ? 'subject-radio-checked' : 'bg-gray-700/50 hover:bg-gray-700'}"
                            style="${isChecked ? `background-color: var(--color-${subject.color}-600); border-color: var(--color-${subject.color}-300); color: white;` : ''}"
                        >
                            ${subject.name}
                        </label>
                    `;
                    
                    D.subjectSelector.innerHTML += html;
                });
                
                // Apply Tailwind color classes manually since they are dynamic
                state.subjects.forEach(subject => {
                    const styleTag = document.createElement('style');
                    styleTag.textContent = `
                        .subject-radio:checked + label[for="subject-${subject.id}"] {
                            background-color: var(--tw-colors-${subject.color}-600);
                            border-color: var(--tw-colors-${subject.color}-300);
                            color: white;
                            box-shadow: 0 0 10px rgba(var(--tw-colors-${subject.color}-600-rgb), 0.5);
                        }
                    `;
                    document.head.appendChild(styleTag);
                });
                
            }

            /** Sets the active subject. */
            function selectSubject(subjectId) {
                if (state.isRunning) return;
                state.currentSubject = subjectId;
                saveState();
                renderSubjectSelector(); // Re-render to update checked status
            }

            /** Adds a new subject from the settings input. */
            function addSubjectHandler() {
                const subjectName = D.newSubjectInput.value.trim();
                if (!subjectName) {
                    alert("Please enter a subject name.");
                    return;
                }

                // Simple sanitization and ID generation
                const subjectId = subjectName.toLowerCase().replace(/[^a-z0-9]/g, '_'); 
                
                if (state.subjects.some(s => s.id === subjectId)) {
                    alert(`Subject "${subjectName}" already exists.`);
                    return;
                }
                
                // Assign a color from the pool
                const existingColors = state.subjects.map(s => s.color);
                const availableColors = SUBJECT_COLORS.filter(c => !existingColors.includes(c));
                const newColor = availableColors.length > 0 ? availableColors[0] : SUBJECT_COLORS[0]; // Cycle if necessary

                state.subjects.push({
                    id: subjectId,
                    name: subjectName,
                    color: newColor,
                });

                D.newSubjectInput.value = '';
                
                if (!state.currentSubject) {
                    state.currentSubject = subjectId; // Select the new subject if none is selected
                }
                
                renderSubjectSelector();
                renderSubjectsListManager();
                saveState();
            }

            /** Deletes a subject. */
            function deleteSubject(subjectId) {
                if (state.subjects.length <= 1) {
                    alert("You must have at least one subject.");
                    return;
                }
                if (!confirm(`Are you sure you want to delete the subject? All associated history will remain but categorized under "Other".`)) {
                    return;
                }
                
                state.subjects = state.subjects.filter(s => s.id !== subjectId);
                
                // Reassign current subject if the deleted one was active
                if (state.currentSubject === subjectId) {
                    state.currentSubject = state.subjects[0].id;
                }
                
                // Future improvement: Re-categorize old sessions to a generic 'deleted' subject or similar.
                
                renderSubjectSelector();
                renderSubjectsListManager();
                saveState();
            }


            // --- TASKS LOGIC ---

            /** Adds a new task to the list. */
            function addTask() {
                const taskText = D.taskInputNew.value.trim();
                if (!taskText) return;

                const newTask = {
                    id: Date.now(),
                    text: taskText,
                    completed: false,
                    dateAdded: new Date().toISOString(),
                };
                
                state.tasks.unshift(newTask); // Add to the beginning
                D.taskInputNew.value = '';
                
                calculateAllStats(); // Update task stats
                renderTasksList();
                saveState();
            }

            /** Toggles the completion status of a task. */
            function toggleTaskCompletion(taskId) {
                const task = state.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    calculateAllStats(); // Update task stats
                    renderTasksList();
                    renderAchievementsView(); // Check if new task achievements were met
                    saveState();
                }
            }

            /** Deletes a task. */
            function deleteTask(taskId) {
                state.tasks = state.tasks.filter(t => t.id !== taskId);
                calculateAllStats(); // Update task stats
                renderTasksList();
                saveState();
            }

            /** Renders the task list on the Tasks view. */
            function renderTasksList() {
                D.tasksListContainer.innerHTML = state.tasks.map(task => `
                    <div class="flex items-start p-3 bg-gray-800/50 rounded-lg shadow-md border border-gray-700/50 hover:bg-gray-800 transition-colors">
                        <input 
                            type="checkbox" 
                            id="task-${task.id}"
                            class="mt-1 flex-shrink-0"
                            ${task.completed ? 'checked' : ''}
                            onclick="toggleTaskCompletion(${task.id})"
                        >
                        <label for="task-${task.id}" class="ml-4 flex-grow text-white text-base ${task.completed ? 'line-through text-gray-500' : ''} break-words">
                            ${task.text}
                        </label>
                        <button 
                            onclick="deleteTask(${task.id})" 
                            class="ml-4 p-1 rounded-full text-red-400 hover:text-red-300 hover:bg-white/10 transition-colors flex-shrink-0"
                        >
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                `).join('');
                
                window.createLucideIcons();
            }


            // --- HISTORY LOGIC (SIDE LIST/VIEW) ---

            /** Renders the list of recent sessions on the timer view. */
            function renderHistoryList() {
                if (state.sessions.length === 0) {
                    D.historyList.innerHTML = '';
                    D.noHistory.classList.remove('hidden');
                    return;
                }
                
                D.noHistory.classList.add('hidden');
                
                // Display up to the last 5 sessions
                const recentSessions = state.sessions.slice(-5).reverse();

                D.historyList.innerHTML = recentSessions.map(session => {
                    const subject = state.subjects.find(s => s.id === session.subjectId);
                    const subjectName = subject ? subject.name : 'Unknown Subject';
                    const colorClass = subject ? `text-${subject.color}-400` : 'text-gray-400';
                    const time = new Date(session.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-900/40 rounded-lg border-l-4 border-current ${colorClass}" style="border-left-color: ${subject ? `var(--tw-colors-${subject.color}-600)` : ''}">
                            <div class="flex-grow min-w-0">
                                <p class="text-sm font-semibold truncate text-white">${session.goal}</p>
                                <p class="text-xs ${colorClass} font-medium">${subjectName}</p>
                            </div>
                            <div class="flex items-center space-x-3 ml-4 flex-shrink-0">
                                <span class="text-sm font-bold tabular-nums text-gray-300">${formatTime(session.durationSeconds, true)}</span>
                                <button 
                                    onclick="showSessionDetails(${session.id})" 
                                    class="p-1 rounded-full text-indigo-400 hover:bg-white/10 transition-colors"
                                >
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                window.createLucideIcons();
            }

            /** Displays the full details of a session in a modal. */
            function showSessionDetails(sessionId) {
                const session = state.sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                const subject = state.subjects.find(s => s.id === session.subjectId);
                const subjectName = subject ? subject.name : 'Unknown Subject';
                const dateDisplay = formatDateForDisplay(getFormattedDate(session.timestamp));
                const timeDisplay = new Date(session.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });


                D.modalContent.innerHTML = `
                    <p><strong>Subject:</strong> ${subjectName}</p>
                    <p><strong>Goal:</strong> ${session.goal}</p>
                    <p><strong>Duration:</strong> ${formatTime(session.durationSeconds, true)}</p>
                    <p><strong>Type:</strong> ${session.isPomodoro ? 'Pomodoro' : 'Free-form'}</p>
                    <p><strong>Date:</strong> ${dateDisplay} at ${timeDisplay}</p>
                `;
                
                D.detailsModal.classList.remove('hidden');
                window.createLucideIcons();
            }

            /** Renders the History View (Daily Summaries). */
            function renderHistoryView() {
                const sessionsByDate = state.sessions.reduce((acc, session) => {
                    const dateKey = getFormattedDate(session.timestamp);
                    if (!acc[dateKey]) {
                        acc[dateKey] = {
                            totalDuration: 0,
                            sessions: [],
                            subjects: {},
                        };
                    }
                    acc[dateKey].totalDuration += session.durationSeconds;
                    acc[dateKey].sessions.push(session);
                    
                    // Track subject-wise time for the day
                    if (!acc[dateKey].subjects[session.subjectId]) {
                        acc[dateKey].subjects[session.subjectId] = 0;
                    }
                    acc[dateKey].subjects[session.subjectId] += session.durationSeconds;

                    return acc;
                }, {});

                const sortedDateKeys = Object.keys(sessionsByDate).sort().reverse();
                
                // 1. Populate Date Selector
                D.dateSelector.innerHTML = sortedDateKeys.map(dateKey => `
                    <option value="${dateKey}">${formatDateForDisplay(dateKey)} (${formatMinutes(sessionsByDate[dateKey].totalDuration)})</option>
                `).join('');
                
                if (sortedDateKeys.length === 0) {
                     D.dateSelector.innerHTML = `<option value="">No sessions logged</option>`;
                }

                // 2. Select the most recent date (or clear if none)
                const selectedDateKey = D.dateSelector.value || sortedDateKeys[0];
                if (selectedDateKey) {
                    handleDateChange(selectedDateKey);
                } else {
                    D.dailySummaryContainer.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">No sessions logged yet. Start the timer to track your focus!</p>`;
                }
            }
            
            /** Handles a change in the date selector on the History view. */
            function handleDateChange(dateKey) {
                if (!dateKey) {
                    D.dailySummaryContainer.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>`;
                    return;
                }
                
                const sessionsForDay = state.sessions.filter(s => getFormattedDate(s.timestamp) === dateKey);
                const totalDuration = sessionsForDay.reduce((sum, s) => sum + s.durationSeconds, 0);

                // Calculate Subject Breakdown
                const subjectBreakdown = sessionsForDay.reduce((acc, s) => {
                    if (!acc[s.subjectId]) acc[s.subjectId] = 0;
                    acc[s.subjectId] += s.durationSeconds;
                    return acc;
                }, {});
                
                const subjectBreakdownHtml = Object.entries(subjectBreakdown).map(([subjectId, duration]) => {
                    const subject = state.subjects.find(s => s.id === subjectId);
                    const subjectName = subject ? subject.name : 'Unknown Subject';
                    const colorClass = subject ? `text-${subject.color}-400` : 'text-gray-400';
                    const percentage = totalDuration > 0 ? ((duration / totalDuration) * 100).toFixed(0) : 0;
                    
                    return `
                        <div class="flex justify-between items-center py-1 border-b border-gray-700 last:border-b-0">
                            <span class="${colorClass} font-medium">${subjectName}</span>
                            <span class="text-sm text-gray-300">${formatMinutes(duration)} (${percentage}%)</span>
                        </div>
                    `;
                }).join('');

                // --- NEW TASK LOGIC FOR HISTORY VIEW ---
                const tasksForDay = state.tasks.filter(task => 
                    getFormattedDate(task.dateAdded) === dateKey
                );

                const tasksCompletedForDay = tasksForDay.filter(t => t.completed).length;
                const tasksPendingForDay = tasksForDay.filter(t => !t.completed).length;

                const taskSummaryHtml = `
                    <div class="glass-base p-4 rounded-xl bg-gray-700/50">
                        <h3 class="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-600 pb-2 flex items-center">
                            <i data-lucide="list-todo" class="w-5 h-5 mr-2 text-indigo-400"></i>
                            Task Summary
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Completed Tasks:</span>
                                <span class="text-emerald-400 font-bold">${tasksCompletedForDay}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Pending Tasks:</span>
                                <span class="text-red-400 font-bold">${tasksPendingForDay}</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-600">
                                <span class="text-white font-medium">Total Tasks Added:</span>
                                <span class="text-white font-bold">${tasksForDay.length}</span>
                            </div>
                        </div>
                    </div>
                `;
                // --- END NEW TASK LOGIC ---
                
                // Detailed Session List
                const sessionListHtml = sessionsForDay.reverse().map(s => {
                    const subject = state.subjects.find(s => s.id === s.subjectId);
                    const subjectName = subject ? subject.name : 'Unknown Subject';
                    const colorClass = subject ? `text-${subject.color}-400` : 'text-gray-400';
                    const time = new Date(s.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="flex items-start py-2 border-b border-gray-800 last:border-b-0">
                            <div class="flex-shrink-0 w-16 text-sm text-gray-400">${time}</div>
                            <div class="flex-grow min-w-0 ml-3">
                                <p class="text-white truncate font-medium">${s.goal}</p>
                                <p class="text-xs ${colorClass}">${subjectName} - ${formatTime(s.durationSeconds, true)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                

                D.dailySummaryContainer.innerHTML = `
                    <div class="glass-base p-4 rounded-xl bg-gray-700/50">
                        <h2 class="text-xl font-bold text-center text-indigo-300 mb-2">${formatDateForDisplay(dateKey)}</h2>
                        <div class="text-center text-3xl font-extrabold text-white">${formatMinutes(totalDuration)}</div>
                        <p class="text-center text-sm text-gray-400">Total Focus Time</p>
                    </div>

                    <div class="glass-base p-4 rounded-xl bg-gray-700/50">
                        <h3 class="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-600 pb-2">Subject Breakdown</h3>
                        ${subjectBreakdownHtml}
                    </div>

                    ${taskSummaryHtml}

                    <div class="glass-base p-4 rounded-xl bg-gray-700/50">
                        <h3 class="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-600 pb-2">All Sessions</h3>
                        <div class="max-h-60 overflow-y-auto">
                            ${sessionListHtml}
                        </div>
                    </div>
                `;
                
                window.createLucideIcons(); // Render new icons
            }

            /** Renders the Achievements View. */
            function renderAchievementsView() {
                // Recalculate stats before rendering
                calculateAllStats(); 
                
                D.trophiesContainer.innerHTML = ACHIEVEMENTS_CONFIG.map(ach => {
                    const status = stats.achievements[ach.id];
                    const isComplete = status.isComplete;
                    const color = isComplete ? ach.color : 'text-gray-500';
                    const shadow = isComplete ? `shadow-lg shadow-yellow-500/30` : `shadow-md shadow-gray-800`;
                    
                    const progressValue = ach.unit === 'minutes' ? formatMinutes(status.progress * 60) : status.progress;
                    const goalValue = ach.unit === 'minutes' ? formatMinutes(ach.goal * 60) : ach.goal;

                    return `
                        <div class="glass-base p-4 rounded-2xl bg-gray-800/40 border-gray-700/50 ${shadow} flex items-start space-x-4">
                            <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full bg-gray-700/70">
                                <i data-lucide="${ach.icon}" class="w-7 h-7 ${color}"></i>
                            </div>
                            <div class="flex-grow">
                                <h4 class="text-lg font-bold ${color}">${ach.name}</h4>
                                <p class="text-sm text-gray-400 mb-2">${ach.description}</p>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div 
                                        class="h-2.5 rounded-full ${isComplete ? 'bg-emerald-500' : 'bg-indigo-500'}" 
                                        style="width: ${status.percentage}%"
                                    ></div>
                                </div>
                                <p class="text-xs text-right text-gray-400 mt-1">${progressValue} / ${goalValue}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                window.createLucideIcons();
            }

            /** Renders the Progress View (Metrics and Charts). */
            function renderProgressView() {
                // Recalculate stats before rendering
                calculateAllStats(); 
                
                // RENDER METRICS
                const metrics = [
                    { 
                        title: "Total Focus", 
                        value: formatMinutes(stats.overallTime), 
                        icon: 'clock-4', 
                        color: 'text-indigo-400' 
                    },
                    { 
                        title: "Tasks Completed", 
                        value: `${stats.tasksCompleted} / ${stats.totalTasks}`, 
                        icon: 'list-checks', 
                        color: 'text-emerald-400' 
                    },
                    { 
                        title: "Overall Efficiency", 
                        value: `${stats.efficiency}%`, 
                        icon: 'gauge', 
                        color: 'text-yellow-400' 
                    },
                    { 
                        title: "Avg Session Length", 
                        value: formatMinutes(stats.avgSessionLengthSeconds), 
                        icon: 'trending-up', 
                        color: 'text-sky-400' 
                    },
                    { 
                        title: "Weekly Focus", 
                        value: formatMinutes(stats.weeklyTime), 
                        icon: 'calendar-week', 
                        color: 'text-red-400',
                        comparison: formatComparison(stats.weeklyTime, stats.prevWeeklyTime, 'week')
                    },
                    { 
                        title: "Monthly Focus", 
                        value: formatMinutes(stats.monthlyTime), 
                        icon: 'calendar', 
                        color: 'text-purple-400',
                        comparison: formatComparison(stats.monthlyTime, stats.prevMonthlyTime, 'month')
                    }
                ];

                D.metricsContainer.innerHTML = metrics.map(metric => `
                    <div class="glass-base p-4 rounded-xl bg-gray-800/40 border-gray-700/50 shadow-md">
                        <div class="flex items-center space-x-2 mb-1">
                            <i data-lucide="${metric.icon}" class="w-5 h-5 ${metric.color}"></i>
                            <h4 class="text-sm font-semibold text-gray-400">${metric.title}</h4>
                        </div>
                        <p class="text-2xl font-bold text-white tabular-nums">${metric.value}</p>
                        ${metric.comparison ? `<p class="text-xs mt-1">${metric.comparison}</p>` : ''}
                    </div>
                `).join('');
                
                window.createLucideIcons();
                
                // RENDER CHART (Placeholder/Simplified implementation)
                renderWeeklyBreakdownChart();
            }

            /** Renders a simple text-based weekly breakdown. (Replace with a proper charting library like Chart.js if desired) */
            function renderWeeklyBreakdownChart() {
                if (stats.weeklyTime === 0) {
                     D.weeklyBreakdownContainer.innerHTML = `<p class="text-center text-gray-400 py-4">No focus time logged this week.</p>`;
                     return;
                }
                
                const daysOfWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                const maxTime = Math.max(...stats.dailyTimeInWeek);

                const chartHtml = stats.dailyTimeInWeek.map((time, index) => {
                    const percentage = maxTime > 0 ? (time / maxTime) * 100 : 0;
                    const barHeight = Math.max(10, percentage); // Minimum height for visibility
                    const minutes = Math.floor(time / 60);

                    return `
                        <div class="flex flex-col items-center">
                            <div class="relative w-full flex justify-center h-24">
                                <div class="absolute bottom-0 w-4 rounded-t-full bg-indigo-500 transition-all duration-500 ease-out" 
                                     style="height: ${barHeight}%;">
                                </div>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">${daysOfWeek[index]}</span>
                            <span class="text-xs font-medium text-gray-300">${minutes}m</span>
                        </div>
                    `;
                }).join('');

                D.weeklyBreakdownContainer.innerHTML = `
                    <div class="flex justify-around items-end h-32 w-full p-2">
                        ${chartHtml}
                    </div>
                `;
            }


            /** Renders the Settings View components. */
            function renderSettingsView() {
                // 1. Daily Goal Input (Already handled by loadState/renderUI but ensure it's up to date)
                if (D.dailyGoalInput) {
                    D.dailyGoalInput.value = state.dailyFocusGoalMinutes;
                }
                
                // 2. Subject Management List
                renderSubjectsListManager();
                
                window.createLucideIcons();
            }

            /** Renders the list of subjects for management in the settings view. */
            function renderSubjectsListManager() {
                D.subjectsListManager.innerHTML = state.subjects.map(subject => {
                    const colorClass = `text-${subject.color}-400`;
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border-l-4 border-current ${colorClass}" style="border-left-color: var(--tw-colors-${subject.color}-600)">
                            <div class="flex items-center">
                                <i data-lucide="book-open" class="w-5 h-5 mr-3 ${colorClass}"></i>
                                <span class="font-medium text-white">${subject.name}</span>
                            </div>
                            <button 
                                onclick="deleteSubject('${subject.id}')" 
                                class="p-2 rounded-full text-red-400 hover:bg-white/10 transition-colors"
                                ${state.subjects.length <= 1 ? 'disabled' : ''}
                            >
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
                }).join('');
                window.createLucideIcons();
            }
            
            // --- FULLSCREEN LOGIC ---

            /** Toggles the fullscreen clock modal. */
            function toggleFullscreenClock() {
                const isHidden = D.fullscreenClockModal.classList.toggle('hidden');
                
                if (!isHidden) {
                    // Update content on show
                    D.fullscreenTimeDisplay.textContent = D.timeDisplay.textContent;
                    D.fullscreenSubjectGoal.textContent = `${state.currentSubject.toUpperCase()} - ${state.sessionGoal || 'No Goal'}`;
                }
                
                updateButtonUI(); // Update fullscreen icon
                window.createLucideIcons();
            }

            // --- INITIALIZATION ---
            
            document.addEventListener('DOMContentLoaded', () => {
                loadState();
                initMusicPlayer(); // Initialize music player on load
                
                // Start timer if it was running when the app closed
                if (state.isRunning) {
                    // Start the interval
                    intervalId = setInterval(updateTimer, 1000);
                    
                    // Restore UI elements to running state
                    updateButtonUI();
                    toggleInputControls(true);
                    
                    // If Pomodoro mode, continue with the Pomodoro logic
                    if (state.isPomodoroActive) {
                        D.timerTitle.textContent = `Pomodoro: ${state.pomodoroMode === 'focus' ? 'Focus Time' : 'Break Time'}`;
                    }
                } else {
                    // If not running, ensure display reflects current time elapsed or Pomodoro start time
                    const timeToDisplay = state.isPomodoroActive ? state.pomodoroTimeRemaining : state.timeElapsed;
                    D.timeDisplay.textContent = formatTime(timeToDisplay, !state.isPomodoroActive);
                    // Also ensure Pomodoro title is correct on load
                    if (state.isPomodoroActive) {
                        const modeText = state.pomodoroMode === 'focus' ? 'Focus Time' : 'Break Time';
                        D.timerTitle.textContent = `Pomodoro: ${modeText}`;
                    }
                }
                
                // Ensure task input has the session goal if a session was paused
                if (state.sessionGoal) {
                    D.taskInput.value = state.sessionGoal;
                }

                // Initial render of the correct view
                switchPage(state.currentPage); 
                renderUI(); // Render the timer view specifics
                
                // Add handlers to global elements
                document.getElementById('start-pause-btn').onclick = startPauseHandler;
                document.getElementById('reset-btn').onclick = resetTimer;
                document.getElementById('pomodoro-btn').onclick = togglePomodoro;
                document.getElementById('fullscreen-btn').onclick = toggleFullscreenClock;
                document.getElementById('music-btn').onclick = toggleSongPlayback;

                // Create initial icons
                window.createLucideIcons();
            });
    </script>
</body>
</html>
