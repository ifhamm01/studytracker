<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focused Subject Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Expose a simple wrapper to create icons using the global 'lucide' object
        window.createLucideIcons = () => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        };
    </script>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>"></link>
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        
        /* Custom styles for Glassmorphism base */
        .glass-base {
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Base shadow */
        }
        
        .glass-base:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* Lifted shadow on hover */
        }

        /* Styling for the subject radio buttons */
        .subject-radio:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #a5b4fc; /* indigo-300 */
            color: #fff;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); /* Blue glow */
        }
        
        /* Custom checkbox style */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            border: 2px solid #6b7280; /* gray-500 */
            border-radius: 0.25rem;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="checkbox"]:checked {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            display: block;
            color: white;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.1;
        }
        
        /* Custom media query for fullscreen display font size on smaller screens */
        @media (max-width: 768px) {
            #fullscreen-time-display {
                font-size: 8rem;
            }
        }
        @media (max-width: 480px) {
            #fullscreen-time-display {
                font-size: 6rem;
            }
        }

    </style>
  
</head>
<body class="text-white min-h-screen">
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-400">Study Tracker</h1>
        </header>

       
            
            <nav class="flex space-x-2 mb-6 p-1 bg-gray-800 rounded-full overflow-x-auto">
                <button id="nav-timer-btn" onclick="switchPage('timer')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-indigo-600">
                    <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i> Timer
                </button>
                <button id="nav-tasks-btn" onclick="switchPage('tasks')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="list-todo" class="w-4 h-4 inline mr-1"></i> Tasks
                </button>
                <button id="nav-history-btn" onclick="switchPage('history')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> History
                </button>
                <button id="nav-achievements-btn" onclick="switchPage('achievements')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="medal" class="w-4 h-4 inline mr-1"></i> Achievements
                </button>
                <button id="nav-progress-btn" onclick="switchPage('progress')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="trending-up" class="w-4 h-4 inline mr-1"></i> Progress
                </button>
                <button id="nav-settings-btn" onclick="switchPage('settings')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> Settings
                </button>
            </nav>
 <main class="glass-base rounded-3xl p-5 sm:p-6 lg:p-8 shadow-2xl bg-gray-900/40">
                  <div id="timer-view">
            
            <div id="timer-card" class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h1 id="timer-title" class="text-2xl font-bold text-indigo-300">Focused Subject Tracker</h1>
                    
                    
                    <button 
                        id="noise-btn" 
                        onclick="toggleBrownNoise()" 
                        class="p-2 rounded-full text-gray-400 hover:bg-white/10 transition-colors"
                    >
                        <i data-lucide="volume-2" class="w-6 h-6"></i>
                    </button>
                </div>
                
                
                <div class="text-center mb-6">
                    
                    <p id="time-display" class="text-7xl lg:text-8xl font-extrabold tabular-nums tracking-tighter">
                        00:00:00
                    </p>
                </div>
                
                
                <div class="mb-8 flex flex-col sm:flex-row justify-center items-center sm:space-x-6 space-y-4 sm:space-y-0 py-2">
                    
                    <div class="relative w-24 h-24 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 70 70">
                            
                            <circle 
                                class="text-gray-700/50" 
                                stroke-width="6" 
                                stroke="currentColor" 
                                fill="transparent" 
                                r="30" 
                                cx="35" 
                                cy="35"
                            ></circle>
                            
                            <circle 
                                id="streak-progress-bar"
                                class="text-emerald-400 transition-all duration-700 ease-out" 
                                stroke-width="6" 
                                stroke="currentColor" 
                                stroke-linecap="round" 
                                fill="transparent" 
                                r="30" 
                                cx="35" 
                                cy="35"
                                style="stroke-dasharray: 188.5; stroke-dashoffset: 188.5;"
                            ></circle>
                        </svg>
                        <span id="streak-progress-percent" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-gray-300">0%</span>
                    </div>

                    
                    <div class="flex-grow text-center sm:text-left">
                        <div class="text-sm text-gray-400 mb-1">Total Focus Streaks (10h each)</div>
                        <div class="flex items-center justify-center sm:justify-start">
                            <i data-lucide="medal" class="w-8 h-8 mr-3 text-amber-400"></i>
                            <span id="streak-count" class="text-5xl font-extrabold text-amber-300 tabular-nums">0</span>
                        </div>
                        <div id="next-streak-info" class="text-xs text-gray-500 mt-2">
                            Next: 10:00:00 remaining
                        </div>
                    </div>
                </div>

                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-300">
                        Select Subject
                    </label>
                    <div id="subject-selector" class="flex flex-wrap gap-2 sm:flex-row sm:space-x-2 sm:gap-0">
                        
                    </div>
                </div>

                
                <div class="mb-8">
                    <label for="task-input" class="block text-sm font-medium mb-2 text-gray-300">
                        Session Goal
                    </label>
                    <div class="flex items-center bg-white/10 rounded-full p-3">
                        <i data-lucide="target" class="w-5 h-5 mr-3 text-indigo-400 flex-shrink-0"></i>
                        <input 
                            id="task-input"
                            type="text"
                            placeholder="What do you want to accomplish?"
                            class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                        >
                    </div>
                </div>

                
                <div class="flex justify-center space-x-4">
                    <button id="start-pause-btn" onclick="startPauseHandler()" class="p-4 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 bg-green-500 hover:bg-green-600">
                        <i data-lucide="play" class="w-6 h-6"></i>
                    </button>
                    
                    <button id="reset-btn" onclick="resetTimer()" disabled class="p-4 rounded-full bg-gray-700/50 hover:bg-gray-600/70 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
                    </button>
                    
                    
                    <button id="pomodoro-btn" onclick="togglePomodoro()" class="p-4 rounded-full bg-gray-700/50 hover:bg-gray-600/70 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="timer" class="w-6 h-6"></i>
                    </button>

                    
                    <button id="fullscreen-btn" onclick="toggleFullscreenClock()" class="p-4 rounded-full bg-indigo-600/70 hover:bg-indigo-600 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="maximize" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            
            <div class="glass-base mt-8 p-4 rounded-3xl shadow-xl bg-gray-800/50 border-gray-700/50">
                <h2 class="text-xl font-semibold mb-3 text-center text-gray-300 flex items-center justify-center">
                    <i data-lucide="history" class="w-5 h-5 mr-2 text-gray-400"></i>
                    Recent Focus Sessions
                </h2>
                <div id="history-list" class="max-h-48 overflow-y-auto space-y-2">
                    
                </div>
                <p id="no-history" class="text-center text-gray-500 text-sm py-4 hidden">No sessions logged yet.</p>
            </div>
        </div>
        
        
        <div id="tasks-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-4">Task List</h1>
                
                
                <div class="mb-6 flex space-x-3">
                    <div class="flex items-center bg-white/10 rounded-full p-3 flex-grow">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-3 text-emerald-400 flex-shrink-0"></i>
                        <input 
                            id="new-task-input"
                            type="text"
                            placeholder="Add a new task..."
                            class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') addTask()"
                        >
                    </div>
                    <button onclick="addTask()" class="p-3 rounded-full bg-emerald-600 hover:bg-emerald-700 transition-colors flex-shrink-0">
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </div>

                
                <div id="tasks-list" class="space-y-3 max-h-96 overflow-y-auto">
                    
                </div>
            </div>
        </div>
        
        
        <div id="history-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-4">Daily Focus History</h1>
                
                <div class="mb-6">
                    <label for="date-selector" class="block text-sm font-medium mb-2 text-gray-300">Select Day</label>
                    <select 
                        id="date-selector" 
                        onchange="handleDateChange(this.value)" 
                        class="w-full p-3 rounded-full bg-gray-700 border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        <option value="">No sessions logged</option>
                    </select>
                </div>

                <div id="daily-summary-container" class="space-y-6">
                    
                    <p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>
                </div>
            </div>
        </div>
        
        <div id="achievements-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-emerald-300 mb-6">Trophy Case</h1>
                <p class="text-gray-400 mb-6">Earn single-level achievements by hitting focus and task milestones.</p>
                <div id="trophies-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            </div>
        </div>
        
        <div id="progress-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-6">Cumulative Progress</h1>
                <p class="text-gray-400 mb-6">Track your long-term statistics and compare performance week-over-week.</p>
                <div id="metrics-container" class="grid grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                    
                </div>
                
                <h2 class="text-xl font-semibold text-gray-300 mt-8 mb-4 border-b border-gray-700 pb-2 flex items-center">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> Weekly Focus Breakdown (Area Chart)
                </h2>
                <div id="weekly-breakdown-container" class="p-4 bg-gray-900/40 rounded-xl">
                    <p class="text-center text-gray-400">Loading weekly data...</p>
                </div>
            </div>
        </div>

        
        <div id="settings-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-yellow-300 mb-6">Application Settings</h1>
                
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="book-open-check" class="w-5 h-5 mr-2"></i> Subject Management
                    </h2>
                    
                    
                    <div class="mb-6 flex space-x-3">
                        <div class="flex items-center bg-white/10 rounded-full p-3 flex-grow">
                            <i data-lucide="book-open" class="w-5 h-5 mr-3 text-yellow-400 flex-shrink-0"></i>
                            <input 
                                id="new-subject-input"
                                type="text"
                                placeholder="Enter new subject name (e.g., History)"
                                class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                                onkeypress="if(event.key === 'Enter') addSubjectHandler()"
                            >
                        </div>
                        <button onclick="addSubjectHandler()" class="p-3 rounded-full bg-yellow-600 hover:bg-yellow-700 transition-colors flex-shrink-0">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>

                    
                    <div id="subjects-list-manager" class="space-y-3 max-h-96 overflow-y-auto pt-2">
                        
                    </div>
                </div>
            </div>
        </div>


    </div>

    
    <div id="details-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
        <div class="w-full max-w-md bg-gray-900 border border-indigo-600/50 rounded-xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-3 text-indigo-400 flex items-center">
                <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                Session Details
            </h3>
            <p id="modal-content" class="text-gray-300 whitespace-pre-wrap"></p>
            <button 
                onclick="document.getElementById('details-modal').classList.add('hidden')"
                class="w-full mt-4 flex items-center justify-center p-3 rounded-full font-semibold text-lg transition-colors bg-indigo-600 hover:bg-indigo-700"
            >
                Close
            </button>
        </div>
    </div>
    
    
    <div id="fullscreen-clock-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-4">
        
        <button 
            onclick="toggleFullscreenClock()" 
            class="absolute top-6 right-6 p-3 rounded-full text-white bg-white/10 hover:bg-white/20 transition-colors z-50"
        >
            <i data-lucide="minimize" class="w-8 h-8"></i>
        </button>
        
        <div class="text-center">
            <p id="fullscreen-time-display" class="text-white text-[12rem] lg:text-[18rem] xl:text-[25rem] font-extrabold tabular-nums tracking-tighter transition-colors">
                00:00:00
            </p>
            <p id="fullscreen-subject-goal" class="text-4xl font-semibold text-indigo-400 mt-4 text-center break-words max-w-full px-4 sm:px-0"></p>
        </div>
        
    </div>
    


    <script>
            // --- GLOBAL STATE & CONSTANTS ---
            const LOCAL_STORAGE_KEY = 'subjectTrackerData';
            const STREAK_GOAL_SECONDS = 10 * 3600; // 10 hours
            const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 30; // Radius 30 from SVG
            
            // --- POMODORO CONSTANTS ---
            const POMODORO_FOCUS_SECONDS = 55 * 60; // 55 minutes
            const POMODORO_BREAK_SECONDS = 5 * 60;  // 5 minutes
            
            // Subject colors and default list
            const SUBJECT_COLORS = ['indigo', 'emerald', 'sky', 'yellow', 'red', 'purple', 'teal', 'pink'];
            
            const DEFAULT_SUBJECTS = [
                { id: 'physics', name: 'Physics', color: 'indigo' },
                { id: 'chemistry', name: 'Chemistry', color: 'emerald' },
                { id: 'math', name: 'Math', color: 'sky' },
                { id: 'other', name: 'Other', color: 'yellow' },
                { id: 'lang', name: 'Language', color: 'red' }, 
            ];
            
     // --- NEW ACHIEVEMENT/PROGRESS CONFIG (Flattened Structure) ---
            const ACHIEVEMENTS_CONFIG = [
                // Focused Time Trophies (unit: 'minutes')
                { 
                    id: 'focused_hour_easy', 
                    icon: 'hourglass', 
                    name: 'First Step (1h)',
                    unit: 'minutes',
                    description: 'Log one hour of focused time.',
                    goal: 60, // Single goal
                    color: 'text-amber-300'
                },
                { 
                    id: 'focused_hour_medium', 
                    icon: 'hourglass', 
                    name: 'Time Manager (5h)', 
                    unit: 'minutes',
                    description: 'Log five hours of focused time.',
                    goal: 300, 
                    color: 'text-gray-300'
                },
                { 
                    id: 'focused_hour_hard', 
                    icon: 'hourglass', 
                    name: 'Flow State Master (20h)', 
                    unit: 'minutes',
                    description: 'Log twenty hours of focused time.',
                    goal: 1200, 
                    color: 'text-indigo-400'
                },

                // Tasks Done Trophies (unit: 'tasks')
                { 
                    id: 'tasks_done_easy', 
                    icon: 'check-circle', 
                    name: 'Getting Things Done (5)', 
                    unit: 'tasks',
                    description: 'Complete 5 tasks.',
                    goal: 5, 
                    color: 'text-amber-300'
                },
                { 
                    id: 'tasks_done_medium', 
                    icon: 'check-circle', 
                    name: 'Productivity Pro (20)', 
                    unit: 'tasks',
                    description: 'Complete 20 tasks.',
                    goal: 20, 
                    color: 'text-gray-300'
                },
                { 
                    id: 'tasks_done_hard', 
                    icon: 'check-circle', 
                    name: 'Executioner (50)', 
                    unit: 'tasks',
                    description: 'Complete 50 tasks.',
                    goal: 50, 
                    color: 'text-indigo-400'
                }
            ];

            const DEFAULT_STATE = {
                isRunning: false,
                timeElapsed: 0,
                startTime: null,
                subjects: DEFAULT_SUBJECTS, // DYNAMIC SUBJECTS
                currentSubject: DEFAULT_SUBJECTS[0].id,
                sessionGoal: '',
                sessions: [],
                tasks: [], 
                currentPage: 'timer',
                totalFocusTime: 0,
                streakCount: 0,
                isPomodoroActive: false,
                pomodoroMode: 'focus', 
                pomodoroTimeRemaining: POMODORO_FOCUS_SECONDS,
            };

            let state = { ...DEFAULT_STATE };
            let intervalId = null;
            let audioContext = null;
            let brownNoiseGenerator = null;
            let isNoisePlaying = false;
            
            // Stats object for achievements and progress calculation
            let stats = {
                overallTime: 0,
                monthlyTime: 0,
                weeklyTime: 0,
                prevMonthlyTime: 0, 
                prevWeeklyTime: 0,
                dailyTimeInWeek: Array(7).fill(0), // Focus time for each day of the current week (Mon-Sun)
                tasksCompleted: 0,
                totalTasks: 0,
                efficiency: 0,
                avgDailyHours: 0,
                avgSessionLengthSeconds: 0,
                achievements: {},
            };


            // --- DOM ELEMENTS (Scoped by convention) ---
            const D = {
                // Timer View elements
                timerTitle: document.getElementById('timer-title'),
                timeDisplay: document.getElementById('time-display'),
                taskInput: document.getElementById('task-input'),
                startPauseBtn: document.getElementById('start-pause-btn'),
                resetBtn: document.getElementById('reset-btn'),
                noiseBtn: document.getElementById('noise-btn'),
                pomodoroBtn: document.getElementById('pomodoro-btn'),
                historyList: document.getElementById('history-list'),
                noHistory: document.getElementById('no-history'),
                subjectSelector: document.getElementById('subject-selector'),
                detailsModal: document.getElementById('details-modal'),
                modalContent: document.getElementById('modal-content'),
                
                // Streak elements
                streakProgressBar: document.getElementById('streak-progress-bar'),
                streakProgressPercent: document.getElementById('streak-progress-percent'),
                streakCount: document.getElementById('streak-count'),
                nextStreakInfo: document.getElementById('next-streak-info'),

                // Navigation and View containers
                timerView: document.getElementById('timer-view'),
                tasksView: document.getElementById('tasks-view'),
                historyView: document.getElementById('history-view'), 
                achievementsView: document.getElementById('achievements-view'), 
                progressView: document.getElementById('progress-view'), 
                settingsView: document.getElementById('settings-view'), // NEW SETTINGS VIEW
                navTimerBtn: document.getElementById('nav-timer-btn'),
                navTasksBtn: document.getElementById('nav-tasks-btn'),
                navHistoryBtn: document.getElementById('nav-history-btn'),
                navAchievementsBtn: document.getElementById('nav-achievements-btn'), 
                navProgressBtn: document.getElementById('nav-progress-btn'), 
                navSettingsBtn: document.getElementById('nav-settings-btn'), // NEW SETTINGS BUTTON
                
                // Tasks UI elements
                taskInputNew: document.getElementById('new-task-input'),
                tasksListContainer: document.getElementById('tasks-list'),

                // History UI elements
                dateSelector: document.getElementById('date-selector'),
                dailySummaryContainer: document.getElementById('daily-summary-container'),
                
                // Achievements UI elements 
                trophiesContainer: document.getElementById('trophies-container'),
                metricsContainer: document.getElementById('metrics-container'), 
                weeklyBreakdownContainer: document.getElementById('weekly-breakdown-container'), 
                
                // Fullscreen Clock elements
                fullscreenClockModal: document.getElementById('fullscreen-clock-modal'),
                fullscreenTimeDisplay: document.getElementById('fullscreen-time-display'),
                fullscreenSubjectGoal: document.getElementById('fullscreen-subject-goal'),
                fullscreenBtn: document.getElementById('fullscreen-btn'),
                
                // Settings UI elements
                newSubjectInput: document.getElementById('new-subject-input'),
                subjectsListManager: document.getElementById('subjects-list-manager'),
            };

            // --- LOCAL STORAGE LOGIC ---

            /** Loads state from localStorage or initializes default state. */
         function loadState() {
                try {
                    const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (storedState) {
                        const loadedState = JSON.parse(storedState);
                        // Merge loaded state, ensuring new properties have defaults if missing
                        state = { ...DEFAULT_STATE, ...loadedState };
                        
                        // Re-calculate timeElapsed/pomodoroTimeRemaining if the timer was running when closed
                        if (state.isRunning && state.startTime) {
                            const timeSinceStart = (Date.now() - state.startTime) / 1000;
                            
                            if (state.isPomodoroActive) {
                                // For Pomodoro, subtract the time difference from remaining time
                                state.pomodoroTimeRemaining = Math.max(0, state.pomodoroTimeRemaining - timeSinceStart);
                            } else {
                                // For free-form, add the time difference to elapsed time
                                state.timeElapsed += timeSinceStart;
                            }
                            // state.isRunning = false; // <-- REMOVED THIS LINE
                        }
                    }
                } catch (error) {
                    console.error("Error loading state from localStorage:", error);
                    state = { ...DEFAULT_STATE };
                }
                // Calculate initial stats after loading
                calculateAllStats();
            }

            /** Saves the current essential state to localStorage. */
            function saveState() {
                try {
                    const stateToSave = {
                        isRunning: state.isRunning,
                        timeElapsed: state.timeElapsed,
                        startTime: state.startTime,
                        currentSubject: state.currentSubject,
                        sessionGoal: D.taskInput ? D.taskInput.value : state.sessionGoal,
                        sessions: state.sessions,
                        tasks: state.tasks,
                        currentPage: state.currentPage,
                        totalFocusTime: state.totalFocusTime,
                        streakCount: state.streakCount,
                        isPomodoroActive: state.isPomodoroActive,
                        pomodoroMode: state.pomodoroMode,
                        pomodoroTimeRemaining: state.pomodoroTimeRemaining,
                        subjects: state.subjects, // SAVE DYNAMIC SUBJECTS
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
                } catch (error) {
                    console.error("Error saving state to localStorage:", error);
                }
            }
            
            // --- TIME & DATE UTILITIES ---

            /** Formats seconds into H:MM:SS string. */
            function formatTime(totalSeconds, includeHours) {
                const totalSec = Math.max(0, Math.floor(totalSeconds)); // Ensure it's not negative
                const hours = Math.floor(totalSec / 3600);
                const minutes = Math.floor((totalSec % 3600) / 60);
                const seconds = Math.floor(totalSec % 60);

                const minutesStr = minutes.toString().padStart(2, '0');
                const secondsStr = seconds.toString().padStart(2, '0');

                if (includeHours || hours > 0) {
                    const hoursStr = hours.toString().padStart(2, '0');
                    return `${hoursStr}:${minutesStr}:${secondsStr}`;
                }
                return `${minutesStr}:${secondsStr}`;
            }
            
            // Helper for formatting time in minutes/hours
            const formatMinutes = (seconds) => {
                const totalMinutes = Math.floor(seconds / 60);
                if (totalMinutes < 60) return `${totalMinutes} min`;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m`;
            };
            
            // Helper for weekly/monthly comparisons
            function formatComparison(current, previous, unit) {
                if (previous === 0) {
                    return `<span class="text-gray-400">No previous ${unit} data</span>`;
                }
                const change = current - previous;
                const percentChange = (change / previous) * 100;
                const formattedPercent = Math.abs(percentChange).toFixed(0);

                let icon = 'minus'; 
                let color = 'text-gray-400';
                let direction = 'No change';

                if (Math.abs(percentChange) < 1) { // Treat very small change as 'No change'
                     return `<span class="text-gray-400">Same as last ${unit}</span>`;
                }
                
                if (percentChange > 0) {
                    icon = 'arrow-up-right';
                    color = 'text-emerald-400';
                    direction = 'Up';
                } else if (percentChange < 0) {
                    icon = 'arrow-down-right';
                    color = 'text-red-400';
                    direction = 'Down';
                } 

                return `<span class="${color} flex items-center">
                            <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i> 
                            ${direction} ${formattedPercent}%
                        </span>`;
            }

            /** Extracts the date part (YYYY-MM-DD) from an ISO string. */
            function getFormattedDate(isoString) {
                if (!isoString) return null;
                // Safely handles both 'YYYY-MM-DDTHH:MM:SS...' and 'YYYY-MM-DD'
                return isoString.split('T')[0];
            }
            
            /** Converts YYYY-MM-DD to a more readable format (e.g., Oct 18, 2025) */
            function formatDateForDisplay(dateKey) {
                const date = new Date(dateKey + 'T00:00:00'); // Use T00:00:00 to prevent timezone issues
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    timeZone: 'UTC' // Important for consistent date rendering
                });
            }
            
            // UPDATED to use state.subjects
            function getSubjectColorClass(subjectId) {
                const subject = state.subjects.find(s => s.id === subjectId);
                return subject ? `text-${subject.color}-400` : 'text-gray-400';
            }
            
            /** Get the start of the specified period (month/week/prevMonth/prevWeek) */
            function getPeriodStart(period, referenceDate = new Date()) {
                const date = new Date(referenceDate.getTime());
                date.setHours(0, 0, 0, 0); 
                
                if (period === 'week') {
                    // Set to the start of the current week (Monday)
                    const day = date.getDay() || 7; // Convert 0 (Sunday) to 7
                    date.setDate(date.getDate() - day + 1); 
                    return date;
                } else if (period === 'prevWeek') {
                    const startOfWeek = getPeriodStart('week', referenceDate);
                    startOfWeek.setDate(startOfWeek.getDate() - 7);
                    return startOfWeek;
                } else if (period === 'month') {
                    // Set to the 1st day of the current month
                    date.setDate(1);
                    return date;
                } else if (period === 'prevMonth') {
                    // Set to the 1st day of the month before the current one
                    date.setDate(1);
                    date.setMonth(date.getMonth() - 1);
                    return date;
                }
                // Return a very old date for overall calculation
                return new Date(0); 
            }

            // --- ACHIEVEMENT/PROGRESS CALCULATION LOGIC ---
            
            function calculateAllStats() {
                const now = new Date();
                // Set the current date to midnight for consistent comparison (Local time)
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                
                const startOfWeek = getPeriodStart('week', now).getTime();
                const startOfPrevWeek = getPeriodStart('prevWeek', now).getTime();
                const startOfMonth = getPeriodStart('month', now).getTime();
                const startOfPrevMonth = getPeriodStart('prevMonth', now).getTime();
                
                let overallTime = 0;
                let monthlyTime = 0;
                let prevMonthlyTime = 0;
                let weeklyTime = 0;
                let prevWeeklyTime = 0;
                
                let dailyTimeInWeek = Array(7).fill(0);
                let totalSessionsCount = 0; 
                
                // 1. Calculate Time Metrics
                state.sessions.forEach(session => {
                    const sessionTime = new Date(session.timestamp).getTime();
                    const duration = session.durationSeconds;
                    
                    overallTime += duration;
                    totalSessionsCount += 1; 
                    
                    if (sessionTime >= startOfMonth) {
                        monthlyTime += duration;
                    }
                    if (sessionTime >= startOfPrevMonth && sessionTime < startOfMonth) {
                        prevMonthlyTime += duration;
                    }
                    if (sessionTime >= startOfWeek) {
                        weeklyTime += duration;
                        // Calculate day index (0=Mon, 6=Sun)
                        const date = new Date(sessionTime);
                        const day = date.getDay(); // 0=Sun, 6=Sat
                        const dayIndex = (day === 0 ? 6 : day - 1); // Convert 0 to 6, 1-6 to 0-5
                        dailyTimeInWeek[dayIndex] += duration;
                    }
                    if (sessionTime >= startOfPrevWeek && sessionTime < startOfWeek) {
                        prevWeeklyTime += duration;
                    }
                });

                // 2. Calculate Task Metrics
                const totalTasks = state.tasks.length;
                const tasksCompleted = state.tasks.filter(t => t.completed).length;
                const efficiency = totalTasks > 0 ? Math.round((tasksCompleted / totalTasks) * 100) : 0;
                
                // 3. Calculate Overall Average Study Hours
                const firstSessionTimestamp = state.sessions.length > 0 
                    ? Math.min(...state.sessions.map(s => new Date(s.timestamp).getTime()))
                    : Date.now();
                
                // Calculate days since the first session, rounding up to 1 if it's the first day
                const daysSinceStart = Math.ceil((startOfToday - new Date(firstSessionTimestamp).setHours(0,0,0,0)) / (1000 * 3600 * 24)) || 1;
                const avgDailyHours = overallTime / 3600 / daysSinceStart;

                // Calculate Average Session Length
                const avgSessionLengthSeconds = totalSessionsCount > 0 ? overallTime / totalSessionsCount : 0; 

                // 4. Update stats object
                stats.overallTime = overallTime;
                stats.monthlyTime = monthlyTime;
                stats.weeklyTime = weeklyTime;
                stats.prevMonthlyTime = prevMonthlyTime; 
                stats.prevWeeklyTime = prevWeeklyTime;
                stats.dailyTimeInWeek = dailyTimeInWeek; 
                stats.tasksCompleted = tasksCompleted;
                stats.totalTasks = totalTasks;
                stats.efficiency = efficiency;
                stats.avgDailyHours = avgDailyHours; 
                stats.avgSessionLengthSeconds = avgSessionLengthSeconds; 
                
                // 5. Check Achievements
                stats.achievements = checkAchievementStatus(overallTime, tasksCompleted);

                return stats;
            }

            function checkAchievementStatus(overallTimeSeconds, tasksCompletedCount) {
                const status = {};
                const overallTimeMinutes = Math.floor(overallTimeSeconds / 60);

                ACHIEVEMENTS_CONFIG.forEach(ach => {
                    let progressValue;
                    
                    if (ach.unit === 'minutes') {
                        progressValue = overallTimeMinutes;
                    } else if (ach.unit === 'tasks') {
                        progressValue = tasksCompletedCount;
                    }
                    
                    const isComplete = progressValue >= ach.goal;
                    
                    // Progress is calculated towards the single goal
                    const percentage = ach.goal > 0 ? Math.min(100, (progressValue / ach.goal) * 100) : 100;

                    status[ach.id] = {
                        progress: progressValue,
                        goal: ach.goal, // Store the single goal
                        isComplete: isComplete,
                        percentage: percentage,
                    };
                });
                return status;
            }
            
            // --- BROWN NOISE GENERATION ---
            
            /** Creates a brown noise AudioBufferSourceNode. */
            function createBrownNoiseGenerator() {
                const bufferSize = 4096;
                const sampleRate = audioContext.sampleRate;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, sampleRate);
                const output = noiseBuffer.getChannelData(0);
                let lastOut = 0.0;
                
                // Brown/Red noise generation (integrate white noise)
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.02 * white)) / 1.02; // Simple integration
                    lastOut = output[i];
                    output[i] *= 3.5; // Apply volume boost
                }
                
                const source = audioContext.createBufferSource();
                source.buffer = noiseBuffer;
                source.loop = true;
                
                // Create a GainNode for volume control (optional but good practice)
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0.05; // Set volume low, brown noise is loud
                
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                return source;
            }
            
            /** Toggles the playback of brown noise. */
            function toggleBrownNoise() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                if (isNoisePlaying) {
                    // Stop the noise
                    if (brownNoiseGenerator) {
                        try {
                            // Ensure the node is stopped and disconnected
                            brownNoiseGenerator.stop();
                            brownNoiseGenerator.disconnect();
                        } catch (e) {
                            console.error("Error stopping brown noise:", e);
                        }
                        brownNoiseGenerator = null; // Clear the reference
                    }
                } else {
                    // Start the noise
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    // Create a new generator and start it
                    brownNoiseGenerator = createBrownNoiseGenerator();
                    brownNoiseGenerator.start();
                }

                isNoisePlaying = !isNoisePlaying;
                renderUI();
            };
            
            // --- POMODORO LOGIC ---

            /** Toggles Pomodoro mode on/off. */
            function togglePomodoro() {
                if (state.isRunning) {
                    // Use custom modal instead of alert
                    const modal = D.detailsModal;
                    D.modalContent.textContent = "Stop the current session before switching timer modes.";
                    modal.classList.remove('hidden');
                    return;
                }
                state.isPomodoroActive = !state.isPomodoroActive;

                // When enabling, reset the time to the start of the focus period
                if (state.isPomodoroActive) {
                    state.timeElapsed = 0; // Clear free-form time
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                } else {
                    // When disabling, reset countdown time
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                }

                renderUI();
                saveState();
            };

            /** Handles the end of a focus or break period. */
            function handlePomodoroCompletion() {
                // Log session if coming from focus mode
                if (state.pomodoroMode === 'focus') {
                    // Log the fixed 55 minutes, regardless of when the user paused/stopped right at the end
                    logSession(POMODORO_FOCUS_SECONDS); 
                    
                    // Transition to break mode
                    state.pomodoroMode = 'break';
                    state.pomodoroTimeRemaining = POMODORO_BREAK_SECONDS;
                    
                    // Notify user
                    const modal = D.detailsModal;
                    D.modalContent.textContent = "Time for a 5-minute break! Click Start when you're ready to focus again.";
                    modal.classList.remove('hidden');

                } else { // pomodoroMode === 'break'
                    // Transition back to focus mode
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                    
                    // Notify user
                    const modal = D.detailsModal;
                    D.modalContent.textContent = "Break time is over. Start your next 55-minute focus session!";
                    modal.classList.remove('hidden');
                }
                
                // Automatically pause after completion
                stopTimer();

                renderUI();
                saveState();
            }

            // --- TIMER LOGIC (MODIFIED FOR POMODORO) ---

            function startTimer() {
                if (state.isRunning) return;
                if (state.currentPage !== 'timer') return; 

                // If Pomodoro is active, only proceed if we have time remaining
                if (state.isPomodoroActive && state.pomodoroTimeRemaining <= 0) {
                    handlePomodoroCompletion(); // Should trigger transition and pause
                    return;
                }
                
                if ((!state.isPomodoroActive || state.pomodoroMode === 'focus') && !D.taskInput.value.trim() && state.timeElapsed === 0) {
                    console.warn("Starting session without a goal set.");
                }

                if (!state.startTime) {
                    state.startTime = Date.now();
                }

                state.isRunning = true;
                clearInterval(intervalId);
                
                intervalId = setInterval(() => {
                    if (!state.isRunning) {
                        clearInterval(intervalId);
                        return;
                    }

                    const now = Date.now();
                    
                    if (state.isPomodoroActive) {
                        // POMODORO COUNTDOWN LOGIC
                        state.pomodoroTimeRemaining -= 1; 

                        if (state.pomodoroTimeRemaining <= 0) {
                            handlePomodoroCompletion();
                        }
                        
                    } else {
                        // FREE-FORM TIMER COUNT UP LOGIC
                        const delta = (now - state.startTime) / 1000;
                        state.timeElapsed += delta; 
                    }
                    
                    state.startTime = now; 

                    renderUI();
                    saveState(); 
                }, 1000); 
                
                renderUI();
                saveState();
            }

            function stopTimer() {
                if (!state.isRunning) return;

                clearInterval(intervalId);
                state.isRunning = false;

                if (state.isPomodoroActive) {
                    // For Pomodoro, stopping just pauses the countdown.
                } else { 
                    // For Free-Form, check duration and log.
                    if (state.timeElapsed >= 5) {
                        logSession();
                    } else {
                        // If session is too short, reset goal and time but don't log.
                        D.taskInput.value = '';
                        state.timeElapsed = 0;
                    }
                }
                renderUI();
                saveState();
            }

            function resetTimer() {
                if (state.isRunning) stopTimer();

                clearInterval(intervalId);
                state.timeElapsed = 0;
                state.startTime = null;
                D.taskInput.value = '';
                state.isRunning = false;
                
                // Reset ALL timer states
                state.isPomodoroActive = false;
                state.pomodoroMode = 'focus';
                state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;

                // Stop brown noise if it.s playing
                if (isNoisePlaying) {
                    toggleBrownNoise();
                }

                renderUI();
                saveState();
                calculateAllStats(); // Recalculate stats
            }

            function logSession(fixedDuration = null) {
                const subject = state.subjects.find(s => s.id === state.currentSubject);
                // Determine duration: Use fixedDuration (for Pomodoro focus) or elapsed time (for free-form)
                const duration = fixedDuration !== null ? fixedDuration : Math.floor(state.timeElapsed);

                // Only log if the session was at least 5 seconds long (or a full Pomodoro block)
                if (duration < 5 && fixedDuration === null) return;

                const sessionLog = {
                    id: Date.now(),
                    subject: subject ? subject.name : 'Unknown Subject',
                    subjectId: subject ? subject.id : 'unknown',
                    durationSeconds: duration,
                    goal: D.taskInput.value.trim() || 'No Goal Set',
                    timestamp: new Date().toISOString(),
                };

                // --- STREAK LOGIC ---
                const previousTotalFocus = state.totalFocusTime;
                state.totalFocusTime += sessionLog.durationSeconds;
                const previousStreakCount = Math.floor(previousTotalFocus / STREAK_GOAL_SECONDS);

                // Check if we crossed a 10-hour boundary
                if (state.totalFocusTime >= STREAK_GOAL_SECONDS * (previousStreakCount + 1)) {
                    state.streakCount = Math.floor(state.totalFocusTime / STREAK_GOAL_SECONDS);
                }

                // Add session log
                state.sessions.unshift(sessionLog);
                state.sessions = state.sessions.slice(0, 50); // Keep max 50 recent sessions

                // Reset timer UI state (only free-form timer)
                if (!state.isPomodoroActive) {
                    state.timeElapsed = 0;
                    state.startTime = null;
                }
                // Goal input is reset after any successful log
                D.taskInput.value = ''; 

                // Recalculate stats for Achievements/Progress
                calculateAllStats();
                renderHistory();
            }

            // --- PAGE SWITCHING & UI RENDERING ---

            function switchPage(pageId) {
                if (state.isRunning) {
                    console.warn("Please stop the timer before switching views.");
                    // Use custom modal instead of alert
                    const modal = D.detailsModal;
                    D.modalContent.textContent = "Please stop the timer before switching views.";
                    modal.classList.remove('hidden');
                    return;
                }
                state.currentPage = pageId;
                saveState();
                renderViews();
                window.createLucideIcons();
            }

            function renderViews() {
                // Hide all and show the selected view
                D.timerView.classList.add('hidden');
                D.tasksView.classList.add('hidden');
                D.historyView.classList.add('hidden');
                D.achievementsView.classList.add('hidden');
                D.progressView.classList.add('hidden'); 
                D.settingsView.classList.add('hidden'); // New setting view

                // Reset nav button styles
                [D.navTimerBtn, D.navTasksBtn, D.navHistoryBtn, D.navAchievementsBtn, D.navProgressBtn, D.navSettingsBtn].forEach(btn => { 
                    btn.classList.remove('bg-indigo-600');
                    btn.classList.add('bg-gray-700/50');
                });

                switch (state.currentPage) {
                    case 'timer':
                        D.timerView.classList.remove('hidden');
                        D.navTimerBtn.classList.remove('bg-gray-700/50');
                        D.navTimerBtn.classList.add('bg-indigo-600');
                        break;
                    case 'tasks':
                        D.tasksView.classList.remove('hidden');
                        D.navTasksBtn.classList.remove('bg-gray-700/50');
                        D.navTasksBtn.classList.add('bg-indigo-600');
                        renderTasks();
                        break;
                    case 'history':
                        D.historyView.classList.remove('hidden');
                        D.navHistoryBtn.classList.remove('bg-gray-700/50');
                        D.navHistoryBtn.classList.add('bg-indigo-600');
                        renderHistoryView(); // Initial render for history view
                        break;
                    case 'achievements': 
                        D.achievementsView.classList.remove('hidden');
                        D.navAchievementsBtn.classList.remove('bg-gray-700/50');
                        D.navAchievementsBtn.classList.add('bg-indigo-600');
                        renderAchievements(); // Renders trophies
                        break;
                    case 'progress': 
                        D.progressView.classList.remove('hidden');
                        D.navProgressBtn.classList.remove('bg-gray-700/50');
                        D.navProgressBtn.classList.add('bg-indigo-600');
                        renderProgress(); // Renders metrics
                        break;
                    case 'settings': 
                        D.settingsView.classList.remove('hidden');
                        D.navSettingsBtn.classList.remove('bg-gray-700/50');
                        D.navSettingsBtn.classList.add('bg-indigo-600');
                        renderSubjectManager(); // Renders the subject management UI
                        break;
                }
                renderUI();
            }

            // --- STREAK RENDERING ---

            function renderStreakProgress() {
                const totalFocus = state.totalFocusTime;
                const currentStreakGoalStart = state.streakCount * STREAK_GOAL_SECONDS;
                const progressInGoal = totalFocus - currentStreakGoalStart;
                const percentage = Math.min(100, (progressInGoal / STREAK_GOAL_SECONDS) * 100);
                const offset = CIRCLE_CIRCUMFERENCE - (percentage / 100) * CIRCLE_CIRCUMFERENCE;

                if (D.streakProgressBar) {
                    D.streakProgressBar.style.strokeDashoffset = offset;
                }
                if (D.streakProgressPercent) {
                    D.streakProgressPercent.textContent = `${Math.floor(percentage)}%`;
                }
                if (D.streakCount) {
                    D.streakCount.textContent = state.streakCount.toString();
                }
                if (D.nextStreakInfo) {
                    const remainingSeconds = STREAK_GOAL_SECONDS - progressInGoal;
                    const displayRemaining = Math.max(0, remainingSeconds);
                    const remainingTimeStr = formatTime(displayRemaining, true);
                    D.nextStreakInfo.textContent = `Next streak at ${state.streakCount + 1}: ${remainingTimeStr} remaining`;
                }
            }

            /** Updates the timer, controls, and noise button states. */
            function renderUI() {
                const isRunning = state.isRunning;
                const subject = state.subjects.find(s => s.id === state.currentSubject);

                // --- TIMER DISPLAY LOGIC (Handles Pomodoro Countdown) ---
                let timeToDisplay = state.isPomodoroActive ? state.pomodoroTimeRemaining : state.timeElapsed;
                const timeStr = formatTime(timeToDisplay, true);
                
                // Use a default subject/color if the current one was deleted
                const subjectName = subject ? subject.name : 'Select Subject';
                const subjectColorClass = subject ? getSubjectColorClass(subject.id) : 'text-gray-400';

                // Update main title based on mode
                if (state.isPomodoroActive) {
                    D.timerTitle.textContent = state.pomodoroMode === 'focus' ? 'Pomodoro Focus (55 min)' : 'Pomodoro Break (5 min)';
                } else {
                    D.timerTitle.textContent = 'Focused Subject Tracker';
                }

                // Apply break color (red) if in break mode, otherwise use subject color
                let displayColorClass = subjectColorClass;
                if (state.isPomodoroActive && state.pomodoroMode === 'break') {
                    displayColorClass = 'text-red-400';
                }

                // Update main display
                D.timeDisplay.textContent = timeStr;
                D.timeDisplay.className = `text-7xl lg:text-8xl font-extrabold tabular-nums tracking-tighter ${displayColorClass} transition-colors`;

                // Update fullscreen display if visible
                if (!D.fullscreenClockModal.classList.contains('hidden')) {
                    D.fullscreenTimeDisplay.textContent = timeStr;
                    D.fullscreenTimeDisplay.className = `text-[12rem] lg:text-[18rem] xl:text-[25rem] font-extrabold tabular-nums tracking-tighter ${displayColorClass.replace('text-', 'text-')} transition-colors`;
                    D.fullscreenSubjectGoal.textContent = state.isPomodoroActive 
                        ? (state.pomodoroMode === 'focus' ? `${subjectName} | Goal: ${D.taskInput.value.trim() || 'Focus Goal'}` : 'BREAK TIME - STAND UP!') 
                        : `${subjectName} | ${D.taskInput.value.trim() || 'Focus Goal'}`;
                }

                // Input/Selector Control
                D.taskInput.disabled = isRunning || state.isPomodoroActive;
                D.subjectSelector.querySelectorAll('input[name="subject"]').forEach(radio => {
                    radio.disabled = isRunning || state.isPomodoroActive;
                    if (radio.value === state.currentSubject) {
                        radio.checked = true;
                    }
                });

                // Start/Pause Button
                D.startPauseBtn.innerHTML = isRunning ? '<i data-lucide="square" class="w-8 h-8"></i>' : '<i data-lucide="play" class="w-8 h-8"></i>';
                D.startPauseBtn.className = `p-4 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 ${
                    isRunning ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'
                }`;
                // Apply custom mobile size style (defined in <style> block)
                D.startPauseBtn.id = "start-pause-btn"; 


                // Reset Button: disabled if running, or if free-form time is 0 AND pomodoro is inactive
                D.resetBtn.disabled = isRunning || (!state.isPomodoroActive && state.timeElapsed === 0);

                // Pomodoro Button
                D.pomodoroBtn.className = `p-4 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 ${
                    state.isPomodoroActive ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-700/50 hover:bg-gray-600/70'
                }`;
                D.pomodoroBtn.innerHTML = state.isPomodoroActive 
                    ? '<i data-lucide="zap" class="w-6 h-6"></i>' // Zap icon for active
                    : '<i data-lucide="timer" class="w-6 h-6"></i>'; // Timer icon for inactive

                // Fullscreen button is disabled when timer is at 0 (and not in a countdown)
                const isTimerEmpty = !state.isPomodoroActive && state.timeElapsed === 0;
                D.fullscreenBtn.disabled = isTimerEmpty;
                D.fullscreenBtn.classList.toggle('opacity-50', isTimerEmpty);
                D.fullscreenBtn.classList.toggle('cursor-not-allowed', isTimerEmpty);

                // Noise Button
                D.noiseBtn.className = `p-2 rounded-full transition-colors ${
                    isNoisePlaying ? 'bg-amber-500 text-black hover:bg-amber-400' : 'text-gray-400 hover:bg-white/10'
                }`;
                D.noiseBtn.innerHTML = isNoisePlaying 
                    ? '<i data-lucide="volume-2" class="w-6 h-6"></i>' 
                    : '<i data-lucide="volume-x" class="w-6 h-6"></i>';

                renderStreakProgress();
                window.createLucideIcons();
                state.sessionGoal = D.taskInput.value.trim();
            }

            // --- SUBJECT & HISTORY RENDERING ---

            // UPDATED to use state.subjects
            function setupSubjectSelector() {
                // ADDED: w-1/2 or w-1/3 classes for responsive wrapping on small screens
                const itemWidthClass = state.subjects.length <= 4 ? 'w-full sm:w-1/4' : 'w-1/2 sm:w-1/5';
                
                D.subjectSelector.innerHTML = state.subjects.map(subject => `
                    <div class="${itemWidthClass} p-0.5">
                        <input type="radio" id="sub-${subject.id}" name="subject" value="${subject.id}" class="hidden subject-radio" ${state.currentSubject === subject.id ? 'checked' : ''} />
                        <label for="sub-${subject.id}" class="block w-full text-center py-2 px-1 rounded-full cursor-pointer text-sm font-semibold transition-colors border border-gray-700/50 text-gray-400 hover:bg-white/10">
                            ${subject.name}
                        </label>
                    </div>
                `).join('');
                
                // Add event listeners to update state when a subject is selected
                D.subjectSelector.querySelectorAll('input[name="subject"]').forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        state.currentSubject = event.target.value;
                        saveState();
                        renderUI(); 
                    });
                });
            }

            function renderHistory() {
                D.historyList.innerHTML = '';
                const sessionsToShow = state.sessions.slice(0, 10);

                if (sessionsToShow.length === 0) {
                    D.noHistory.classList.remove('hidden');
                    return;
                }
                D.noHistory.classList.add('hidden');

                sessionsToShow.forEach(session => {
                    const duration = formatMinutes(session.durationSeconds);
                    // Handle case where subject may have been deleted (use fallback)
                    const subjectClass = getSubjectColorClass(session.subjectId).replace('text-', 'border-');
                    const html = `
                        <div onclick="showSessionDetails(${session.id})" class="flex items-center justify-between p-3 bg-gray-700/50 rounded-2xl cursor-pointer hover:bg-gray-700 transition-colors border-l-4 ${subjectClass}">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold truncate text-white">${session.subject}: ${session.goal}</p>
                                <p class="text-xs text-gray-400">${new Date(session.timestamp).toLocaleTimeString()} Â· ${duration}</p>
                            </div>
                            <i data-lucide="chevrons-right" class="w-4 h-4 text-gray-400 flex-shrink-0 ml-4"></i>
                        </div>
                    `;
                    D.historyList.insertAdjacentHTML('beforeend', html);
                });
            }
            
            function renderHistoryView() {
                // 1. Populate the date selector
                const sessionDates = state.sessions.map(s => getFormattedDate(s.timestamp));
                
                // Collect completion and creation dates from tasks
                const taskDates = state.tasks
                    .map(t => [
                        getFormattedDate(t.createdAt), 
                        t.completed ? getFormattedDate(t.completedAt) : null
                    ])
                    .flat()
                    .filter(d => d !== null);
                    
                const allDates = [...sessionDates, ...taskDates].filter(d => d !== null);
                const uniqueDates = [...new Set(allDates)].sort().reverse();

                // 2. Clear and populate the selector
                D.dateSelector.innerHTML = '';
                if (uniqueDates.length === 0) {
                    D.dateSelector.innerHTML = '<option value="">No sessions or tasks logged</option>';
                    D.dailySummaryContainer.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>';
                    return;
                }
                
                D.dateSelector.innerHTML = uniqueDates.map(dateKey => 
                    `<option value="${dateKey}">${formatDateForDisplay(dateKey)}</option>`
                ).join('');

                // 3. Render the summary for the currently selected date (or the latest one)
                const selectedDate = D.dateSelector.value || uniqueDates[0];
                renderDailySummary(selectedDate);
            }
            
            /** Renders the session and task summary for a selected date. */
            function renderDailySummary(dateKey) {
                if (!dateKey) {
                    D.dailySummaryContainer.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>';
                    return;
                }

                // 1. Filter and summarize sessions
                const dailySessions = state.sessions.filter(s => getFormattedDate(s.timestamp) === dateKey);
                let totalDailyFocusSeconds = dailySessions.reduce((sum, s) => sum + s.durationSeconds, 0);

                const sessionListHTML = dailySessions.map(session => {
                    const duration = formatMinutes(session.durationSeconds);
                    const subjectClass = getSubjectColorClass(session.subjectId).replace('text-', 'border-');
                    return `
                        <div onclick="showSessionDetails(${session.id})" class="flex items-start p-3 bg-gray-800/50 rounded-2xl cursor-pointer hover:bg-gray-700/70 transition-colors border-l-4 ${subjectClass}">
                            <i data-lucide="clock" class="w-5 h-5 mr-3 text-indigo-400 flex-shrink-0 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold truncate text-white">${session.subject} - ${duration}</p>
                                <p class="text-xs text-gray-400">Goal: ${session.goal || 'No Goal Set'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 2. Filter and display TASKS created on this day (both complete and incomplete)
                const tasksCreatedToday = state.tasks
                    .filter(t => getFormattedDate(t.createdAt) === dateKey);

                const incompleteTasks = tasksCreatedToday
                    .filter(t => !t.completed);

                const completedTasks = tasksCreatedToday
                    .filter(t => t.completed);

                // HTML for Incomplete Tasks
                const incompleteTaskListHTML = incompleteTasks.map(task => `
                    <div class="flex items-center p-3 text-sm bg-gray-800/50 rounded-2xl border border-red-600/50">
                        <i data-lucide="alert-circle" class="w-5 h-5 mr-3 text-red-400 flex-shrink-0"></i>
                        <span class="text-gray-300">${task.text}</span>
                        <span class="ml-auto text-xs text-red-400">Pending</span>
                    </div>
                `).join('');

                // HTML for Completed Tasks (uses the list filtered by creation date)
                const completedTaskListHTML = completedTasks.map(task => `
                    <div class="flex items-center p-3 text-sm bg-gray-700/50 rounded-2xl border border-emerald-600/50">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-3 text-emerald-400 flex-shrink-0"></i>
                        <span class="text-gray-300 line-through">${task.text}</span>
                        <span class="ml-auto text-xs text-gray-400">${new Date(task.completedAt).toLocaleTimeString()}</span>
                    </div>
                `).join('');


                // 3. Construct the final HTML
                D.dailySummaryContainer.innerHTML = `
                    <div class="glass-base p-4 rounded-2xl shadow-inner bg-gray-900/40">
                        <h3 class="text-xl font-bold mb-2 text-indigo-300">Total Focus:</h3>
                        <p class="text-5xl font-extrabold text-emerald-400 tabular-nums">${formatMinutes(totalDailyFocusSeconds)}</p>
                        <p class="text-sm text-gray-500 mt-1">${formatDateForDisplay(dateKey)}</p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-300 mt-6 mb-3 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="list-checks" class="w-5 h-5 mr-2"></i> Focus Sessions (${dailySessions.length})
                    </h3>
                    <div class="space-y-3">
                        ${sessionListHTML || '<p class="text-gray-500 text-center py-2">No focus sessions logged on this day.</p>'}
                    </div>

                    <h3 class="text-xl font-semibold text-gray-300 mt-6 mb-3 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="list" class="w-5 h-5 mr-2"></i> Tasks Created (${tasksCreatedToday.length})
                    </h3>
                    
                    <h4 class="text-lg font-medium text-red-300 mt-4 mb-2 flex items-center">
                        <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> Incomplete (${incompleteTasks.length})
                    </h4>
                    <div class="space-y-3">
                        ${incompleteTaskListHTML || '<p class="text-gray-500 text-center py-2">No incomplete tasks created on this day.</p>'}
                    </div>
                    
                    <h4 class="text-lg font-medium text-emerald-300 mt-4 mb-2 flex items-center">
                        <i data-lucide="check" class="w-4 h-4 mr-1"></i> Completed (${completedTasks.length})
                    </h4>
                    <div class="space-y-3">
                        ${completedTaskListHTML || '<p class="text-gray-500 text-center py-2">No completed tasks created on this day.</p>'}
                    </div>
                `;
                
                window.createLucideIcons();
            }

            // --- TASK LOGIC ---

            function addTask() {
                const text = D.taskInputNew.value.trim();
                if (text) {
                    const newTask = {
                        id: Date.now(),
                        text: text,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null 
                    };
                    state.tasks.push(newTask);
                    D.taskInputNew.value = '';
                    saveState();
                    renderTasks();
                    calculateAllStats();
                }
            }

            function toggleTask(taskId) {
                const task = state.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    
                    // Add/Remove completion timestamp
                    if (task.completed) {
                        task.completedAt = new Date().toISOString();
                    } else {
                        task.completedAt = null;
                    }
                    
                    saveState();
                    renderTasks();
                    calculateAllStats(); // To update task counts
                }
            }

            function deleteTask(taskId) {
                state.tasks = state.tasks.filter(t => t.id !== taskId);
                saveState();
                renderTasks();
                calculateAllStats();
            }

            function renderTasks() {
                if (state.currentPage !== 'tasks') return;

                const pendingTasks = state.tasks.filter(t => !t.completed);
                const completedTasks = state.tasks.filter(t => t.completed);

                const generateTaskHtml = (task, isPending) => {
                    const bgClass = isPending 
                        ? 'bg-gray-800/50 border-gray-700/50 hover:bg-gray-700/50' 
                        : 'bg-emerald-900/40 border-emerald-500/50 hover:bg-emerald-900/50';
                    const textClass = isPending ? 'text-white' : 'text-gray-300 line-through';

                    return `
                        <div id="task-${task.id}" class="flex items-start p-3 rounded-2xl transition-all ${bgClass} border">
                            <input 
                                type="checkbox" 
                                id="check-${task.id}" 
                                class="mt-1 flex-shrink-0" 
                                ${task.completed ? 'checked' : ''} 
                                onclick="toggleTask(${task.id})"
                            >
                            <label for="check-${task.id}" class="flex-1 ml-3 cursor-pointer">
                                <span class="block text-base font-medium ${textClass}">${task.text}</span>
                                <span class="text-xs text-gray-500">${new Date(task.createdAt).toLocaleDateString()}</span>
                            </label>
                            <button onclick="deleteTask(${task.id})" class="p-1 rounded-full text-gray-500 hover:text-red-400 transition-colors flex-shrink-0 ml-4">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
                };

                const pendingHTML = pendingTasks.map(t => generateTaskHtml(t, true)).join('');
                const completedHTML = completedTasks.map(t => generateTaskHtml(t, false)).join('');

                D.tasksListContainer.innerHTML = `
                    <h3 class="text-xl font-semibold text-white mb-3 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="list-todo" class="w-5 h-5 mr-2 text-indigo-400"></i> To Do (${pendingTasks.length})
                    </h3>
                    <div class="space-y-3 mb-8">
                        ${pendingHTML || '<p class="text-gray-500 text-center py-4">All tasks complete! Add a new goal.</p>'}
                    </div>
                    
                    <h3 class="text-xl font-semibold text-white mb-3 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-emerald-400"></i> Completed (${completedTasks.length})
                    </h3>
                    <div class="space-y-3">
                        ${completedHTML || '<p class="text-gray-500 text-center py-4">No tasks completed yet.</p>'}
                    </div>
                `;

                window.createLucideIcons();
            }

            // --- ACHIEVEMENTS RENDERING (Trophies) ---

            function renderAchievements() {
                if (state.currentPage !== 'achievements') return;
                calculateAllStats(); // Ensure stats are fresh

                D.trophiesContainer.innerHTML = ACHIEVEMENTS_CONFIG.map(ach => {
                    const status = stats.achievements[ach.id];
                    if (!status) return '';
                    
                    const isComplete = status.isComplete;
                    const percentage = status.percentage;

                    const iconClass = isComplete ? `${ach.color}` : 'text-gray-500';
                    const progressBg = isComplete ? 'bg-emerald-600' : 'bg-indigo-600';
                    const progressText = isComplete ? 'Completed!' : `${status.progress}/${status.goal} ${ach.unit}`;

                    return `
                        <div class="glass-base p-5 rounded-2xl shadow-lg bg-gray-800/50 border-gray-700/50 flex flex-col justify-between h-full">
                            <div>
                                <div class="flex items-center mb-3">
                                    <i data-lucide="${ach.icon}" class="w-8 h-8 mr-3 ${iconClass} flex-shrink-0"></i>
                                    <h4 class="text-lg font-bold ${isComplete ? 'text-white' : 'text-gray-300'}">${ach.name}</h4>
                                </div>
                                <p class="text-gray-400 text-sm mb-4">${ach.description}</p>
                            </div>
                            
                            <div class="mt-4">
                                <div class="flex justify-between text-xs font-semibold mb-1">
                                    <span class="${isComplete ? 'text-emerald-400' : 'text-indigo-300'}">${progressText}</span>
                                    <span class="text-gray-400">${Math.floor(percentage)}%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="${progressBg} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                window.createLucideIcons();
            }
            
            // --- PROGRESS RENDERING (Metrics & Area Chart) ---
            function renderProgress() {
                if (state.currentPage !== 'progress') return;
                calculateAllStats();

                // 1. Progress Metrics (Overall, Monthly, Weekly, Tasks)
                const progressMetrics = [
                    { 
                        name: 'Overall Focus Time', 
                        icon: 'zap', 
                        value: formatMinutes(stats.overallTime), 
                        color: 'text-indigo-400',
                        subtext: 'Across all sessions'
                    },
                    { 
                        name: 'Average Session Length', 
                        icon: 'clock-3', 
                        value: formatMinutes(stats.avgSessionLengthSeconds), 
                        color: 'text-yellow-400',
                        subtext: state.sessions.length > 0 ? `From ${state.sessions.length} sessions` : 'No sessions logged' 
                    },
                    { 
                        name: 'Monthly Focus Time', 
                        icon: 'calendar-range', 
                        value: formatMinutes(stats.monthlyTime), 
                        color: 'text-sky-400',
                        subtext: formatComparison(stats.monthlyTime, stats.prevMonthlyTime, 'month')
                    },
                    { 
                        name: 'Weekly Focus Time', 
                        icon: 'calendar-check', 
                        value: formatMinutes(stats.weeklyTime), 
                        color: 'text-emerald-400',
                        subtext: formatComparison(stats.weeklyTime, stats.prevWeeklyTime, 'week')
                    },
                    { 
                        name: 'Tasks Completed', 
                        icon: 'list-checks', 
                        value: stats.tasksCompleted.toString(), 
                        color: 'text-amber-400',
                        subtext: `Total: ${stats.totalTasks}`
                    },
                    { 
                        name: 'Productivity Score', 
                        icon: 'trending-up', 
                        value: `${stats.efficiency}%`, 
                        color: stats.efficiency >= 75 ? 'text-emerald-400' : 'text-yellow-400',
                        subtext: `Completion Rate`
                    },
                    {
                        name: 'Avg Daily Focus',
                        icon: 'sun',
                        value: formatMinutes(stats.avgDailyHours * 3600), 
                        color: 'text-red-400',
                        subtext: 'Since first session'
                    }
                ];

                const metricsHTML = progressMetrics.map(metric => `
                    <div class="glass-base p-4 sm:p-5 rounded-2xl shadow-lg bg-gray-800/50 border-gray-700/50">
                        <div class="flex items-center justify-between">
                            <i data-lucide="${metric.icon}" class="w-7 h-7 ${metric.color}"></i>
                            <span class="text-2xl sm:text-3xl font-extrabold text-white tabular-nums">${metric.value}</span>
                        </div>
                        <p class="text-gray-400 text-sm mt-3 flex justify-between items-center">
                            ${metric.name}
                            ${metric.subtext}
                        </p>
                    </div>
                `).join('');
                
                D.metricsContainer.innerHTML = metricsHTML;
                
                // 2. Weekly Breakdown Area Chart (using SVG)
                const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const maxTimeSeconds = Math.max(...stats.dailyTimeInWeek);
                // Ensure maxTime is at least 1 to avoid division by zero
                const maxTime = maxTimeSeconds || 1; 
                
                // Calculate normalized (X, Y) points (normalized to 0-100)
                const points = stats.dailyTimeInWeek.map((time, index) => {
                    // Spread points evenly across the X-axis (0, 16.66, 33.33, ..., 100)
                    const x = (index / 6) * 100; 
                    // Normalize time to a 0-100 scale, then invert for SVG (Y=0 is top). 
                    // Clamp between 5 (for visual padding at the top) and 95 (for padding at the bottom baseline)
                    const normalizedY = 100 - (time / maxTime) * 90; // Use 90% range for padding
                    const y = Math.min(95, Math.max(10, normalizedY)); 
                    return { x, y, time };
                });

                // 1. Create the path string for the Area Chart (closed polygon)
                const areaPathPoints = points.map(p => `${p.x} ${p.y}`).join(' L ');
                // Starts at bottom-left, follows points, ends at bottom-right, closes path
                const areaPath = `M 0 95 L ${areaPathPoints} L 100 95 Z`;

                // 2. Create the polyline points string for the Line Graph (just the line)
                const polylinePoints = points.map(p => `${p.x},${p.y}`).join(' ');

                // 3. Create the circles/dots for data points and tooltips
                const circlesHTML = points.map((p, index) => {
                    const duration = formatMinutes(p.time);
                    
                    return `
                        <circle 
                            cx="${p.x}" 
                            cy="${p.y}" 
                            r="3" 
                            class="fill-indigo-400 stroke-gray-900 stroke-1 hover:fill-amber-400 transition-all duration-200"
                        >
                             <title>${dayLabels[index]}: ${duration}</title>
                        </circle>
                    `;
                }).join('');
                
                // Calculate max/min time values for labels
                const maxTimeValue = maxTimeSeconds > 0 ? formatMinutes(maxTimeSeconds) : "0 min";
                
                const breakdownHTML = `
                    <div class="h-48 relative">
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full">
                            
                            <path 
                                d="${areaPath}" 
                                fill="url(#areaGradient)" 
                                class="transition-all duration-700"
                            />
                            
                            <defs>
                                <linearGradient id="areaGradient" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#4f46e5" stop-opacity="0.4"/>
                                    <stop offset="100%" stop-color="#4f46e5" stop-opacity="0.05"/>
                                </linearGradient>
                            </defs>
                            
                            <line x1="0" y1="95" x2="100" y2="95" stroke="#4b5563" stroke-width="0.5"/> 
                            <line x1="0" y1="52.5" x2="100" y2="52.5" stroke="#4b5563" stroke-width="0.25" stroke-dasharray="3 3"/>
                            
                            <polyline 
                                points="${polylinePoints}" 
                                fill="none" 
                                stroke="#6366f1" 
                                stroke-width="2.5" 
                                stroke-linecap="round" 
                                stroke-linejoin="round"
                            />
                            
                            ${circlesHTML}
                        </svg>
                        
                        <div class="absolute top-0 left-0 text-xs text-indigo-300 transform -translate-y-1/2">
                            Max: ${maxTimeValue}
                        </div>
                         <div class="absolute bottom-0 left-0 text-xs text-gray-400 transform translate-y-full">
                            Min: 0 min
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-400 font-medium mt-3 px-1">
                        ${dayLabels.map(label => `<span class="text-center flex-1">${label}</span>`).join('')}
                    </div>
                `;

                D.weeklyBreakdownContainer.innerHTML = breakdownHTML;

                window.createLucideIcons();
            }

            // --- SUBJECT MANAGEMENT LOGIC (NEW) ---

            /** Finds an unused color for a new subject. */
            function getUnusedColor() {
                const usedColors = state.subjects.map(s => s.color);
                return SUBJECT_COLORS.find(c => !usedColors.includes(c)) || 'purple'; 
            }

            /** Handler for adding a subject from input. */
            function addSubjectHandler() {
                const name = D.newSubjectInput.value.trim();
                if (!name) return;

                if (state.subjects.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                    alert("Subject already exists!");
                    return;
                }

                const newSubject = {
                    id: name.toLowerCase().replace(/\s+/g, '-'),
                    name: name,
                    color: getUnusedColor()
                };
                
                // Check if the ID is unique, if not, append a number
                let idCounter = 1;
                let newId = newSubject.id;
                while(state.subjects.some(s => s.id === newId)) {
                    newId = `${newSubject.id}-${idCounter++}`;
                }
                newSubject.id = newId;

                state.subjects.push(newSubject);
                D.newSubjectInput.value = '';
                saveState();
                renderSubjectManager();
                setupSubjectSelector();
            }

            /** Deletes a subject from the state. */
            function deleteSubject(subjectId) {
                if (state.subjects.length <= 1) {
                    alert("Cannot delete the last subject. You must have at least one.");
                    return;
                }
                if (state.currentSubject === subjectId) {
                    alert("Cannot delete the currently selected subject. Please switch subjects on the Timer tab first.");
                    return;
                }
                
                if (confirm(`Are you sure you want to delete the subject "${state.subjects.find(s => s.id === subjectId).name}"? All associated historical data will remain, but new sessions cannot be logged under it.`)) {
                    state.subjects = state.subjects.filter(s => s.id !== subjectId);
                    
                    saveState();
                    renderSubjectManager();
                    setupSubjectSelector();
                    renderUI(); // Update timer UI
                }
            }

            /** Renders the list of subjects in the Settings view. */
            function renderSubjectManager() {
                if (state.currentPage !== 'settings') return;

                const listHTML = state.subjects.map(subject => {
                    const isCurrent = subject.id === state.currentSubject;
                    const canDelete = state.subjects.length > 1 && !isCurrent;
                    
                    const colorClass = getSubjectColorClass(subject.id);

                    return `
                        <div class="flex items-center p-3 bg-gray-700/50 rounded-2xl border border-gray-600/50">
                            <i data-lucide="book-open" class="w-5 h-5 mr-3 ${colorClass}"></i>
                            <span class="text-white font-medium flex-1">${subject.name}</span>
                            
                            ${isCurrent ? 
                                '<span class="text-xs text-indigo-400 font-semibold mr-3">CURRENT</span>' : 
                                '<span class="text-xs text-gray-500 mr-3">ID: ' + subject.id + '</span>'}
                                
                            <button 
                                onclick="deleteSubject('${subject.id}')" 
                                class="p-1 rounded-full text-gray-500 hover:text-red-400 transition-colors flex-shrink-0 ml-4 disabled:opacity-50 disabled:cursor-not-allowed"
                                ${!canDelete ? 'disabled' : ''}
                            >
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
                }).join('');

                D.subjectsListManager.innerHTML = listHTML || '<p class="text-center text-gray-500 text-sm py-4">No subjects defined.</p>';
                window.createLucideIcons();
            }
            
            // --- MODAL & FULLSCREEN LOGIC ---

            function toggleFullscreenClock() {
                if (D.fullscreenBtn.disabled) return;

                const isHidden = D.fullscreenClockModal.classList.contains('hidden');
                
                if (isHidden) {
                    D.fullscreenClockModal.classList.remove('hidden');
                    // Request fullscreen API access for the modal element
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    }
                } else {
                    D.fullscreenClockModal.classList.add('hidden');
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
                renderUI(); // Re-render to update the time display inside the modal
            }

            function showSessionDetails(sessionId) {
                const session = state.sessions.find(s => s.id === sessionId);
                if (session) {
                    const duration = formatMinutes(session.durationSeconds);
                    const date = new Date(session.timestamp).toLocaleString();
                    
                    const content = `
Subject: ${session.subject}
Duration: ${duration}
Completed: ${date}

Goal: ${session.goal}
                    `;
                    D.modalContent.textContent = content.trim();
                    D.detailsModal.classList.remove('hidden');
                }
            }
            
            // --- EXPOSE GLOBAL FUNCTIONS (Required by HTML onclick) ---
            window.switchPage = switchPage;
            window.toggleBrownNoise = toggleBrownNoise;
            window.togglePomodoro = togglePomodoro;
            window.toggleFullscreenClock = toggleFullscreenClock;
            window.addTask = addTask;
            window.toggleTask = toggleTask;
            window.deleteTask = deleteTask;
            window.handleDateChange = renderDailySummary; 
            window.showSessionDetails = showSessionDetails;
            window.addSubjectHandler = addSubjectHandler; // Exposed handler
            window.deleteSubject = deleteSubject; // Exposed function
            
            // Handlers for timer buttons 
            window.startPauseHandler = () => {
                if (state.isRunning) {
                    stopTimer();
                } else {
                    startTimer();
                }
            };
            window.resetTimer = resetTimer;

            // --- INITIALIZATION ---
            
            // Execute initialization when the DOM is ready (Replaces the old window.onload logic)
            document.addEventListener('DOMContentLoaded', () => {
                loadState();
                setupSubjectSelector();
                renderHistory();
                
                // Re-start timer if it was running when the app closed
                if (state.isRunning) {
                    startTimer();
                } else {
                    // Initialize time display with loaded time (Updated for Pomodoro state)
                    let timeToDisplay = state.isPomodoroActive ? state.pomodoroTimeRemaining : state.timeElapsed;
                    D.timeDisplay.textContent = formatTime(timeToDisplay, true);
                }
                
                renderViews(); // Initialize the correct view (timer, tasks, or history)
            });
    </script>
</body>
</html>
