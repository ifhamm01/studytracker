<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focused Subject Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Expose a simple wrapper to create icons using the global 'lucide' object
        window.createLucideIcons = () => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        };
    </script>
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>"></link>
    
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            overflow-x: hidden; /* Prevent horizontal scrollbar from animation */
        }
        
        /* New Animated Background Styles */
        #background-effect {
            /* Dark, subtle blue/purple gradient */
            background: linear-gradient(-45deg, #1e0030, #00101e, #0e0e0e, #1c002e);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
            filter: blur(80px); /* Subtle blur for a nebula effect */
            opacity: 0.6; /* Ensure it's not too distracting */
        }

        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        /* Custom styles for Glassmorphism base */
        .glass-base {
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Base shadow */
        }
        
        .glass-base:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* Lifted shadow on hover */
        }

        /* Styling for the subject radio buttons */
        .subject-radio:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #a5b4fc; /* indigo-300 */
            color: #fff;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); /* Blue glow */
        }
        
        /* Custom checkbox style */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            border: 2px solid #6b7280; /* gray-500 */
            border-radius: 0.25rem;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="checkbox"]:checked {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            display: block;
            color: white;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.1;
        }
        
        /* Custom media query for fullscreen display font size on smaller screens */
        @media (max-width: 768px) {
            #fullscreen-time-display {
                font-size: 8rem;
            }
        }
        @media (max-width: 480px) {
            #fullscreen-time-display {
                font-size: 6rem;
            }
        }

    </style>
  
</head>
<body class="text-white min-h-screen">
    
    <div id="background-effect" class="fixed inset-0 -z-10"></div>
    
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 relative z-10">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-400">Study Tracker</h1>
        </header>

       
            
            <nav class="flex space-x-2 mb-6 p-1 bg-gray-800 rounded-full overflow-x-auto">
                <button id="nav-timer-btn" onclick="switchPage('timer')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-indigo-600">
                    <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i> Timer
                </button>
                <button id="nav-tasks-btn" onclick="switchPage('tasks')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="list-todo" class="w-4 h-4 inline mr-1"></i> Tasks
                </button>
                <button id="nav-history-btn" onclick="switchPage('history')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> History
                </button>
                <button id="nav-achievements-btn" onclick="switchPage('achievements')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="medal" class="w-4 h-4 inline mr-1"></i> Achievements
                </button>
                <button id="nav-progress-btn" onclick="switchPage('progress')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="trending-up" class="w-4 h-4 inline mr-1"></i> Progress
                </button>
                <button id="nav-settings-btn" onclick="switchPage('settings')" class="flex-1 py-2 px-3 sm:px-4 rounded-full text-xs sm:text-sm font-semibold transition-colors whitespace-nowrap bg-gray-700/50 hover:bg-gray-700">
                    <i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> Settings
                </button>
            </nav>
 <main class="glass-base rounded-3xl p-5 sm:p-6 lg:p-8 shadow-2xl bg-gray-900/40">
                  <div id="timer-view">
            
            <div id="timer-card" class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h1 id="timer-title" class="text-2xl font-bold text-indigo-300">Focused Subject Tracker</h1>
                    
                    
                    <button 
                        id="music-btn" 
                        onclick="toggleSongPlayback()" 
                        class="p-2 rounded-full text-gray-400 hover:bg-white/10 transition-colors"
                    >
                        <i data-lucide="music" class="w-6 h-6"></i>
                    </button>
                    </div>
                
                
                <div class="text-center mb-6">
                    
                    <p id="time-display" class="text-7xl lg:text-8xl font-extrabold tabular-nums tracking-tighter">
                        00:00:00
                    </p>
                </div>
                
                
                <div class="mb-8 flex flex-col sm:flex-row justify-center items-center sm:space-x-6 space-y-4 sm:space-y-0 py-2">
                    
                    <div class="relative w-24 h-24 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 70 70">
                            
                            <circle 
                                class="text-gray-700/50" 
                                stroke-width="6" 
                                stroke="currentColor" 
                                fill="transparent" 
                                r="30" 
                                cx="35" 
                                cy="35"
                            ></circle>
                            
                            <circle 
                                id="streak-progress-bar"
                                class="text-emerald-400 transition-all duration-700 ease-out" 
                                stroke-width="6" 
                                stroke="currentColor" 
                                stroke-linecap="round" 
                                fill="transparent" 
                                r="30" 
                                cx="35" 
                                cy="35"
                                style="stroke-dasharray: 188.5; stroke-dashoffset: 188.5;"
                            ></circle>
                        </svg>
                        <span id="streak-progress-percent" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-gray-300">0%</span>
                    </div>

                    
                    <div class="flex-grow text-center sm:text-left">
                        <div class="text-sm text-gray-400 mb-1">Current Daily Focus Streak</div>
                        <div class="flex items-center justify-center sm:justify-start">
                            <i data-lucide="flame" class="w-8 h-8 mr-3 text-red-400"></i>
                            <span id="streak-count" class="text-5xl font-extrabold text-red-300 tabular-nums">0</span>
                        </div>
                        <div id="next-streak-info" class="text-xs text-gray-500 mt-2">
                            </div>
                    </div>
                </div>

                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-300">
                        Select Subject
                    </label>
                    <div id="subject-selector" class="flex flex-wrap gap-2 sm:flex-row sm:space-x-2 sm:gap-0">
                        
                    </div>
                </div>

                
                <div class="mb-8">
                    <label for="task-input" class="block text-sm font-medium mb-2 text-gray-300">
                        Session Goal
                    </label>
                    <div class="flex items-center bg-white/10 rounded-full p-3">
                        <i data-lucide="target" class="w-5 h-5 mr-3 text-indigo-400 flex-shrink-0"></i>
                        <input 
                            id="task-input"
                            type="text"
                            placeholder="What do you want to accomplish?"
                            class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                        >
                    </div>
                </div>

                
                <div class="flex justify-center space-x-4">
                    <button id="start-pause-btn" onclick="startPauseHandler()" class="p-4 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 bg-green-500 hover:bg-green-600">
                        <i data-lucide="play" class="w-6 h-6"></i>
                    </button>
                    
                    <button id="reset-btn" onclick="resetTimer()" disabled class="p-4 rounded-full bg-gray-700/50 hover:bg-gray-600/70 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
                    </button>
                    
                    
                    <button id="pomodoro-btn" onclick="togglePomodoro()" class="p-4 rounded-full bg-gray-700/50 hover:bg-gray-600/70 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="timer" class="w-6 h-6"></i>
                    </button>

                    
                    <button id="fullscreen-btn" onclick="toggleFullscreenClock()" class="p-4 rounded-full bg-indigo-600/70 hover:bg-indigo-600 shadow-2xl transition-all transform hover:scale-105 active:scale-95">
                        <i data-lucide="maximize" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            
            <div class="glass-base mt-8 p-4 rounded-3xl shadow-xl bg-gray-800/50 border-gray-700/50">
                <h2 class="text-xl font-semibold mb-3 text-center text-gray-300 flex items-center justify-center">
                    <i data-lucide="history" class="w-5 h-5 mr-2 text-gray-400"></i>
                    Recent Focus Sessions
                </h2>
                <div id="history-list" class="max-h-48 overflow-y-auto space-y-2">
                    
                </div>
                <p id="no-history" class="text-center text-gray-500 text-sm py-4 hidden">No sessions logged yet.</p>
            </div>
        </div>
        
        
        <div id="tasks-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-4">Task List</h1>
                
                
                <div class="mb-6 flex space-x-3">
                    <div class="flex items-center bg-white/10 rounded-full p-3 flex-grow">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-3 text-emerald-400 flex-shrink-0"></i>
                        <input 
                            id="new-task-input"
                            type="text"
                            placeholder="Add a new task..."
                            class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') addTask()"
                        >
                    </div>
                    <button onclick="addTask()" class="p-3 rounded-full bg-emerald-600 hover:bg-emerald-700 transition-colors flex-shrink-0">
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </div>

                
                <div id="tasks-list" class="space-y-3 max-h-96 overflow-y-auto">
                    
                </div>
            </div>
        </div>
        
        
        <div id="history-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-4">Daily Focus History</h1>
                
                <div class="mb-6">
                    <label for="date-selector" class="block text-sm font-medium mb-2 text-gray-300">Select Day</label>
                    <select 
                        id="date-selector" 
                        onchange="handleDateChange(this.value)" 
                        class="w-full p-3 rounded-full bg-gray-700 border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        <option value="">No sessions logged</option>
                    </select>
                </div>

                <div id="daily-summary-container" class="space-y-6">
                    
                    <p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>
                </div>
            </div>
        </div>
        
        <div id="achievements-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-emerald-300 mb-6">Trophy Case</h1>
                <p class="text-gray-400 mb-6">Earn single-level achievements by hitting focus and task milestones.</p>
                <div id="trophies-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            </div>
        </div>
        
        <div id="progress-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-indigo-300 mb-6">Cumulative Progress</h1>
                <p class="text-gray-400 mb-6">Track your long-term statistics and compare performance week-over-week.</p>
                <div id="metrics-container" class="grid grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
                    
                </div>
                
                <h2 class="text-xl font-semibold text-gray-300 mt-8 mb-4 border-b border-gray-700 pb-2 flex items-center">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> Weekly Focus Breakdown (Area Chart)
                </h2>
                <div id="weekly-breakdown-container" class="p-4 bg-gray-900/40 rounded-xl">
                    <p class="text-center text-gray-400">Loading weekly data...</p>
                </div>
            </div>
        </div>

        
        <div id="settings-view" class="hidden">
            <div class="glass-base p-6 rounded-3xl shadow-2xl mb-8 bg-gray-800/30 border-gray-500/50">
                <h1 class="text-2xl font-bold text-yellow-300 mb-6">Application Settings</h1>
                
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="award" class="w-5 h-5 mr-2"></i> Daily Streak Goal
                    </h2>
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <label for="daily-goal-input" class="text-gray-400 font-medium flex-shrink-0">Daily Focus Goal (Minutes):</label>
                        <input 
                            id="daily-goal-input"
                            type="number"
                            min="5"
                            value="30"
                            class="w-full sm:w-24 p-2 rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none text-center"
                            onchange="updateDailyGoal(this.value)"
                        >
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Set the minimum focus time required to keep your daily streak alive. Must be at least 5 minutes.</p>
                </div>
                
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="book-open-check" class="w-5 h-5 mr-2"></i> Subject Management
                    </h2>
                    
                    
                    <div class="mb-6 flex space-x-3">
                        <div class="flex items-center bg-white/10 rounded-full p-3 flex-grow">
                            <i data-lucide="book-open" class="w-5 h-5 mr-3 text-yellow-400 flex-shrink-0"></i>
                            <input 
                                id="new-subject-input"
                                type="text"
                                placeholder="Enter new subject name (e.g., History)"
                                class="w-full bg-transparent text-white placeholder-gray-400 focus:outline-none"
                                onkeypress="if(event.key === 'Enter') addSubjectHandler()"
                            >
                        </div>
                        <button onclick="addSubjectHandler()" class="p-3 rounded-full bg-yellow-600 hover:bg-yellow-700 transition-colors flex-shrink-0">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>

                    
                    <div id="subjects-list-manager" class="space-y-3 max-h-96 overflow-y-auto pt-2">
                        
                    </div>
                </div>
            </div>
        </div>


    </div>

    
    <div id="details-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-40 p-4">
        <div class="w-full max-w-md bg-gray-900 border border-indigo-600/50 rounded-xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-3 text-indigo-400 flex items-center">
                <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                Session Details
            </h3>
            <p id="modal-content" class="text-gray-300 whitespace-pre-wrap"></p>
            <button 
                onclick="document.getElementById('details-modal').classList.add('hidden')"
                class="w-full mt-4 flex items-center justify-center p-3 rounded-full font-semibold text-lg transition-colors bg-indigo-600 hover:bg-indigo-700"
            >
                Close
            </button>
        </div>
    </div>
    
    
    <div id="fullscreen-clock-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-4">
        
        <button 
            onclick="toggleFullscreenClock()" 
            class="absolute top-6 right-6 p-3 rounded-full text-white bg-white/10 hover:bg-white/20 transition-colors z-50"
        >
            <i data-lucide="minimize" class="w-8 h-8"></i>
        </button>
        
        <div class="text-center">
            <p id="fullscreen-time-display" class="text-white text-[12rem] lg:text-[18rem] xl:text-[25rem] font-extrabold tabular-nums tracking-tighter transition-colors">
                00:00:00
            </p>
            <p id="fullscreen-subject-goal" class="text-4xl font-semibold text-indigo-400 mt-4 text-center break-words max-w-full px-4 sm:px-0"></p>
        </div>
        
    </div>
    
    <audio id="music-player" preload="auto"></audio>


    <script>
            // --- GLOBAL STATE & CONSTANTS ---
            const LOCAL_STORAGE_KEY = 'subjectTrackerData';
            // const STREAK_GOAL_SECONDS = 10 * 3600; // REMOVED: Using dynamic daily goal
            const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 30; // Radius 30 from SVG
            
            // --- POMODORO CONSTANTS ---
            const POMODORO_FOCUS_SECONDS = 55 * 60; // 55 minutes
            const POMODORO_BREAK_SECONDS = 5 * 60;  // 5 minutes
            
            // Subject colors and default list
            const SUBJECT_COLORS = ['indigo', 'emerald', 'sky', 'yellow', 'red', 'purple', 'teal', 'pink'];
            
            const DEFAULT_SUBJECTS = [
                { id: 'physics', name: 'Physics', color: 'indigo' },
                { id: 'chemistry', name: 'Chemistry', color: 'emerald' },
                { id: 'math', name: 'Math', color: 'sky' },
                { id: 'other', name: 'Other', color: 'yellow' },
                { id: 'lang', name: 'Language', color: 'red' }, 
            ];
            
     // --- NEW ACHIEVEMENT/PROGRESS CONFIG (Flattened Structure) ---
            const ACHIEVEMENTS_CONFIG = [
                // Focused Time Trophies (unit: 'minutes')
                { 
                    id: 'focused_hour_easy', 
                    icon: 'hourglass', 
                    name: 'First Step (1h)',
                    unit: 'minutes',
                    description: 'Log one hour of focused time.',
                    goal: 60, // Single goal
                    color: 'text-amber-300'
                },
                { 
                    id: 'focused_hour_medium', 
                    icon: 'hourglass', 
                    name: 'Time Manager (5h)', 
                    unit: 'minutes',
                    description: 'Log five hours of focused time.',
                    goal: 300, 
                    color: 'text-gray-300'
                },
                { 
                    id: 'focused_hour_hard', 
                    icon: 'hourglass', 
                    name: 'Flow State Master (20h)', 
                    unit: 'minutes',
                    description: 'Log twenty hours of focused time.',
                    goal: 1200, 
                    color: 'text-indigo-400'
                },

                // Tasks Done Trophies (unit: 'tasks')
                { 
                    id: 'tasks_done_easy', 
                    icon: 'check-circle', 
                    name: 'Getting Things Done (5)', 
                    unit: 'tasks',
                    description: 'Complete 5 tasks.',
                    goal: 5, 
                    color: 'text-amber-300'
                },
                { 
                    id: 'tasks_done_medium', 
                    icon: 'check-circle', 
                    name: 'Productivity Pro (20)', 
                    unit: 'tasks',
                    description: 'Complete 20 tasks.',
                    goal: 20, 
                    color: 'text-gray-300'
                },
                { 
                    id: 'tasks_done_hard', 
                    icon: 'check-circle', 
                    name: 'Executioner (50)', 
                    unit: 'tasks',
                    description: 'Complete 50 tasks.',
                    goal: 50, 
                    color: 'text-indigo-400'
                }
            ];

            const DEFAULT_STATE = {
                isRunning: false,
                timeElapsed: 0,
                startTime: null,
                subjects: DEFAULT_SUBJECTS, // DYNAMIC SUBJECTS
                currentSubject: DEFAULT_SUBJECTS[0].id,
                sessionGoal: '',
                sessions: [],
                tasks: [], 
                currentPage: 'timer',
                totalFocusTime: 0,
                isPomodoroActive: false,
                pomodoroMode: 'focus', 
                pomodoroTimeRemaining: POMODORO_FOCUS_SECONDS,
                
                // NEW DAILY STREAK AND GOAL MANAGEMENT
                currentDailyStreak: 0,
                lastActiveDate: null, // ISO date string of the last day a goal was logged
                dailyFocusGoalMinutes: 30, // Default to 30 minutes (1800 seconds)
                dailyTimeLogged: 0, // Time logged for the current active day (in seconds)
            };

            let state = { ...DEFAULT_STATE };
            let intervalId = null;
            // REMOVED: audioContext, brownNoiseGenerator, isNoisePlaying

            // --- MUSIC PLAYER CONSTANTS & STATE ---
            let currentSongIndex = 0;
            const PLAYLIST = [
                'assets/song1.mp3',
                'assets/song2.mp3',
                'assets/song3.mp3', 
                'assets/song4.mp3',
                'assets/song5.mp3',
                // Add your actual songs to the 'assets' folder and list them here
            ];
            
            // Stats object for achievements and progress calculation
            let stats = {
                overallTime: 0,
                monthlyTime: 0,
                weeklyTime: 0,
                prevMonthlyTime: 0, 
                prevWeeklyTime: 0,
                dailyTimeInWeek: Array(7).fill(0), // Focus time for each day of the current week (Mon-Sun)
                tasksCompleted: 0,
                totalTasks: 0,
                efficiency: 0,
                avgDailyHours: 0,
                avgSessionLengthSeconds: 0,
                achievements: {},
            };


            // --- DOM ELEMENTS (Scoped by convention) ---
            const D = {
                // Timer View elements
                timerTitle: document.getElementById('timer-title'),
                timeDisplay: document.getElementById('time-display'),
                taskInput: document.getElementById('task-input'),
                startPauseBtn: document.getElementById('start-pause-btn'),
                resetBtn: document.getElementById('reset-btn'),
                // noiseBtn: document.getElementById('noise-btn'), // REMOVED
                musicBtn: document.getElementById('music-btn'), // ADDED
                musicPlayer: document.getElementById('music-player'), // ADDED
                pomodoroBtn: document.getElementById('pomodoro-btn'),
                historyList: document.getElementById('history-list'),
                noHistory: document.getElementById('no-history'),
                subjectSelector: document.getElementById('subject-selector'),
                detailsModal: document.getElementById('details-modal'),
                modalContent: document.getElementById('modal-content'),
                
                // Streak elements
                streakProgressBar: document.getElementById('streak-progress-bar'),
                streakProgressPercent: document.getElementById('streak-progress-percent'),
                streakCount: document.getElementById('streak-count'),
                nextStreakInfo: document.getElementById('next-streak-info'),

                // Navigation and View containers
                timerView: document.getElementById('timer-view'),
                tasksView: document.getElementById('tasks-view'),
                historyView: document.getElementById('history-view'), 
                achievementsView: document.getElementById('achievements-view'), 
                progressView: document.getElementById('progress-view'), 
                settingsView: document.getElementById('settings-view'), // NEW SETTINGS VIEW
                navTimerBtn: document.getElementById('nav-timer-btn'),
                navTasksBtn: document.getElementById('nav-tasks-btn'),
                navHistoryBtn: document.getElementById('nav-history-btn'),
                navAchievementsBtn: document.getElementById('nav-achievements-btn'), 
                navProgressBtn: document.getElementById('nav-progress-btn'), 
                navSettingsBtn: document.getElementById('nav-settings-btn'), // NEW SETTINGS BUTTON
                
                // Tasks UI elements
                taskInputNew: document.getElementById('new-task-input'),
                tasksListContainer: document.getElementById('tasks-list'),

                // History UI elements
                dateSelector: document.getElementById('date-selector'),
                dailySummaryContainer: document.getElementById('daily-summary-container'),
                
                // Achievements UI elements 
                trophiesContainer: document.getElementById('trophies-container'),
                metricsContainer: document.getElementById('metrics-container'), 
                weeklyBreakdownContainer: document.getElementById('weekly-breakdown-container'), 
                
                // Fullscreen Clock elements
                fullscreenClockModal: document.getElementById('fullscreen-clock-modal'),
                fullscreenTimeDisplay: document.getElementById('fullscreen-time-display'),
                fullscreenSubjectGoal: document.getElementById('fullscreen-subject-goal'),
                fullscreenBtn: document.getElementById('fullscreen-btn'),
                
                // Settings UI elements
                newSubjectInput: document.getElementById('new-subject-input'),
                subjectsListManager: document.getElementById('subjects-list-manager'),
                dailyGoalInput: document.getElementById('daily-goal-input'), // NEW ELEMENT
            };

            // --- LOCAL STORAGE LOGIC ---

            /** Loads state from localStorage or initializes default state. */
         function loadState() {
                try {
                    const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (storedState) {
                        const loadedState = JSON.parse(storedState);
                        // Merge loaded state, ensuring new properties have defaults if missing
                        state = { ...DEFAULT_STATE, ...loadedState };
                        
                        // Re-calculate timeElapsed/pomodoroTimeRemaining if the timer was running when closed
                        if (state.isRunning && state.startTime) {
                            const timeSinceStart = (Date.now() - state.startTime) / 1000;
                            
                            if (state.isPomodoroActive) {
                                // For Pomodoro, subtract the time difference from remaining time
                                state.pomodoroTimeRemaining = Math.max(0, state.pomodoroTimeRemaining - timeSinceStart);
                            } else {
                                // For free-form, add the time difference to elapsed time
                                state.timeElapsed += timeSinceStart;
                            }
                            // state.isRunning = false; // <-- REMOVED THIS LINE
                        }
                    }
                } catch (error) {
                    console.error("Error loading state from localStorage:", error);
                    state = { ...DEFAULT_STATE };
                }
                
                // --- STREAK RESET CHECK ON LOAD ---
                const now = new Date();
                const todayKey = getFormattedDate(now.toISOString());
                const lastActiveKey = state.lastActiveDate ? getFormattedDate(state.lastActiveDate) : null;
                
                if (lastActiveKey && lastActiveKey !== todayKey) {
                    // Get the date key for yesterday
                    const yesterday = new Date(now.setDate(now.getDate() - 1));
                    const yesterdayKey = getFormattedDate(yesterday.toISOString());
                    
                    // Streak is broken if the last active day was NOT yesterday.
                    if (lastActiveKey !== yesterdayKey) {
                        console.log(`Daily streak broken. Last activity on ${lastActiveKey}. Resetting streak from ${state.currentDailyStreak} to 0.`);
                        state.currentDailyStreak = 0;
                    } 
                    
                    // If the date changed, reset the daily time logged for today (to start fresh)
                    state.dailyTimeLogged = 0; 
                } 
                // --- END STREAK RESET CHECK ---

                // Calculate initial stats after loading
                calculateAllStats();
            }

            /** Saves the current essential state to localStorage. */
            function saveState() {
                try {
                    const stateToSave = {
                        isRunning: state.isRunning,
                        timeElapsed: state.timeElapsed,
                        startTime: state.startTime,
                        currentSubject: state.currentSubject,
                        sessionGoal: D.taskInput ? D.taskInput.value : state.sessionGoal,
                        sessions: state.sessions,
                        tasks: state.tasks,
                        currentPage: state.currentPage,
                        totalFocusTime: state.totalFocusTime,
                        isPomodoroActive: state.isPomodoroActive,
                        pomodoroMode: state.pomodoroMode,
                        pomodoroTimeRemaining: state.pomodoroTimeRemaining,
                        subjects: state.subjects, // SAVE DYNAMIC SUBJECTS
                        
                        // NEW DAILY STREAK AND GOAL MANAGEMENT
                        currentDailyStreak: state.currentDailyStreak,
                        lastActiveDate: state.lastActiveDate,
                        dailyFocusGoalMinutes: state.dailyFocusGoalMinutes,
                        dailyTimeLogged: state.dailyTimeLogged,
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
                } catch (error) {
                    console.error("Error saving state to localStorage:", error);
                }
            }
            
            // --- TIME & DATE UTILITIES ---

            /** Formats seconds into H:MM:SS string. */
            function formatTime(totalSeconds, includeHours) {
                const totalSec = Math.max(0, Math.floor(totalSeconds)); // Ensure it's not negative
                const hours = Math.floor(totalSec / 3600);
                const minutes = Math.floor((totalSec % 3600) / 60);
                const seconds = Math.floor(totalSec % 60);

                const minutesStr = minutes.toString().padStart(2, '0');
                const secondsStr = seconds.toString().padStart(2, '0');
                
                if (includeHours || hours > 0) {
                    const hoursStr = hours.toString().padStart(2, '0');
                    return `${hoursStr}:${minutesStr}:${secondsStr}`;
                }
                
                // Special case for Pomodoro break: don't show hours if not needed
                if (totalSec < 3600) { 
                    return `${minutesStr}:${secondsStr}`;
                }
                
                return `${minutesStr}:${secondsStr}`;
            }

            // Helper for formatting time in minutes/hours
            const formatMinutes = (seconds) => {
                const totalMinutes = Math.floor(seconds / 60);
                if (totalMinutes < 60) return `${totalMinutes} min`;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m`;
            };
            
            // Helper for weekly/monthly comparisons
            function formatComparison(current, previous, unit) {
                if (previous === 0) {
                    return `<span class="text-gray-400">No previous ${unit} data</span>`;
                }
                
                const change = current - previous;
                const percentChange = (change / previous) * 100;
                const formattedPercent = Math.abs(percentChange).toFixed(0);
                
                let icon = 'minus';
                let color = 'text-gray-400';
                let direction = 'No change';

                if (Math.abs(percentChange) < 1) { // Treat very small change as 'No change'
                     return `<span class="text-gray-400">Same as last ${unit}</span>`;
                }

                if (percentChange > 0) {
                    icon = 'arrow-up-right';
                    color = 'text-emerald-400';
                    direction = 'Up';
                } else if (percentChange < 0) {
                    icon = 'arrow-down-right';
                    color = 'text-red-400';
                    direction = 'Down';
                }

                return `<span class="${color} flex items-center">
                    <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i> ${direction} ${formattedPercent}%
                </span>`;
            }

            /** Extracts the date part (YYYY-MM-DD) from an ISO string. */
            function getFormattedDate(isoString) {
                if (!isoString) return null;
                 // Safely handles both 'YYYY-MM-DDTHH:MM:SS...' and 'YYYY-MM-DD'
                return isoString.split('T')[0]; 
            }

            /** Converts YYYY-MM-DD to a more readable format (e.g., Oct 18, 2025) */
            function formatDateForDisplay(dateKey) {
                const date = new Date(dateKey + 'T00:00:00'); // Use T00:00:00 to prevent timezone issues
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    timeZone: 'UTC' // Important for consistent date rendering
                });
            }

            // UPDATED to use state.subjects
            function getSubjectColorClass(subjectId) {
                const subject = state.subjects.find(s => s.id === subjectId);
                return subject ? `text-${subject.color}-400` : 'text-gray-400';
            }
            
            function getSubjectBgColorClass(subjectId) {
                const subject = state.subjects.find(s => s.id === subjectId);
                return subject ? `bg-${subject.color}-600` : 'bg-gray-600';
            }
            
            function getSubjectBorderColorClass(subjectId) {
                const subject = state.subjects.find(s => s.id === subjectId);
                return subject ? `border-${subject.color}-300` : 'border-gray-300';
            }
            
            function getSubjectName(subjectId) {
                const subject = state.subjects.find(s => s.id === subjectId);
                return subject ? subject.name : 'Unknown Subject';
            }

            /** Get the start of the specified period (month/week/prevMonth/prevWeek) */
            function getPeriodStart(period, referenceDate = new Date()) {
                const date = new Date(referenceDate.getTime());
                date.setHours(0, 0, 0, 0);

                if (period === 'week') {
                    // Set to the start of the current week (Monday)
                    let day = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                    day = day === 0 ? 6 : day - 1; // Convert to 0=Mon, 6=Sun
                    date.setDate(date.getDate() - day);
                    return date;
                } else if (period === 'prevWeek') {
                    const startOfWeek = getPeriodStart('week', referenceDate);
                    startOfWeek.setDate(startOfWeek.getDate() - 7);
                    return startOfWeek;
                } else if (period === 'month') {
                    // Set to the 1st day of the current month
                    date.setDate(1);
                    return date;
                } else if (period === 'prevMonth') {
                    // Set to the 1st day of the month before the current one
                    date.setDate(1);
                    date.setMonth(date.getMonth() - 1);
                    return date;
                }
                
                // Return a very old date for overall calculation
                return new Date(0);
            }

            // --- ACHIEVEMENT/PROGRESS CALCULATION LOGIC ---

            function calculateAllStats() {
                const now = new Date();
                
                // Set the current date to midnight for consistent comparison (Local time)
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                
                const startOfWeek = getPeriodStart('week', now).getTime();
                const startOfPrevWeek = getPeriodStart('prevWeek', now).getTime();
                const startOfMonth = getPeriodStart('month', now).getTime();
                const startOfPrevMonth = getPeriodStart('prevMonth', now).getTime();

                let overallTime = 0;
                let monthlyTime = 0;
                let prevMonthlyTime = 0;
                let weeklyTime = 0;
                let prevWeeklyTime = 0;
                let dailyTimeInWeek = Array(7).fill(0); // Index 0=Mon, 6=Sun
                let totalSessionsCount = 0;

                // 1. Calculate Time Metrics
                state.sessions.forEach(session => {
                    const sessionTime = new Date(session.timestamp).getTime();
                    const duration = session.durationSeconds;

                    overallTime += duration;
                    totalSessionsCount += 1;

                    if (sessionTime >= startOfMonth) {
                        monthlyTime += duration;
                    }
                    if (sessionTime >= startOfPrevMonth && sessionTime < startOfMonth) {
                        prevMonthlyTime += duration;
                    }

                    if (sessionTime >= startOfWeek) {
                        weeklyTime += duration;
                        
                        // Calculate day index (0=Mon, 6=Sun)
                        const date = new Date(sessionTime);
                        let day = date.getDay(); 
                        day = day === 0 ? 6 : day - 1; // Convert 0(Sun) to 6, 1(Mon) to 0
                        dailyTimeInWeek[day] += duration;
                    }
                    if (sessionTime >= startOfPrevWeek && sessionTime < startOfWeek) {
                        prevWeeklyTime += duration;
                    }
                });
                
                // 2. Calculate Task Metrics
                const tasksCompleted = state.tasks.filter(t => t.completed).length;
                const totalTasks = state.tasks.length;
                const efficiency = totalTasks > 0 ? (tasksCompleted / totalTasks) * 100 : 0;
                
                // 3. Calculate Average/Efficiency Metrics
                // Calculate number of unique days logged
                const loggedDates = new Set(state.sessions.map(s => getFormattedDate(s.timestamp)));
                const daysLogged = loggedDates.size;
                const avgDailyHours = daysLogged > 0 ? (overallTime / 3600) / daysLogged : 0;
                const avgSessionLengthSeconds = totalSessionsCount > 0 ? overallTime / totalSessionsCount : 0;
                
                // 4. Update Stats Object
                stats = {
                    overallTime,
                    monthlyTime,
                    weeklyTime,
                    prevMonthlyTime,
                    prevWeeklyTime,
                    dailyTimeInWeek,
                    tasksCompleted,
                    totalTasks,
                    efficiency,
                    avgDailyHours,
                    avgSessionLengthSeconds,
                    achievements: calculateAchievements(overallTime, tasksCompleted),
                };

                // 5. Update Daily Time Logged
                const todayKey = getFormattedDate(now.toISOString());
                const todaysSessions = state.sessions.filter(s => getFormattedDate(s.timestamp) === todayKey);
                state.dailyTimeLogged = todaysSessions.reduce((sum, session) => sum + session.durationSeconds, 0);

                // Re-calculate streak progress
                renderStreakProgress();
            }

            // Calculates which achievements have been unlocked
            function calculateAchievements(totalFocusSeconds, tasksCompleted) {
                const totalFocusMinutes = totalFocusSeconds / 60;
                const unlocked = {};

                ACHIEVEMENTS_CONFIG.forEach(achievement => {
                    let progressValue = 0;
                    
                    if (achievement.unit === 'minutes') {
                        progressValue = totalFocusMinutes;
                    } else if (achievement.unit === 'tasks') {
                        progressValue = tasksCompleted;
                    }

                    if (progressValue >= achievement.goal) {
                        unlocked[achievement.id] = true;
                    } else {
                        unlocked[achievement.id] = false;
                    }
                });
                
                return unlocked;
            }

            // --- TIMER LOGIC ---

            /** Renders the time display and updates button states. */
            function renderUI() {
                let timeToDisplay;
                let startBtnIcon;
                let startBtnColor = 'bg-green-500 hover:bg-green-600';
                let timerTitleText = 'Focused Subject Tracker';
                
                if (state.isPomodoroActive) {
                    timeToDisplay = state.pomodoroTimeRemaining;
                    const modeText = state.pomodoroMode === 'focus' ? 'Focus Time' : 'Break Time';
                    timerTitleText = `Pomodoro: ${modeText}`;

                    if (state.isRunning) {
                        startBtnIcon = 'pause';
                        startBtnColor = 'bg-red-500 hover:bg-red-600';
                        D.pomodoroBtn.classList.add('bg-indigo-600/70', 'hover:bg-indigo-700/70');
                        D.pomodoroBtn.classList.remove('bg-gray-700/50', 'hover:bg-gray-600/70');
                    } else {
                        startBtnIcon = 'play';
                        D.pomodoroBtn.classList.remove('bg-indigo-600/70', 'hover:bg-indigo-700/70');
                        D.pomodoroBtn.classList.add('bg-gray-700/50', 'hover:bg-gray-600/70');
                    }
                } else {
                    timeToDisplay = state.timeElapsed;
                    
                    if (state.isRunning) {
                        startBtnIcon = 'pause';
                        startBtnColor = 'bg-red-500 hover:bg-red-600';
                        D.pomodoroBtn.classList.remove('bg-indigo-600/70', 'hover:bg-indigo-700/70');
                        D.pomodoroBtn.classList.add('bg-gray-700/50', 'hover:bg-gray-600/70');
                    } else {
                        startBtnIcon = 'play';
                    }
                }

                // Update displays
                D.timeDisplay.textContent = formatTime(timeToDisplay, true);
                D.fullscreenTimeDisplay.textContent = formatTime(timeToDisplay, true);
                D.timerTitle.textContent = timerTitleText;
                
                // Update buttons
                D.startPauseBtn.innerHTML = `<i data-lucide="${startBtnIcon}" class="w-6 h-6"></i>`;
                D.startPauseBtn.className = `p-4 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 ${startBtnColor}`;
                D.resetBtn.disabled = (state.timeElapsed === 0 && !state.isPomodoroActive) ;
                
                // Render subject selector whenever the timer card is rendered
                setupSubjectSelector();
                renderStreakProgress();

                window.createLucideIcons(); // Re-render icons
            }
            
            /** Core timer update function called every second. */
            function updateTimer() {
                if (!state.isRunning) return;

                if (state.isPomodoroActive) {
                    state.pomodoroTimeRemaining = Math.max(0, state.pomodoroTimeRemaining - 1);
                    state.startTime = Date.now(); // Keep start time updated for next load
                    
                    if (state.pomodoroTimeRemaining === 0) {
                        handlePomodoroCompletion();
                    }
                } else {
                    const now = Date.now();
                    const secondsPassed = Math.floor((now - state.startTime) / 1000);
                    state.timeElapsed += secondsPassed;
                    state.startTime = now; // Reset start time for accurate next interval
                }

                // Log focus time every second if in focus mode
                if (!state.isPomodoroActive || state.pomodoroMode === 'focus') {
                    state.totalFocusTime += 1;
                    state.dailyTimeLogged += 1;
                    renderStreakProgress();
                }

                renderUI();
                saveState();
            }

            /** Starts the timer and the interval. */
            function startTimer() {
                if (state.isRunning) return;

                state.isRunning = true;
                state.startTime = Date.now() - (state.isPomodoroActive ? (POMODORO_FOCUS_SECONDS - state.pomodoroTimeRemaining) : 0); // Initialize start time

                // Update session goal state only when starting a free-form timer
                if (!state.isPomodoroActive) {
                    state.sessionGoal = D.taskInput.value.trim();
                }

                intervalId = setInterval(updateTimer, 1000);
                
                // Start music playback if enabled
                if (D.musicPlayer && D.musicPlayer.src && D.musicPlayer.paused) {
                    D.musicPlayer.play().catch(e => console.log('Music playback failed:', e));
                }

                renderUI();
                saveState();
            }

            /** Stops the timer and clears the interval. */
            function stopTimer() {
                if (!state.isRunning) return;

                state.isRunning = false;
                clearInterval(intervalId);
                intervalId = null;
                
                // Pause music playback
                if (D.musicPlayer) {
                    D.musicPlayer.pause();
                }
                
                // Log session if in free-form mode and time elapsed is > 0
                if (!state.isPomodoroActive && state.timeElapsed > 0) {
                    logSession();
                }
                
                // Ensure pomodoro time is logged if focus mode was interrupted
                if (state.isPomodoroActive && state.pomodoroMode === 'focus') {
                     // If a focus session was running, log the time elapsed before pausing
                    const timeSinceStart = (Date.now() - state.startTime) / 1000;
                    const durationLogged = POMODORO_FOCUS_SECONDS - state.pomodoroTimeRemaining - timeSinceStart;
                    if (durationLogged > 5) { // Only log meaningful chunks of time
                        logPomodoroInterruption(durationLogged);
                    }
                    // The rest of the state is saved in saveState()
                }

                renderUI();
                saveState();
            }

            /** Resets the timer to 0 and logs the session if time elapsed > 0. */
            function resetTimer() {
                stopTimer(); // Stops timer, logs free-form session if any
                
                // Reset common state
                state.timeElapsed = 0;
                state.sessionGoal = '';
                D.taskInput.value = '';
                state.startTime = null;
                
                // Reset Pomodoro state
                if (state.isPomodoroActive) {
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                }
                
                // Re-render UI to show reset time
                renderUI();
                saveState();
            }
            
            // Toggles between Pomodoro mode and free-form timer
            function togglePomodoro() {
                if (state.isRunning) {
                    // Force stop and log current session before switching modes
                    stopTimer(); 
                }
                
                state.isPomodoroActive = !state.isPomodoroActive;
                
                if (state.isPomodoroActive) {
                    // Switch to Pomodoro defaults
                    state.timeElapsed = 0; // Clear free-form time
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                    state.sessionGoal = 'Focus Session (Pomodoro)';
                    D.taskInput.value = 'Focus Session (Pomodoro)';
                } else {
                    // Switch to free-form defaults
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                    state.sessionGoal = '';
                    D.taskInput.value = '';
                }
                
                renderUI();
                saveState();
            }
            
            // Handles the end of a Pomodoro segment (Focus or Break)
            function handlePomodoroCompletion() {
                // Stop the timer
                stopTimer();
                
                const now = new Date().toISOString();
                
                if (state.pomodoroMode === 'focus') {
                    // Log the full focus session
                    logSession(POMODORO_FOCUS_SECONDS, now);
                    
                    // Switch to break mode
                    state.pomodoroMode = 'break';
                    state.pomodoroTimeRemaining = POMODORO_BREAK_SECONDS;
                    
                    // Show alert and notification
                    alert('Focus session complete! Time for a short break.');
                    notifyUser('Break Time', 'Your 5-minute break has started. Stand up and stretch!');
                    
                    // Automatically start break
                    startTimer(); 
                    
                } else if (state.pomodoroMode === 'break') {
                    // Switch back to focus mode
                    state.pomodoroMode = 'focus';
                    state.pomodoroTimeRemaining = POMODORO_FOCUS_SECONDS;
                    
                    // Show alert and notification
                    alert('Break complete! Time to get back to focus.');
                    notifyUser('Focus Time', 'Your next focus session has started. Let\'s go!');

                    // Automatically start focus
                    startTimer(); 
                }
                
                // Recalculate stats after logging the session
                calculateAllStats(); 
                
                renderUI();
                saveState();
            }
            
            // Logs a session for free-form or a completed Pomodoro focus segment
            function logSession(duration = state.timeElapsed, timestamp = new Date().toISOString()) {
                if (duration < 60) return; // Only log sessions longer than 60 seconds (1 minute)

                const session = {
                    id: Date.now(),
                    timestamp: timestamp,
                    durationSeconds: duration,
                    subjectId: state.currentSubject,
                    goal: state.sessionGoal || 'N/A',
                };

                state.sessions.unshift(session);
                
                // Check and update daily streak after logging a focus session (Pomodoro or free-form)
                updateDailyStreak(duration);

                // Recalculate stats for achievements and progress
                calculateAllStats();
                
                // Re-render history and daily summary on the History tab
                renderHistory();
                renderAchievements(); // Update achievements instantly

                // Reset only the free-form time (Pomodoro mode handles its own reset)
                if (!state.isPomodoroActive) {
                    state.timeElapsed = 0;
                    state.sessionGoal = '';
                    D.taskInput.value = '';
                }
            }
            
            // Logs a session if a Pomodoro focus segment was interrupted/paused
            function logPomodoroInterruption(duration) {
                if (duration < 60) return; // Only log meaningful chunks of time

                const session = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    durationSeconds: duration,
                    subjectId: state.currentSubject,
                    goal: state.sessionGoal + ' (Interrupted Pomodoro)',
                };
                
                state.sessions.unshift(session);
                updateDailyStreak(duration);
                calculateAllStats();
                renderHistory();
                renderAchievements(); 
            }
            
            // --- DAILY STREAK LOGIC ---
            
            /** Updates the daily streak based on the time logged. */
            function updateDailyStreak(loggedDurationSeconds) {
                const now = new Date();
                const todayKey = getFormattedDate(now.toISOString());
                const lastActiveKey = state.lastActiveDate ? getFormattedDate(state.lastActiveDate) : null;
                const goalSeconds = state.dailyFocusGoalMinutes * 60;
                
                // The current day's time is updated in calculateAllStats(), so we only need to check the streak logic here.
                
                const isGoalMetToday = state.dailyTimeLogged >= goalSeconds;

                if (isGoalMetToday) {
                    // Check if the streak was just broken or needs to be maintained/started
                    if (!lastActiveKey || lastActiveKey !== todayKey) {
                        // Check if yesterday's goal was met to maintain the streak
                        const yesterday = new Date(now.getTime());
                        yesterday.setDate(now.getDate() - 1);
                        const yesterdayKey = getFormattedDate(yesterday.toISOString());
                        
                        // Find total focus time for yesterday
                        const yesterdayTimeLogged = state.sessions
                            .filter(s => getFormattedDate(s.timestamp) === yesterdayKey)
                            .reduce((sum, session) => sum + session.durationSeconds, 0);
                        
                        const wasYesterdayMet = yesterdayTimeLogged >= goalSeconds;
                        
                        if (lastActiveKey === yesterdayKey && wasYesterdayMet) {
                            // Streak maintained
                            state.currentDailyStreak += 1;
                        } else if (lastActiveKey && lastActiveKey !== yesterdayKey) {
                            // Streak broken (handled in loadState for a full day gap)
                            // If user is meeting goal today, start new streak
                            if (state.dailyTimeLogged > 0) {
                                state.currentDailyStreak = 1;
                            }
                        } else {
                            // First session of the app, or first session after a long break
                            state.currentDailyStreak = 1;
                        }
                    }
                } 
                // Note: Streak is only reset to 0 in loadState if a day has been missed. 
                
                state.lastActiveDate = todayKey; // Set to today if any session was logged
                saveState();
            }

            /** Renders the daily streak progress bar and count. */
            function renderStreakProgress() {
                const goalSeconds = state.dailyFocusGoalMinutes * 60;
                const progressSeconds = Math.min(state.dailyTimeLogged, goalSeconds);
                const progressPercent = Math.min(100, (progressSeconds / goalSeconds) * 100);
                
                const progressOffset = CIRCLE_CIRCUMFERENCE * (1 - (progressPercent / 100));
                
                D.streakProgressBar.style.strokeDashoffset = progressOffset;
                D.streakProgressPercent.textContent = `${Math.floor(progressPercent)}%`;
                D.streakCount.textContent = state.currentDailyStreak.toString();
                
                if (progressPercent >= 100) {
                     D.nextStreakInfo.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 mr-1 inline text-emerald-400"></i> Daily goal met! Good job.`;
                     D.streakProgressBar.classList.add('text-green-500');
                     D.streakProgressBar.classList.remove('text-emerald-400');
                } else {
                    const remainingSeconds = goalSeconds - progressSeconds;
                    D.nextStreakInfo.innerHTML = `Need ${formatMinutes(remainingSeconds)} more to keep the streak.`;
                    D.streakProgressBar.classList.add('text-emerald-400');
                    D.streakProgressBar.classList.remove('text-green-500');
                }
                
                window.createLucideIcons();
            }

            /** Updates the daily goal from the settings input. */
            function updateDailyGoal(minutes) {
                const newGoal = parseInt(minutes);
                if (newGoal >= 5) {
                    state.dailyFocusGoalMinutes = newGoal;
                    saveState();
                    calculateAllStats(); // Recalculate streak progress immediately
                } else {
                    state.dailyFocusGoalMinutes = 5;
                    D.dailyGoalInput.value = 5;
                    saveState();
                    calculateAllStats();
                    alert('Daily goal must be at least 5 minutes.');
                }
                renderStreakProgress();
            }
            
            // --- SUBJECT MANAGEMENT LOGIC ---

            /** Generates the subject selector for the timer view. */
            function setupSubjectSelector() {
                const selector = D.subjectSelector;
                selector.innerHTML = ''; // Clear existing buttons
                
                state.subjects.forEach(subject => {
                    const isChecked = state.currentSubject === subject.id;
                    const colorClass = `bg-${subject.color}-600`;
                    const hoverColorClass = `hover:bg-${subject.color}-700`;
                    const checkedColorClass = `bg-${subject.color}-600`;

                    const html = `
                        <input type="radio" id="subject-${subject.id}" name="subject" value="${subject.id}" class="hidden subject-radio" ${isChecked ? 'checked' : ''}>
                        <label for="subject-${subject.id}" 
                               class="py-2 px-4 rounded-full text-sm font-medium transition-colors cursor-pointer 
                               bg-gray-700/50 text-gray-300 border-2 border-transparent ${hoverColorClass}"
                               onclick="selectSubject('${subject.id}')">
                            ${subject.name}
                        </label>
                    `;
                    selector.innerHTML += html;
                });
            }

            /** Updates the state when a new subject is selected. */
            function selectSubject(subjectId) {
                state.currentSubject = subjectId;
                saveState();
                // Ensure UI reflects the change (especially if the radio style needs it)
                // The radio button itself handles the style via CSS, but we ensure the state is saved.
            }

            // Handles adding a new subject from the settings view
            function addSubjectHandler() {
                const name = D.newSubjectInput.value.trim();
                if (!name) return;

                // Simple sanitization and ID generation
                const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                
                if (state.subjects.some(s => s.id === id)) {
                    alert('Subject already exists!');
                    return;
                }
                
                // Cycle through colors
                const color = SUBJECT_COLORS[state.subjects.length % SUBJECT_COLORS.length];
                
                const newSubject = { id, name, color };
                state.subjects.push(newSubject);
                
                D.newSubjectInput.value = '';
                saveState();
                renderSubjectsManager(); // Re-render the settings list
                setupSubjectSelector(); // Update the timer's subject selector
            }

            // Renders the list of subjects in the settings view
            function renderSubjectsManager() {
                D.subjectsListManager.innerHTML = '';
                
                state.subjects.forEach(subject => {
                    const colorClass = `text-${subject.color}-400`;
                    const html = `
                        <div class="flex items-center justify-between p-3 glass-base rounded-full bg-gray-700/30">
                            <span class="flex items-center text-lg font-medium ${colorClass}">
                                <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>
                                ${subject.name}
                            </span>
                            <button 
                                onclick="deleteSubject('${subject.id}')"
                                class="p-2 rounded-full text-red-400 hover:bg-red-900/50 transition-colors"
                                title="Delete Subject"
                            >
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
                    D.subjectsListManager.innerHTML += html;
                });
                
                window.createLucideIcons();
            }

            // Deletes a subject from the list
            function deleteSubject(subjectId) {
                if (state.subjects.length === 1) {
                    alert('You must have at least one subject.');
                    return;
                }

                if (confirm(`Are you sure you want to delete the subject "${getSubjectName(subjectId)}"? This will not delete past sessions.`)) {
                    state.subjects = state.subjects.filter(s => s.id !== subjectId);
                    
                    // If the deleted subject was the current one, switch to the first remaining subject
                    if (state.currentSubject === subjectId) {
                        state.currentSubject = state.subjects[0].id;
                    }

                    saveState();
                    renderSubjectsManager();
                    setupSubjectSelector(); // Update the timer's subject selector
                }
            }


            // --- HISTORY LOGIC ---

            /** Renders the history list for the timer view and updates the history date selector. */
            function renderHistory() {
                D.historyList.innerHTML = '';
                
                if (state.sessions.length === 0) {
                    D.noHistory.classList.remove('hidden');
                    D.dateSelector.innerHTML = '<option value="">No sessions logged</option>';
                    D.dailySummaryContainer.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>';
                    return;
                }
                
                D.noHistory.classList.add('hidden');
                
                // 1. Render recent sessions (Timer View)
                const recentSessions = state.sessions.slice(0, 5); 
                recentSessions.forEach(session => {
                    const durationStr = formatMinutes(session.durationSeconds);
                    const subjectName = getSubjectName(session.subjectId);
                    const colorClass = getSubjectColorClass(session.subjectId);

                    const html = `
                        <div class="flex justify-between items-center p-3 glass-base rounded-xl bg-gray-700/30">
                            <div class="truncate">
                                <span class="block text-sm font-semibold ${colorClass}">${subjectName}</span>
                                <span class="block text-xs text-gray-400 truncate">${session.goal}</span>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                                <span class="text-lg font-bold tabular-nums">${durationStr}</span>
                                <button onclick="showSessionDetails(${session.id})" class="text-gray-400 hover:text-indigo-400 transition-colors p-1 rounded-full">
                                    <i data-lucide="info" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    D.historyList.innerHTML += html;
                });
                
                // 2. Populate date selector (History View)
                const uniqueDates = [...new Set(state.sessions.map(s => getFormattedDate(s.timestamp)))].sort().reverse();
                
                // Preserve current selection if possible
                const currentSelectedDate = D.dateSelector.value;
                
                D.dateSelector.innerHTML = '<option value="">Select a day...</option>';
                uniqueDates.forEach(dateKey => {
                    const dateDisplay = formatDateForDisplay(dateKey);
                    const isSelected = dateKey === currentSelectedDate;
                    D.dateSelector.innerHTML += `<option value="${dateKey}" ${isSelected ? 'selected' : ''}>${dateDisplay}</option>`;
                });
                
                // Auto-render the last selected or the first date
                if (currentSelectedDate && uniqueDates.includes(currentSelectedDate)) {
                    renderDailySummary(currentSelectedDate);
                } else if (uniqueDates.length > 0) {
                    D.dateSelector.value = uniqueDates[0];
                    renderDailySummary(uniqueDates[0]);
                } else {
                    D.dailySummaryContainer.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>';
                }
                
                window.createLucideIcons();
            }

            /** Shows the detailed information for a specific session in a modal. */
            function showSessionDetails(sessionId) {
                const session = state.sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                const date = new Date(session.timestamp);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString();
                const durationStr = formatTime(session.durationSeconds, true);
                const subjectName = getSubjectName(session.subjectId);
                
                const content = `
                Date: ${dateStr}
                Time: ${timeStr}
                Duration: ${durationStr}
                Subject: ${subjectName}
                Goal: ${session.goal}
                `;

                D.modalContent.textContent = content;
                D.detailsModal.classList.remove('hidden');
            }

            /** Handler for when a new date is selected in the History view. */
            function handleDateChange(dateKey) {
                if (dateKey) {
                    renderDailySummary(dateKey);
                } else {
                    D.dailySummaryContainer.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Select a date above to view your summary.</p>';
                }
            }

            /** Renders the summary of sessions for a selected day in the History view. */
            function renderDailySummary(dateKey) {
                const dailySessions = state.sessions.filter(s => getFormattedDate(s.timestamp) === dateKey);
                const totalDailyTime = dailySessions.reduce((sum, s) => sum + s.durationSeconds, 0);
                const totalDailyTimeStr = formatMinutes(totalDailyTime);
                const dateDisplay = formatDateForDisplay(dateKey);
                
                // 1. Summary Header
                let summaryHTML = `
                    <div class="p-4 rounded-xl bg-indigo-900/30 border-2 border-indigo-700/50 text-center mb-6">
                        <h2 class="text-xl font-bold text-indigo-300 mb-1">Summary for ${dateDisplay}</h2>
                        <p class="text-3xl font-extrabold text-indigo-400 tabular-nums">${totalDailyTimeStr} Focused</p>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2 flex items-center">
                        <i data-lucide="list" class="w-5 h-5 mr-2"></i> All Sessions (${dailySessions.length})
                    </h3>
                `;
                
                // 2. Sessions List
                dailySessions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort newest first
                dailySessions.forEach(session => {
                    const time = new Date(session.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const durationStr = formatMinutes(session.durationSeconds);
                    const subjectName = getSubjectName(session.subjectId);
                    const colorClass = getSubjectColorClass(session.subjectId);
                    
                    summaryHTML += `
                        <div class="flex justify-between items-center p-3 glass-base rounded-xl bg-gray-700/30">
                            <div class="truncate">
                                <span class="block text-sm font-semibold ${colorClass}">${subjectName} <span class="text-gray-400 text-xs">@ ${time}</span></span>
                                <span class="block text-xs text-gray-400 truncate">${session.goal}</span>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                                <span class="text-lg font-bold tabular-nums">${durationStr}</span>
                                <button onclick="showSessionDetails(${session.id})" class="text-gray-400 hover:text-indigo-400 transition-colors p-1 rounded-full">
                                    <i data-lucide="info" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                D.dailySummaryContainer.innerHTML = summaryHTML;
                window.createLucideIcons();
            }

            // --- TASK LOGIC ---

            function addTask() {
                const taskText = D.taskInputNew.value.trim();
                if (!taskText) return;

                const newTask = {
                    id: Date.now(),
                    text: taskText,
                    completed: false,
                    timestamp: new Date().toISOString(),
                };

                state.tasks.unshift(newTask); // Add to the top
                D.taskInputNew.value = '';
                saveState();
                calculateAllStats(); // Update task stats
                renderTasks();
            }

            function toggleTaskCompletion(taskId) {
                const task = state.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    saveState();
                    calculateAllStats(); // Update task stats/achievements
                    renderTasks();
                    renderAchievements(); // Re-render achievements page
                }
            }

            function deleteTask(taskId) {
                state.tasks = state.tasks.filter(t => t.id !== taskId);
                saveState();
                calculateAllStats(); // Update task stats
                renderTasks();
                renderAchievements(); // Re-render achievements page
            }
            
            function renderTasks() {
                D.tasksListContainer.innerHTML = '';
                
                if (state.tasks.length === 0) {
                    D.tasksListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">You have no tasks. Add one above!</p>';
                    return;
                }
                
                // Separate into uncompleted and completed tasks
                const uncompleted = state.tasks.filter(t => !t.completed);
                const completed = state.tasks.filter(t => t.completed).sort((a, b) => b.id - a.id); // Newest completed first
                
                const taskList = [...uncompleted, ...completed];

                taskList.forEach(task => {
                    const checkedClass = task.completed ? 'opacity-50 line-through' : '';
                    const dateAdded = formatDateForDisplay(getFormattedDate(task.timestamp));
                    
                    const html = `
                        <div class="flex items-center p-3 glass-base rounded-xl bg-gray-800/30 transition-shadow">
                            <input 
                                type="checkbox" 
                                id="task-${task.id}" 
                                class="task-checkbox flex-shrink-0"
                                ${task.completed ? 'checked' : ''} 
                                onclick="toggleTaskCompletion(${task.id})"
                            >
                            
                            <label for="task-${task.id}" class="ml-4 flex-grow cursor-pointer ${checkedClass}">
                                <span class="block text-white font-medium">${task.text}</span>
                                <span class="block text-xs text-gray-500">Added: ${dateAdded}</span>
                            </label>
                            
                            <button onclick="deleteTask(${task.id})" class="p-2 rounded-full text-red-400 hover:bg-red-900/50 transition-colors ml-3 flex-shrink-0" title="Delete Task">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
                    D.tasksListContainer.innerHTML += html;
                });
                
                window.createLucideIcons();
            }
            
            // --- ACHIEVEMENTS LOGIC ---
            
            function renderAchievements() {
                D.trophiesContainer.innerHTML = '';
                
                if (Object.keys(stats.achievements).length === 0) {
                    D.trophiesContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">No achievement configuration found.</p>';
                    return;
                }
                
                ACHIEVEMENTS_CONFIG.forEach(achievement => {
                    const isUnlocked = stats.achievements[achievement.id];
                    
                    let progressValue = 0;
                    if (achievement.unit === 'minutes') {
                        progressValue = stats.overallTime / 60;
                    } else if (achievement.unit === 'tasks') {
                        progressValue = stats.tasksCompleted;
                    }

                    const progressPercent = Math.min(100, (progressValue / achievement.goal) * 100);
                    const progressStr = achievement.unit === 'minutes' ? formatMinutes(progressValue * 60) : progressValue;
                    
                    let iconClass = isUnlocked ? achievement.color : 'text-gray-600';
                    let statusText = isUnlocked ? 'UNLOCKED' : 'In Progress';
                    let statusColor = isUnlocked ? 'text-emerald-400' : 'text-yellow-400';
                    let backgroundClass = isUnlocked ? 'bg-emerald-900/30 border-emerald-500/50' : 'bg-gray-800/30 border-gray-700/50';

                    const html = `
                        <div class="glass-base p-5 rounded-2xl shadow-xl ${backgroundClass}">
                            <div class="flex items-center mb-3">
                                <i data-lucide="${achievement.icon}" class="w-10 h-10 ${iconClass} mr-4"></i>
                                <div>
                                    <h3 class="text-lg font-bold">${achievement.name}</h3>
                                    <p class="text-xs ${statusColor} font-semibold">${statusText}</p>
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm mb-3">${achievement.description}</p>
                            
                            ${!isUnlocked ? `
                            <div class="mt-4">
                                <div class="flex justify-between text-xs font-semibold mb-1 text-gray-300">
                                    <span>${progressStr} / ${achievement.goal} ${achievement.unit}</span>
                                    <span>${Math.floor(progressPercent)}%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full ${isUnlocked ? 'bg-emerald-500' : 'bg-yellow-500'}" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    D.trophiesContainer.innerHTML += html;
                });
                
                window.createLucideIcons();
            }
            
            // --- PROGRESS LOGIC (Charts) ---

            /** Renders all metrics in the Progress view. */
            function renderMetrics() {
                D.metricsContainer.innerHTML = '';
                
                // Format metrics for display
                const metrics = [
                    { 
                        title: 'Total Focus', 
                        value: formatMinutes(stats.overallTime), 
                        icon: 'clock', 
                        color: 'text-indigo-400', 
                        subtitle: 'Overall' 
                    },
                    { 
                        title: 'Weekly Focus', 
                        value: formatMinutes(stats.weeklyTime), 
                        icon: 'calendar-check', 
                        color: 'text-emerald-400', 
                        subtitle: formatComparison(stats.weeklyTime, stats.prevWeeklyTime, 'week') 
                    },
                    { 
                        title: 'Monthly Focus', 
                        value: formatMinutes(stats.monthlyTime), 
                        icon: 'calendar', 
                        color: 'text-sky-400', 
                        subtitle: formatComparison(stats.monthlyTime, stats.prevMonthlyTime, 'month') 
                    },
                    { 
                        title: 'Tasks Completed', 
                        value: stats.tasksCompleted, 
                        icon: 'list-todo', 
                        color: 'text-yellow-400', 
                        subtitle: `Of ${stats.totalTasks} total tasks` 
                    },
                    { 
                        title: 'Task Efficiency', 
                        value: `${stats.efficiency.toFixed(1)}%`, 
                        icon: 'trending-up', 
                        color: 'text-red-400', 
                        subtitle: 'Completed / Total' 
                    },
                    { 
                        title: 'Avg. Session', 
                        value: formatMinutes(stats.avgSessionLengthSeconds), 
                        icon: 'target', 
                        color: 'text-purple-400', 
                        subtitle: 'Per focused session' 
                    },
                ];

                metrics.forEach(metric => {
                    const html = `
                        <div class="glass-base p-4 rounded-xl shadow-lg bg-gray-800/30">
                            <div class="flex items-center mb-2">
                                <i data-lucide="${metric.icon}" class="w-6 h-6 ${metric.color} mr-3"></i>
                                <h3 class="text-lg font-semibold text-gray-300">${metric.title}</h3>
                            </div>
                            <p class="text-3xl font-extrabold tabular-nums text-white mb-1">${metric.value}</p>
                            <p class="text-xs text-gray-500">${metric.subtitle}</p>
                        </div>
                    `;
                    D.metricsContainer.innerHTML += html;
                });
                
                window.createLucideIcons();
            }

            /** Generates mock chart data for the weekly breakdown. */
            function generateWeeklyChartData() {
                // Days are Mon (0) to Sun (6)
                const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const dataHours = stats.dailyTimeInWeek.map(seconds => (seconds / 3600).toFixed(2));

                const chartConfig = {
                    type: 'line', 
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Focus Time (Hours)',
                            data: dataHours,
                            backgroundColor: 'rgba(79, 70, 229, 0.4)', // indigo-600/40
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            fill: true,
                            tension: 0.4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                },
                                ticks: {
                                    color: 'rgb(156, 163, 175)', // gray-400
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                },
                                ticks: {
                                    color: 'rgb(156, 163, 175)', // gray-400
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2) + 'h';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                };

                return chartConfig;
            }

            /** Renders the weekly breakdown chart using Chart.js. */
            function renderWeeklyBreakdown() {
                 D.weeklyBreakdownContainer.innerHTML = `<canvas id="weekly-breakdown-chart"></canvas>`;
                 
                 // Check if Chart.js is loaded
                 if (typeof Chart === 'undefined') {
                    console.warn("Chart.js not loaded. Loading now...");
                    
                    // Dynamically load Chart.js script
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.onload = () => {
                        console.log("Chart.js loaded. Rendering chart.");
                        renderWeeklyBreakdown(); // Call again after load
                    };
                    document.head.appendChild(script);
                    D.weeklyBreakdownContainer.innerHTML = '<p class="text-center text-gray-400">Loading Charting Library...</p>';
                    return;
                 }


                const ctx = document.getElementById('weekly-breakdown-chart').getContext('2d');
                const chartConfig = generateWeeklyChartData();
                
                // Destroy old chart instance if it exists to prevent overlap
                if (window.weeklyChartInstance) {
                    window.weeklyChartInstance.destroy();
                }

                window.weeklyChartInstance = new Chart(ctx, chartConfig);
            }
            
            // --- MUSIC PLAYER LOGIC ---
            
            function initMusicPlayer() {
                if (PLAYLIST.length > 0) {
                    D.musicPlayer.src = PLAYLIST[currentSongIndex];
                    D.musicPlayer.load();
                    D.musicPlayer.volume = 0.5; // Default volume
                    
                    // Set up event listener for when a song ends
                    D.musicPlayer.addEventListener('ended', playNextSong);
                } else {
                    D.musicBtn.classList.add('hidden'); // Hide button if no music is configured
                }
            }
            
            function playNextSong() {
                currentSongIndex = (currentSongIndex + 1) % PLAYLIST.length;
                D.musicPlayer.src = PLAYLIST[currentSongIndex];
                D.musicPlayer.load();
                
                // Only auto-play if the timer is running
                if (state.isRunning) {
                     D.musicPlayer.play().catch(e => console.log('Auto-playback failed:', e));
                }
            }

            function toggleSongPlayback() {
                if (PLAYLIST.length === 0) return;
                
                if (D.musicPlayer.paused) {
                    // If the timer is not running, we must start the timer if music is started manually
                    if (!state.isRunning) {
                         // We do not start the timer, only the music
                    }
                    D.musicPlayer.play().then(() => {
                        D.musicBtn.innerHTML = `<i data-lucide="volume-2" class="w-6 h-6"></i>`;
                        D.musicBtn.classList.add('text-indigo-400');
                        D.musicBtn.classList.remove('text-gray-400');
                        window.createLucideIcons();
                    }).catch(e => {
                        console.error('Playback attempt failed (user interaction required):', e);
                        alert("Music playback requires user interaction. Please click the button again or ensure your browser allows media playback.");
                    });
                } else {
                    D.musicPlayer.pause();
                    D.musicBtn.innerHTML = `<i data-lucide="music" class="w-6 h-6"></i>`;
                    D.musicBtn.classList.remove('text-indigo-400');
                    D.musicBtn.classList.add('text-gray-400');
                    window.createLucideIcons();
                }
            }


            // --- NOTIFICATION LOGIC ---
            
            function notifyUser(title, body) {
                // Check if the browser supports notifications
                if (!("Notification" in window)) {
                    console.warn("This browser does not support desktop notification");
                } 
                // Check whether notification permissions have been granted
                else if (Notification.permission === "granted") {
                    new Notification(title, { body: body, icon: 'icons/apple-touch-icon.png' });
                }
                // Otherwise, we need to ask the user for permission
                else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(function (permission) {
                        if (permission === "granted") {
                             new Notification(title, { body: body, icon: 'icons/apple-touch-icon.png' });
                        }
                    });
                }
            }

            // --- VIEW SWITCHING LOGIC ---

            /** Switches the application view based on the button clicked. */
            function switchPage(page) {
                // Hide all main views
                D.timerView.classList.add('hidden');
                D.tasksView.classList.add('hidden');
                D.historyView.classList.add('hidden');
                D.achievementsView.classList.add('hidden');
                D.progressView.classList.add('hidden');
                D.settingsView.classList.add('hidden');
                
                // Reset all nav buttons
                const navButtons = [D.navTimerBtn, D.navTasksBtn, D.navHistoryBtn, D.navAchievementsBtn, D.navProgressBtn, D.navSettingsBtn];
                navButtons.forEach(btn => {
                    btn.classList.remove('bg-indigo-600');
                    btn.classList.add('bg-gray-700/50', 'hover:bg-gray-700');
                });
                
                // Show the selected view and highlight the button
                let targetView;
                let targetBtn;

                if (page === 'timer') {
                    targetView = D.timerView;
                    targetBtn = D.navTimerBtn;
                    renderUI(); // Refresh timer state
                } else if (page === 'tasks') {
                    targetView = D.tasksView;
                    targetBtn = D.navTasksBtn;
                    renderTasks(); // Render task list
                } else if (page === 'history') {
                    targetView = D.historyView;
                    targetBtn = D.navHistoryBtn;
                    renderHistory(); // Render history summary
                } else if (page === 'achievements') {
                    targetView = D.achievementsView;
                    targetBtn = D.navAchievementsBtn;
                    renderAchievements(); // Render achievement list
                } else if (page === 'progress') {
                    targetView = D.progressView;
                    targetBtn = D.navProgressBtn;
                    renderMetrics();
                    renderWeeklyBreakdown(); // Render chart
                } else if (page === 'settings') {
                    targetView = D.settingsView;
                    targetBtn = D.navSettingsBtn;
                    renderSubjectsManager(); // Render subject settings
                    D.dailyGoalInput.value = state.dailyFocusGoalMinutes; // Update daily goal input
                }
                
                if (targetView) {
                    targetView.classList.remove('hidden');
                }
                
                if (targetBtn) {
                    targetBtn.classList.add('bg-indigo-600');
                    targetBtn.classList.remove('bg-gray-700/50', 'hover:bg-gray-700');
                }
                
                state.currentPage = page;
                saveState();
                window.createLucideIcons();
            }

            // --- FULLSCREEN CLOCK LOGIC ---
            
            function toggleFullscreenClock() {
                const modal = D.fullscreenClockModal;
                const isHidden = modal.classList.contains('hidden');
                
                if (isHidden) {
                    // Display the modal
                    modal.classList.remove('hidden');
                    
                    // Update subject/goal display
                    const subjectName = getSubjectName(state.currentSubject);
                    const goal = D.taskInput.value.trim() || 'No Session Goal';
                    D.fullscreenSubjectGoal.textContent = `${subjectName} | ${goal}`;
                    
                    // Request fullscreen if supported (for better focus)
                    const elem = document.documentElement; // Or modal itself
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => {
                           console.log(`Error attempting to enable fullscreen mode: ${err.message} (${err.name})`);
                        });
                    }
                } else {
                    // Hide the modal
                    modal.classList.add('hidden');
                    
                    // Exit fullscreen if supported
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }


            // --- EXPOSE GLOBAL FUNCTIONS ---
            window.switchPage = switchPage;
            window.togglePomodoro = togglePomodoro;
            window.addTask = addTask;
            window.toggleTaskCompletion = toggleTaskCompletion;
            window.deleteTask = deleteTask;
            window.selectSubject = selectSubject;
            window.updateDailyGoal = updateDailyGoal;
            window.toggleFullscreenClock = toggleFullscreenClock;
            window.toggleSongPlayback = toggleSongPlayback;
            window.handleDateChange = handleDateChange;
            window.renderDailySummary = renderDailySummary; 
            window.showSessionDetails = showSessionDetails;
            window.addSubjectHandler = addSubjectHandler; // Exposed handler
            window.deleteSubject = deleteSubject; // Exposed function
            
            // Handlers for timer buttons 
            window.startPauseHandler = () => {
                if (state.isRunning) {
                    stopTimer();
                } else {
                    startTimer();
                }
            };
            window.resetTimer = resetTimer;

            // --- INITIALIZATION ---
            
            // Execute initialization when the DOM is ready (Replaces the old window.onload logic)
            document.addEventListener('DOMContentLoaded', () => {
                loadState();
                initMusicPlayer(); // Initialize the music player
                
                // Re-start timer if it was running when the app closed
                if (state.isRunning) {
                    startTimer(); // This will also call renderUI
                } else {
                    // Initialize time display with loaded time
                    let timeToDisplay = state.isPomodoroActive ? state.pomodoroTimeRemaining : state.timeElapsed;
                    D.timeDisplay.textContent = formatTime(timeToDisplay, !state.isPomodoroActive);
                    
                    // Also ensure Pomodoro title is correct on load
                    if (state.isPomodoroActive) {
                        const modeText = state.pomodoroMode === 'focus' ? 'Focus Time' : 'Break Time';
                        D.timerTitle.textContent = `Pomodoro: ${modeText}`;
                    }
                }
                
                // Ensure task input has the session goal if a session was paused
                if (state.sessionGoal) {
                    D.taskInput.value = state.sessionGoal;
                }

                // Initial render of the correct view
                switchPage(state.currentPage); 
                renderUI(); // Render the timer view specifics
                
                // Add handlers to global elements
                document.getElementById('start-pause-btn').onclick = startPauseHandler;
                document.getElementById('reset-btn').onclick = resetTimer;
                document.getElementById('pomodoro-btn').onclick = togglePomodoro;
                document.getElementById('fullscreen-btn').onclick = toggleFullscreenClock;
                document.getElementById('music-btn').onclick = toggleSongPlayback;

                // Create initial icons
                window.createLucideIcons();
            });
    </script>
</body>
</html>
